



<html class="scroll-smooth" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Nepal Mart - Nepal's Favorite Shopping App
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <style>
   :root {
      --primary-color: #e63946;
      --primary-light: #f8a5a5;
      --secondary-color: #f1faee;
      --dark-color: #1d3557;
      --light-color: #a8dadc;
      --accent-color: #457b9d;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --error-color: #e76f51;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f9fafb;
      color: #333;
      overflow-x: hidden;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Modal animations */
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-scaleIn {
      animation: scaleIn 0.3s ease forwards;
    }

    .animate-slideInUp {
      animation: slideInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Toast notification */
    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toastOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .toast {
      animation: toastIn 0.3s ease forwards;
    }

    .toast.hide {
      animation: toastOut 0.3s ease forwards;
    }

    /* Search suggestions */
    #searchSuggestions {
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 1rem 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: absolute;
      width: calc(100% - 2.5rem);
      left: 1.25rem;
      z-index: 50;
    }

    #searchSuggestions div {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #f3f4f6;
    }

    #searchSuggestions div:hover,
    #searchSuggestions div.active {
      background-color: var(--primary-light);
      color: var(--dark-color);
    }

    #searchSuggestions div:last-child {
      border-bottom: none;
    }

    #searchSuggestions div img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 4px;
    }

    /* Product card hover effect */
    .product-card {
      transition: all 0.3s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #c1121f;
    }

    /* Pulse animation for loading */
    @keyframes pulse {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Rating stars */
    .rating-stars {
      color: #fbbf24;
    }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(90deg, #e63946, #457b9d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Floating action button */
    .fab {
      position: fixed;
      right: 1.5rem;
      bottom: 5.5rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
        0 1px 3px rgba(0, 0, 0, 0.08);
      z-index: 40;
      transition: all 0.3s;
    }

    .fab:hover {
      transform: scale(1.1);
    }

    /* Badge */
    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    /* Loading spinner */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Skeleton loading */
    .skeleton {
      background-color: #e5e7eb;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .skeleton::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.5),
        transparent
      );
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Modal bottom slide up for login/signup */
    #loginModal .modal-content,
    #signupModal .modal-content {
      border-radius: 1.5rem 1.5rem 0 0;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(100%);
      animation-fill-mode: forwards;
    }

    #loginModal.show .modal-content,
    #signupModal.show .modal-content {
      animation: slideInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Search bar expanded popup */
    #searchBarExpanded {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      z-index: 60;
      padding: 1rem 1.25rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      max-height: 100vh;
      overflow-y: auto;
    }

    #searchBarExpanded.active {
      display: flex;
      animation: slideInDown 0.3s ease forwards;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #searchBarExpanded input {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      outline: none;
      margin-bottom: 1rem;
    }

    #searchBarExpanded .search-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    #searchBarExpanded .search-result-card {
      background: #f9fafb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      cursor: pointer;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      transition: box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    #searchBarExpanded .search-result-card:hover {
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
    }

    #searchBarExpanded .search-result-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    #searchBarExpanded .close-search {
      align-self: flex-end;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    /* Content sliding container */
    #contentWrapper {
      overflow-x: hidden;
      position: relative;
    }

    .content-section {
      transition: transform 0.4s ease;
      will-change: transform;
      min-height: 60vh;
    }

    /* Categories and services clickable styling */
    .category-card,
    .service-card {
      cursor: pointer;
      user-select: none;
    }

    /* Related products slider */
    .related-products-slider {
      display: flex;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 0.5rem;
      scroll-behavior: smooth;
    }

    .related-products-slider::-webkit-scrollbar {
      height: 6px;
    }

    .related-products-slider::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .related-products-slider::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }

    .related-products-slider::-webkit-scrollbar-thumb:hover {
      background: #c1121f;
    }

    .related-product-card {
      min-width: 140px;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
    }

    .related-product-card:hover {
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
    }

    .related-product-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* Payment modal radio styling */
    .payment-option input[type="radio"] {
      accent-color: var(--primary-color);
    }

    /* Scroll buttons for sliders */
    .scroll-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease;
      z-index: 10;
    }

    .scroll-btn:hover {
      background-color: var(--primary-light);
    }

    .scroll-btn.left {
      left: 8px;
    }

    .scroll-btn.right {
      right: 8px;
    }

    /* Accessibility focus */
    button:focus,
    [role="button"]:focus,
    [tabindex]:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Add to your existing CSS */

/* Expanded products view */
.expanded-products {
  animation: fadeIn 0.3s ease-out;
}

/* Carousel styles */
.carousel {
  position: relative;
  padding: 0 2rem;
}

.carousel-inner {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.carousel-inner::-webkit-scrollbar {
  display: none;
}

.carousel-item {
  transition: transform 0.3s ease;
}

.carousel-item:hover {
  transform: translateY(-5px);
}

/* Filter popup styles */
.filter-popup {
  width: 250px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.filter-popup input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  height: 16px;
  width: 16px;
  background: #3b82f6; /* Blue thumb */
  border-radius: 50%;
  cursor: pointer;
}

.filter-popup input[type="range"]::-moz-range-thumb {
  height: 16px;
  width: 16px;
  background: #3b82f6;
  border-radius: 50%;
  cursor: pointer;
}


.filter-popup input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: var(--primary-color);
  border-radius: 50%;
  cursor: pointer;
}

/* Payment method styles */
.payment-option {
  transition: all 0.2s ease;
}

.payment-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Category cards */
.category-card {
  transition: all 0.3s ease;
}

.category-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.subcategory {
  transition: all 0.2s ease;
}

.subcategory:hover {
  background-color: var(--primary-light) !important;
  color: var(--dark-color);
}


@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes scaleIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-5px); }
  40%, 80% { transform: translateX(5px); }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out forwards;
}

.animate-fadeOut {
  animation: fadeOut 0.3s ease-out forwards;
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out forwards;
}

.animate-pulse {
  animation: pulse 2s infinite;
}

.animate-bounce {
  animation: bounce 0.5s;
}

.animate-shake {
  animation: shake 0.5s;
}

.spinner {
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top: 2px solid white;
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
  display: inline-block;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

  </style>
 </head>
 <body class="relative">
  <!-- Toast Notification Container -->
  <div class="fixed top-4 right-4 z-50 space-y-2 w-full max-w-xs" id="toastContainer">
  </div>
  <!-- Floating Action Button (WhatsApp) -->
  <a aria-label="Chat with us on WhatsApp" class="fab bg-green-500 text-white" href="https://wa.me/9779800000000?text=Hi%20Nepal%20Mart%20Team,%20I%20need%20help%20with%20my%20order" target="_blank">
   <i class="fab fa-whatsapp text-2xl">
   </i>
  </a>
  <div class="max-w-full md:max-w-xl lg:max-w-4xl mx-auto pb-20">
   <!-- Header -->
   <header class="sticky top-0 z-40 bg-gradient-to-r from-red-600 via-red-700 to-red-800 text-white shadow-lg">
    <div class="flex justify-between items-center px-5 py-4 md:py-5 md:px-8 select-none">
     <div class="flex items-center space-x-3">
      <img alt="Nepal Mart logo, stylized NM letters in red and white" class="w-10 h-10 rounded-full object-cover border-2 border-white" loading="lazy" src="https://placehold.co/40x40/white/e63946/png?text=NM"/>
      <span class="text-2xl font-extrabold tracking-wide gradient-text">
       Nepal Mart
      </span>
     </div>
     <div class="flex items-center space-x-4">
      <div class="relative" id="notificationBtn">
       <i class="fas fa-bell text-xl cursor-pointer hover:text-primary-light transition-colors">
       </i>
       <span class="badge bg-yellow-500 text-white hidden" id="notificationBadge">
        3
       </span>
      </div>
      <div class="relative" id="profileDropdownWrapper">
       <div aria-expanded="false" aria-haspopup="true" aria-label="User profile menu" class="flex items-center space-x-2 cursor-pointer" id="profileIcon" role="button" tabindex="0">
        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-primary-color font-bold">
         <span id="profileInitial">
          ?
         </span>
        </div>
        <i class="fas fa-chevron-down text-xs transition-transform duration-200" id="profileChevron">
        </i>
       </div>
       <div aria-labelledby="profileIcon" class="hidden absolute right-0 mt-2 w-48 bg-white text-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none py-1 z-50" id="dropdownMenu" role="menu">
        <div class="dropdown-item px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center" id="loginBtn" role="menuitem" tabindex="0">
         <i class="fas fa-sign-in-alt mr-2 text-primary-color">
         </i>
         Login
        </div>
        <div class="dropdown-item px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center" id="signupBtn" role="menuitem" tabindex="0">
         <i class="fas fa-user-plus mr-2 text-primary-color">
         </i>
         Sign Up
        </div>
        <div class="dropdown-item px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center hidden" id="profileBtn" role="menuitem" tabindex="0">
         <i class="fas fa-user mr-2 text-primary-color">
         </i>
         Profile
        </div>
        <div class="dropdown-item px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center hidden" id="myOrdersBtn" role="menuitem" tabindex="0">
         <i class="fas fa-clipboard-list mr-2 text-primary-color">
         </i>
         My
                Orders
        </div>
        <div class="dropdown-item px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center hidden" id="logoutBtn" role="menuitem" tabindex="0">
         <i class="fas fa-sign-out-alt mr-2 text-primary-color">
         </i>
         Logout
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="px-5 pb-3">
     <button aria-label="Select location" class="flex items-center justify-center space-x-2 bg-white bg-opacity-20 rounded-full px-5 py-2 text-sm font-semibold hover:bg-opacity-30 transition select-none w-full text-left" id="locationBtn" type="button">
      <i class="fas fa-map-marker-alt">
      </i>
      <span class="flex-1 truncate" id="locationText">
       Select Location
      </span>
      <i class="fas fa-chevron-down text-xs">
      </i>
     </button>
    </div>
    <div class="relative mx-5 mb-5">
     <div aria-label="Search products" class="flex items-center bg-white rounded-full h-12 px-4 cursor-text shadow-md" id="searchBar" role="search" tabindex="0">
      <i class="fas fa-search text-gray-400">
      </i>
      <input aria-autocomplete="list" aria-controls="searchSuggestions" aria-expanded="false" aria-haspopup="listbox" autocomplete="off" class="flex-grow ml-3 text-gray-700 text-sm outline-none placeholder-gray-400" id="searchInput" placeholder="Search for products, brands and more..." tabindex="-1" type="text"/>
     </div>
     <div aria-label="Search suggestions" class="hidden" id="searchSuggestions" role="listbox">
     </div>
    </div>
   </header>
   <!-- Quick Categories -->
   <nav aria-label="Quick categories navigation" class="flex justify-around bg-white py-3 shadow-sm select-none sticky top-[72px] z-30">
    <div aria-current="page" class="quick-category flex flex-col items-center cursor-pointer px-2 py-1 rounded transition-colors duration-300 ease-in-out text-primary-color" data-section="home" role="link" tabindex="0">
     <i class="fas fa-home text-xl mb-1">
     </i>
     <span class="text-xs font-medium">
      Home
     </span>
    </div>
    <div class="quick-category flex flex-col items-center cursor-pointer px-2 py-1 rounded transition-colors duration-300 ease-in-out text-gray-600 hover:text-primary-color" data-section="foods" role="link" tabindex="0">
     <i class="fas fa-utensils text-xl mb-1">
     </i>
     <span class="text-xs font-medium">
      Foods
     </span>
    </div>
    <div class="quick-category flex flex-col items-center cursor-pointer px-2 py-1 rounded transition-colors duration-300 ease-in-out text-gray-600 hover:text-primary-color" data-section="grocery" role="link" tabindex="0">
     <i class="fas fa-shopping-basket text-xl mb-1">
     </i>
     <span class="text-xs font-medium">
      Grocery
     </span>
    </div>
    <div class="quick-category flex flex-col items-center cursor-pointer px-2 py-1 rounded transition-colors duration-300 ease-in-out text-gray-600 hover:text-primary-color" data-section="services" role="link" tabindex="0">
     <i class="fas fa-concierge-bell text-xl mb-1">
     </i>
     <span class="text-xs font-medium">
      Services
     </span>
    </div>
    <div class="quick-category flex flex-col items-center cursor-pointer px-2 py-1 rounded transition-colors duration-300 ease-in-out text-gray-600 hover:text-primary-color" data-section="orders" role="link" tabindex="0">
     <i class="fas fa-clipboard-list text-xl mb-1">
     </i>
     <span class="text-xs font-medium">
      Orders
     </span>
    </div>
   </nav>
   <!-- Content Wrapper for sliding -->
   <div class="relative" id="contentWrapper">
    <!-- Main Content Sections -->
    <main class="relative">
     <!-- Home Section -->
     <section aria-label="Home section" class="content-section fade-in block" id="home" tabindex="0">
      <!-- Hero Banner -->
      <div class="relative my-4 mx-4 rounded-xl overflow-hidden h-40 bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
       <div class="absolute inset-0 bg-black bg-opacity-30">
       </div>
       <div class="relative z-10 text-center text-white px-4">
        <h2 class="text-xl font-bold mb-1">
         Great Deals For You!
        </h2>
        <p class="text-sm mb-3">
         Up to 50% off on selected items
        </p>
        <button class="bg-white text-primary-color px-4 py-1 rounded-full text-sm font-medium hover:bg-opacity-90 transition" type="button">
         Shop Now
        </button>
       </div>
       
      </div>
      <!-- Categories Slider -->
      <div class="relative my-6">
       <div class="flex justify-between items-center px-4 mb-3">
        <h3 class="text-lg font-semibold text-dark-color">
         Shop by Categories
        </h3>
        <button class="text-primary-color text-sm font-medium hover:underline focus:outline-none view-all-btn" data-section="categories" type="button">
         View All
        </button>
       </div>
       <div aria-label="Categories slider" class="flex overflow-x-auto no-scrollbar gap-4 px-4 scroll-smooth" id="categoriesSlider" tabindex="0">
       </div>
       <button aria-label="Scroll categories left" class="scroll-btn left hidden" id="scrollLeft" type="button">
        <i class="fas fa-chevron-left text-primary-color">
        </i>
       </button>
       <button aria-label="Scroll categories right" class="scroll-btn right" id="scrollRight" type="button">
        <i class="fas fa-chevron-right text-primary-color">
        </i>
       </button>
      </div>
      <!-- Featured Products -->
      <section aria-label="Featured Products" class="products-section bg-white rounded-xl shadow-sm p-4 mb-6 mx-4">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         Featured Products
        </h3>
        <button aria-label="View all featured products" class="text-primary-color text-sm font-medium hover:underline focus:outline-none view-all-btn" data-section="featured" type="button">
         View All
        </button>
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="featuredProductsGrid">
       </div>
      </section>
      <!-- Deals of the Day -->
      <section aria-label="Deals of the Day" class="products-section bg-white rounded-xl shadow-sm p-4 mb-6 mx-4">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         <span class="text-primary-color">
          Deals of the Day
         </span>
         <span class="text-xs font-normal ml-2 text-gray-500">
          Ends in 12:34:56
         </span>
        </h3>
        <button aria-label="View all deals of the day" class="text-primary-color text-sm font-medium hover:underline focus:outline-none view-all-btn" data-section="deals" type="button">
         View All
        </button>
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="dealsProductsGrid">
       </div>
      </section>
      <!-- Discount Banner -->
      <div class="mx-4 mb-6 rounded-xl overflow-hidden">
       <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 p-4 text-white text-center">
        <h3 class="font-bold text-lg mb-1">
         Special Discount!
        </h3>
        <p class="text-sm mb-2">
         Get 15% off on your first order. Use code:
         <span class="font-bold">
          WELCOME15
         </span>
        </p>
        <button class="bg-white text-yellow-700 px-4 py-1 rounded-full text-sm font-medium hover:bg-opacity-90 transition" type="button">
         Apply Now
        </button>
       </div>
      </div>
      <!-- Recently Viewed -->
      <section aria-label="Recently Viewed Products" class="products-section bg-white rounded-xl shadow-sm p-4 mb-6 mx-4">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         Recently Viewed
        </h3>
        <button aria-label="View all recently viewed products" class="text-primary-color text-sm font-medium hover:underline focus:outline-none view-all-btn" data-section="recent" type="button">
         View All
        </button>
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="recentProductsGrid">
       </div>
      </section>
     </section>
     <!-- Foods Section -->
     <section aria-label="Foods section" class="content-section fade-in hidden" id="foods" tabindex="0">
      <div class="p-4" id="foodsContent">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         Food &amp; Beverages
        </h3>
       
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="foodsProductsGrid">
       </div>
      </div>
     </section>
     <!-- Grocery Section -->
     <section aria-label="Grocery section" class="content-section fade-in hidden" id="grocery" tabindex="0">
      <div class="p-4" id="groceryContent">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         Grocery &amp; Staples
        </h3>
      
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="groceryProductsGrid">
       </div>
      </div>
     </section>
     <!-- Services Section -->
     <section aria-label="Services section" class="content-section fade-in hidden" id="services" tabindex="0">
      <div class="p-4" id="servicesContent">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-dark-color">
         Services
        </h3>
       
       </div>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="servicesProductsGrid">
       </div>
      </div>
     </section>
     <!-- Orders Section -->
     <section aria-label="Orders section" class="content-section fade-in hidden" id="orders" tabindex="0">
      <div class="p-4 text-center text-gray-500" id="ordersContent">
       Please login and place orders to see your order history.
      </div>
     </section>
     <!-- Cart Section -->
     <section aria-label="Shopping cart section" class="content-section fade-in hidden" id="cart" tabindex="0">
      <div class="p-4" id="cartContent">
       Your cart is empty. Add products to see them here.
      </div>
     </section>
     <!-- Profile Section -->
     <section aria-label="User profile section" class="content-section fade-in hidden" id="profile" tabindex="0">
      <div class="p-4 text-center text-gray-500" id="profileContent">
       Please login to view your profile.
      </div>
     </section>
     <!-- Product Detail Section -->
     <section aria-label="Product detail section" class="content-section fade-in hidden" id="productDetail" tabindex="0">
      <div class="p-4" id="productDetailContent">
      </div>
     </section>
     <!-- Categories Section -->
     <section aria-label="Categories section" class="content-section fade-in hidden" id="categories" tabindex="0">
      <div class="p-4" id="categoriesContent">
       <h3 class="text-xl font-bold text-dark-color mb-4">
        All Categories
       </h3>
       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <!-- Bottom Navbar -->
  <nav aria-label="Bottom navigation" class="fixed bottom-0 left-0 right-0 bg-white flex justify-around py-3 shadow-inner z-50 select-none">
   <button aria-current="page" aria-label="Home" class="nav-item flex flex-col items-center text-primary-color focus:outline-none" data-section="home" type="button">
    <i class="fas fa-home text-xl mb-1">
    </i>
    <span class="text-xs font-medium">
     Home
    </span>
   </button>
   <button aria-label="Categories" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary-color focus:outline-none" data-section="categories" type="button">
    <i class="fas fa-list text-xl mb-1">
    </i>
    <span class="text-xs font-medium">
     Categories
    </span>
   </button>
   <button aria-label="Cart" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary-color focus:outline-none relative" data-section="cart" type="button">
    <i class="fas fa-shopping-cart text-xl mb-1">
    </i>
    <span class="text-xs font-medium">
     Cart
    </span>
    <span class="badge bg-primary-color text-white hidden" id="cartBadge">
     0
    </span>
   </button>
   <button aria-label="Orders" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary-color focus:outline-none" data-section="orders" type="button">
    <i class="fas fa-clipboard-list text-xl mb-1">
    </i>
    <span class="text-xs font-medium">
     Orders
    </span>
   </button>
   <button aria-label="Profile" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary-color focus:outline-none" data-section="profile" type="button">
    <i class="fas fa-user text-xl mb-1">
    </i>
    <span class="text-xs font-medium">
     Profile
    </span>
   </button>
  </nav>
  <!-- Location Modal -->
  <div aria-labelledby="locationModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="locationModal" role="dialog">
   <div class="modal-content bg-white rounded-xl w-11/12 max-w-md overflow-hidden animate-scaleIn" role="document">
    <header class="modal-header bg-primary-color text-white flex justify-between items-center p-4">
     <h3 class="text-lg font-semibold" id="locationModalTitle">
      Select Your Location
     </h3>
     <button aria-label="Close location modal" class="close-modal text-white text-2xl font-bold focus:outline-none" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-4">
     <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1" for="locationInput">
       Enter your location or pincode
      </label>
      <input aria-label="Enter your location or pincode" class="location-input w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-primary-color" id="locationInput" placeholder="e.g. Kathmandu or 44600" type="text"/>
     </div>
     <button aria-label="Detect my location" class="detect-location w-full flex items-center justify-center space-x-2 bg-light-color text-dark-color rounded-md py-3 mb-4 hover:bg-accent-color hover:text-white transition-colors focus:outline-none" id="detectLocationBtn" type="button">
      <i class="fas fa-location-arrow">
      </i>
      <span>
       Detect My Location
      </span>
     </button>
     <div class="mb-2 flex items-center justify-between">
      <span class="text-sm font-medium text-gray-700">
       Popular Locations
      </span>
      <button class="text-primary-color text-sm hover:underline focus:outline-none" id="useCurrentLocation" type="button">
       Use Current
      </button>
     </div>
     <div aria-label="Location suggestions" class="location-suggestions max-h-52 overflow-y-auto border border-gray-200 rounded-md" id="locationSuggestions" role="list">
      <div class="location-item px-4 py-3 cursor-pointer hover:bg-gray-100 flex items-center" role="listitem" tabindex="0">
       <i class="fas fa-map-marker-alt text-primary-color mr-3">
       </i>
       <div>
        <div class="font-medium">
         Kathmandu, 44600
        </div>
        <div class="text-xs text-gray-500">
         Bagmati Province
        </div>
       </div>
      </div>
      <div class="location-item px-4 py-3 cursor-pointer hover:bg-gray-100 flex items-center" role="listitem" tabindex="0">
       <i class="fas fa-map-marker-alt text-primary-color mr-3">
       </i>
       <div>
        <div class="font-medium">
         Pokhara, 33700
        </div>
        <div class="text-xs text-gray-500">
         Gandaki Province
        </div>
       </div>
      </div>
      <div class="location-item px-4 py-3 cursor-pointer hover:bg-gray-100 flex items-center" role="listitem" tabindex="0">
       <i class="fas fa-map-marker-alt text-primary-color mr-3">
       </i>
       <div>
        <div class="font-medium">
         Lalitpur, 44700
        </div>
        <div class="text-xs text-gray-500">
         Bagmati Province
        </div>
       </div>
      </div>
      <div class="location-item px-4 py-3 cursor-pointer hover:bg-gray-100 flex items-center" role="listitem" tabindex="0">
       <i class="fas fa-map-marker-alt text-primary-color mr-3">
       </i>
       <div>
        <div class="font-medium">
         Bhaktapur, 44800
        </div>
        <div class="text-xs text-gray-500">
         Bagmati Province
        </div>
       </div>
      </div>
      <div class="location-item px-4 py-3 cursor-pointer hover:bg-gray-100 flex items-center" role="listitem" tabindex="0">
       <i class="fas fa-map-marker-alt text-primary-color mr-3">
       </i>
       <div>
        <div class="font-medium">
         Biratnagar, 56613
        </div>
        <div class="text-xs text-gray-500">
         Province No. 1
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <!-- Login Modal (bottom slide up) -->
  <div aria-labelledby="loginModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end z-50 hidden" id="loginModal" role="dialog">
   <div class="modal-content bg-white w-full max-w-md overflow-hidden animate-slideInUp" role="document" tabindex="0">
    <header class="modal-header bg-primary-color text-white flex justify-between items-center p-4 rounded-t-xl">
     <h3 class="text-lg font-semibold" id="loginModalTitle">
      Login to Nepal Mart
     </h3>
     <button aria-label="Close login modal" class="close-modal text-white text-2xl font-bold focus:outline-none" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-4 flex flex-col space-y-4">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1" for="loginPhone">
       Phone Number
      </label>
      <div class="relative">
       <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <span class="text-gray-500">
         +977
        </span>
       </div>
       <input aria-label="Phone Number" class="location-input w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-primary-color pl-14" id="loginPhone" placeholder="98XXXXXXXX" type="tel"/>
      </div>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1" for="loginPassword">
       Password
      </label>
      <input aria-label="Password" class="location-input w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-primary-color" id="loginPassword" placeholder="Enter your password" type="password"/>
     </div>
     <div class="flex justify-between items-center">
      <div class="flex items-center">
       <input class="h-4 w-4 text-primary-color focus:ring-primary-color border-gray-300 rounded" id="rememberMe" type="checkbox"/>
       <label class="ml-2 block text-sm text-gray-700" for="rememberMe">
        Remember me
       </label>
      </div>
      <a class="text-sm text-primary-color hover:underline" href="#">
       Forgot password?
      </a>
     </div>
     <button aria-label="Login" class="checkout-btn w-full bg-primary-color text-white rounded-md py-3 text-lg font-semibold hover:bg-red-700 transition-colors focus:outline-none flex items-center justify-center" id="loginSubmit" type="button">
      <span id="loginSubmitText">
       Login
      </span>
      <div class="spinner ml-2 hidden" id="loginSpinner">
      </div>
     </button>
     <div class="relative my-4">
      <div class="absolute inset-0 flex items-center">
       <div class="w-full border-t border-gray-300">
       </div>
      </div>
      <div class="relative flex justify-center text-sm">
       <span class="px-2 bg-white text-gray-500">
        Or continue with
       </span>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-3">
      <button class="w-full bg-blue-600 text-white rounded-md py-2 text-sm font-medium hover:bg-blue-700 transition-colors flex items-center justify-center" type="button">
       <i class="fab fa-facebook-f mr-2">
       </i>
       Facebook
      </button>
      <button class="w-full bg-red-600 text-white rounded-md py-2 text-sm font-medium hover:bg-red-700 transition-colors flex items-center justify-center" type="button">
       <i class="fab fa-google mr-2">
       </i>
       Google
      </button>
     </div>
     <p class="text-center text-sm">
      Don't have an account?
      <a class="text-primary-color hover:underline focus:outline-none" href="#" id="showSignup">
       Sign up
      </a>
     </p>
    </div>
   </div>
  </div>
  <!-- Signup Modal (bottom slide up) -->
 <div aria-labelledby="signupModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end z-50 hidden" id="signupModal" role="dialog">
   <div class="modal-content bg-white w-full max-w-md overflow-hidden animate-slideInUp rounded-t-xl shadow-xl" role="document" tabindex="0">
    <header class="modal-header bg-gradient-to-r from-purple-600 to-blue-500 text-white flex justify-between items-center p-6 rounded-t-xl">
     <div class="flex items-center space-x-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
      </svg>
      <h3 class="text-xl font-bold" id="signupModalTitle">
        Join Our Community
      </h3>
     </div>
     <button aria-label="Close signup modal" class="close-modal text-white hover:text-gray-200 text-2xl font-bold focus:outline-none transition-colors" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-6 flex flex-col space-y-4">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center" for="signupName">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg>
       Full Name
      </label>
      <input aria-label="Full Name" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" id="signupName" placeholder="Enter your full name" type="text"/>
     </div>
     
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center" for="signupPhone">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
       </svg>
       Phone Number
      </label>
      <div class="relative">
       <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <span class="text-gray-500">
         +977
        </span>
       </div>
       <input aria-label="Phone Number" class="w-full border border-gray-300 rounded-lg px-4 py-3 pl-16 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" id="signupPhone" placeholder="98XXXXXXXX" type="tel"/>
      </div>
     </div>
     
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center" for="signupEmail">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
       </svg>
       Email (Optional)
      </label>
      <input aria-label="Email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" id="signupEmail" placeholder="Enter your email" type="email"/>
     </div>
     
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center" for="signupPassword">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
       </svg>
       Password
      </label>
      <input aria-label="Password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" id="signupPassword" placeholder="Create a password" type="password"/>
      <p class="text-xs text-gray-500 mt-1 flex items-center">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
       </svg>
       Minimum 8 characters with at least 1 number
      </p>
     </div>
     
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center" for="signupConfirmPassword">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
       </svg>
       Confirm Password
      </label>
      <input aria-label="Confirm Password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" id="signupConfirmPassword" placeholder="Confirm your password" type="password"/>
     </div>
     
     <div class="flex items-start">
      <input class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded mt-1" id="termsAgreement" type="checkbox"/>
      <label class="ml-2 block text-sm text-gray-700" for="termsAgreement">
       I agree to the
       <button class="text-purple-600 hover:underline font-medium terms-btn" type="button">
        Terms &amp; Conditions
       </button>
       and
       <button class="text-purple-600 hover:underline font-medium privacy-btn" type="button">
        Privacy Policy
       </button>
      </label>
     </div>
     
     <button aria-label="Sign Up" class="w-full bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-lg py-3 text-lg font-semibold hover:from-purple-700 hover:to-blue-600 transition-all focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 flex items-center justify-center shadow-md hover:shadow-lg" id="signupSubmit" type="button">
      <span id="signupSubmitText">
       Get Started
      </span>
      <div class="spinner ml-2 hidden" id="signupSpinner">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
     </button>
     
     <div class="relative my-4">
      <div class="absolute inset-0 flex items-center">
       <div class="w-full border-t border-gray-300">
       </div>
      </div>
      <div class="relative flex justify-center text-sm">
       <span class="px-2 bg-white text-gray-500">
        Or sign up with
       </span>
      </div>
     </div>
     
     <div class="grid grid-cols-3 gap-3">
      <button class="social-login-btn w-full bg-blue-600 text-white rounded-lg py-2.5 text-sm font-medium hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 shadow-sm" data-provider="facebook" type="button">
       <svg class="w-4 h-4" aria-hidden="true" fill="currentColor" viewBox="0 0 8 19">
         <path fill-rule="evenodd" d="M6.135 3H8V0H6.135a4.147 4.147 0 0 0-4.142 4.142V6H0v3h2v9.938h3V9h2.021l.592-3H5V3.591A.6.6 0 0 1 5.592 3h.543Z" clip-rule="evenodd"/>
       </svg>
       <span class="hidden sm:inline">Facebook</span>
      </button>
      <button class="social-login-btn w-full bg-red-600 text-white rounded-lg py-2.5 text-sm font-medium hover:bg-red-700 transition-colors flex items-center justify-center space-x-2 shadow-sm" data-provider="google" type="button">
       <svg class="w-4 h-4" aria-hidden="true" fill="currentColor" viewBox="0 0 18 19">
         <path fill-rule="evenodd" d="M8.842 18.083a8.8 8.8 0 0 1-8.65-8.948 8.841 8.841 0 0 1 8.8-8.652h.153a8.464 8.464 0 0 1 5.7 2.257l-2.193 2.038A5.27 5.27 0 0 0 9.09 3.4a5.882 5.882 0 0 0-.2 11.76h.124a5.091 5.091 0 0 0 5.248-4.057L14.3 11H9V8h8.34c.066.543.095 1.09.088 1.636-.086 5.053-3.463 8.449-8.4 8.449l-.186-.002Z" clip-rule="evenodd"/>
       </svg>
       <span class="hidden sm:inline">Google</span>
      </button>
      <button class="social-login-btn w-full bg-green-500 text-white rounded-lg py-2.5 text-sm font-medium hover:bg-green-600 transition-colors flex items-center justify-center space-x-2 shadow-sm" data-provider="whatsapp" type="button">
       <svg class="w-4 h-4" aria-hidden="true" fill="currentColor" viewBox="0 0 24 24">
         <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
       </svg>
       <span class="hidden sm:inline">WhatsApp</span>
      </button>
     </div>
     
     <p class="text-center text-sm text-gray-600">
      Already have an account?
      <button class="text-purple-600 hover:underline font-medium focus:outline-none ml-1" id="showLogin">
       Login here
      </button>
     </p>
    </div>
   </div>
  </div>

  <!-- Terms & Conditions Popup -->
  <div id="termsPopup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-purple-600">Terms & Conditions</h3>
        <button class="close-terms text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
      </div>
      <div class="space-y-4 text-sm text-gray-700">
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">1. Account Responsibility</h4>
          <p>You are responsible for maintaining the confidentiality of your account and password and for restricting access to your device.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">2. User Conduct</h4>
          <p>You agree not to use the service for any illegal purpose or in violation of any laws in your jurisdiction.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">3. Content Ownership</h4>
          <p>You retain ownership of any content you submit, but grant us a worldwide license to use, store, and display that content.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">4. Service Modifications</h4>
          <p>We reserve the right to modify or discontinue the service at any time without notice.</p>
        </div>
        <div>
          <h4 class="font-semibold text-purple-500">5. Termination</h4>
          <p>We may terminate or suspend your account immediately for any violation of these terms.</p>
        </div>
      </div>
      <button class="mt-6 w-full bg-purple-600 text-white rounded-lg py-2 px-4 hover:bg-purple-700 transition-colors close-terms">I Understand</button>
    </div>
  </div>

  <!-- Privacy Policy Popup -->
  <div id="privacyPopup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-purple-600">Privacy Policy</h3>
        <button class="close-privacy text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
      </div>
      <div class="space-y-4 text-sm text-gray-700">
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">1. Data Collection</h4>
          <p>We collect information you provide directly, including name, email, phone number, and usage data.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">2. Data Usage</h4>
          <p>Your data is used to provide services, communicate with you, and improve our offerings.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">3. Data Sharing</h4>
          <p>We don't sell your data but may share it with trusted service providers under confidentiality agreements.</p>
        </div>
        <div class="border-b pb-3">
          <h4 class="font-semibold text-purple-500">4. Security</h4>
          <p>We implement security measures to protect your data, but no system is 100% secure.</p>
        </div>
        <div>
          <h4 class="font-semibold text-purple-500">5. Your Rights</h4>
          <p>You may access, correct, or delete your personal information by contacting us.</p>
        </div>
      </div>
      <button class="mt-6 w-full bg-purple-600 text-white rounded-lg py-2 px-4 hover:bg-purple-700 transition-colors close-privacy">I Understand</button>
    </div>
  </div>
  <!-- Product Detail Modal -->
  <div aria-labelledby="productDetailModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="productDetailModal" role="dialog">
   <div class="modal-content bg-white rounded-xl w-11/12 max-w-md overflow-hidden animate-scaleIn max-h-[90vh] overflow-y-auto" role="document" tabindex="0">
    <header class="modal-header bg-white border-b border-gray-200 flex justify-between items-center p-4 sticky top-0 z-10">
     <h3 class="text-lg font-semibold text-dark-color" id="productDetailModalTitle">
      Product Details
     </h3>
     <button aria-label="Close product detail modal" class="close-modal text-gray-500 text-2xl font-bold hover:text-gray-700 focus:outline-none" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-4" id="productDetailModalContent">
     <!-- Product details will be loaded here -->
    </div>
   </div>
  </div>
  <!-- Order Tracking Modal -->
  <div aria-labelledby="orderTrackingModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="orderTrackingModal" role="dialog">
   <div class="modal-content bg-white rounded-xl w-11/12 max-w-md overflow-hidden animate-scaleIn" role="document" tabindex="0">
    <header class="modal-header bg-primary-color text-white flex justify-between items-center p-4">
     <h3 class="text-lg font-semibold" id="orderTrackingModalTitle">
      Track Your Order
     </h3>
     <button aria-label="Close order tracking modal" class="close-modal text-white text-2xl font-bold focus:outline-none" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-4" id="orderTrackingModalContent">
     <!-- Order tracking details will be loaded here -->
    </div>
   </div>
  </div>
  <!-- Payment Modal -->
  <div aria-labelledby="paymentModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden" id="paymentModal" role="dialog">
   <div class="modal-content bg-white rounded-xl w-11/12 max-w-md overflow-hidden animate-scaleIn" role="document" tabindex="0">
    <header class="modal-header bg-primary-color text-white flex justify-between items-center p-4">
     <h3 class="text-lg font-semibold" id="paymentModalTitle">
      Select Payment Method
     </h3>
     <button aria-label="Close payment modal" class="close-modal text-white text-2xl font-bold focus:outline-none" type="button">
      ×
     </button>
    </header>
    <div class="modal-body p-4" id="paymentModalContent">
     <div class="space-y-4">
      <div class="payment-option border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary-color transition">
       <div class="flex items-center">
        <input class="h-4 w-4 text-primary-color focus:ring-primary-color" id="cod" name="paymentMethod" type="radio"/>
        <label class="ml-3 block text-sm font-medium text-gray-700" for="cod">
         Cash on Delivery (COD)
        </label>
       </div>
       <p class="text-xs text-gray-500 mt-1">
        Pay when you receive your order
       </p>
      </div>
      <div class="payment-option border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary-color transition">
       <div class="flex items-center">
        <input class="h-4 w-4 text-primary-color focus:ring-primary-color" id="esewa" name="paymentMethod" type="radio"/>
        <label class="ml-3 block text-sm font-medium text-gray-700" for="esewa">
         eSewa
        </label>
       </div>
       <p class="text-xs text-gray-500 mt-1">
        Pay securely with your eSewa wallet
       </p>
      </div>
      <div class="payment-option border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary-color transition">
       <div class="flex items-center">
        <input class="h-4 w-4 text-primary-color focus:ring-primary-color" id="khalti" name="paymentMethod" type="radio"/>
        <label class="ml-3 block text-sm font-medium text-gray-700" for="khalti">
         Khalti
        </label>
       </div>
       <p class="text-xs text-gray-500 mt-1">
        Pay securely with your Khalti wallet
       </p>
      </div>
      <div class="payment-option border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary-color transition">
       <div class="flex items-center">
        <input class="h-4 w-4 text-primary-color focus:ring-primary-color" id="card" name="paymentMethod" type="radio"/>
        <label class="ml-3 block text-sm font-medium text-gray-700" for="card">
         Credit/Debit Card
        </label>
       </div>
       <p class="text-xs text-gray-500 mt-1">
        Pay with Visa, Mastercard, etc.
       </p>
      </div>
     </div>
     <button class="w-full mt-6 bg-primary-color text-white rounded-md py-3 text-lg font-semibold hover:bg-red-700 transition-colors focus:outline-none" id="proceedToPayBtn" type="button">
      Proceed to Pay
     </button>
    </div>
   </div>
  </div>
  <!-- Search Bar Expanded Popup -->
  <div aria-label="Search products" aria-modal="true" id="searchBarExpanded" role="dialog">
   <button aria-label="Close search" class="close-search" id="closeSearchExpanded" type="button">
    ×
   </button>
   <input aria-autocomplete="list" aria-controls="searchSuggestionsExpanded" aria-expanded="true" autocomplete="off" autofocus="" id="searchInputExpanded" placeholder="Search for products, brands and more..." type="text"/>
   <div class="search-results" id="searchSuggestionsExpanded" role="listbox">
   </div>
  </div>
  <script async="" defer="" src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&amp;libraries=places&amp;callback=initMap">
  </script>
  <script>


// View All functionality for different sections
function setupViewAllFunctionality() {
    // Handle all "View All" button clicks
    document.querySelectorAll('.view-all-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sectionType = this.dataset.section;
            
            switch(sectionType) {
                case 'featured':
                    showAllProducts('Featured Products', featuredProducts);
                    break;
                case 'deals':
                    showAllProducts('Deals of the Day', dealsProducts);
                    break;
                case 'recent':
                    showAllProducts('Recently Viewed', viewedProducts);
                    break;
                case 'categories':
                    showAllCategories();
                    break;
                default:
                    showAllProducts(sectionType, getAllProductsByCategory(sectionType));
            }
        });
    });
}

// Show all products in a dedicated view
function showAllProducts(title, products) {
    // Create overlay for all products view
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-white z-50 overflow-y-auto';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-modal', 'true');
    overlay.setAttribute('aria-label', `All ${title}`);
    
    overlay.innerHTML = `
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center shadow-sm z-20">
            <button class="back-button mr-3 text-gray-600 hover:text-primary-color transition-colors text-xl" 
                    type="button" aria-label="Back to previous view">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="text-xl font-bold flex-1">${title}</h1>
            <button class="close-view-all text-gray-600 hover:text-primary-color transition-colors text-xl" 
                    type="button" aria-label="Close view all">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-gray-500">${products.length} products</span>
                <div class="flex items-center space-x-2">
                    <button class="filter-btn text-primary-color text-sm font-medium hover:underline focus:outline-none flex items-center" 
                            type="button" aria-label="Filter products">
                        <i class="fas fa-filter mr-1"></i> Filter
                    </button>
                    <button class="sort-btn text-primary-color text-sm font-medium hover:underline focus:outline-none flex items-center" 
                            type="button" aria-label="Sort products">
                        <i class="fas fa-sort mr-1"></i> Sort
                    </button>
                </div>
            </div>
            
            <div class="products-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                ${products.map(product => createProductCard(product)).join('')}
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Add event listeners
    overlay.querySelector('.back-button').addEventListener('click', () => {
        overlay.remove();
    });
    
    overlay.querySelector('.close-view-all').addEventListener('click', () => {
        overlay.remove();
    });
    
    // Add click handlers to product cards
    overlay.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', () => {
            const productId = card.dataset.productId;
            overlay.remove();
            viewProductDetail(productId);
        });
    });
    
    // Filter functionality
    overlay.querySelector('.filter-btn').addEventListener('click', () => {
        showFilterModal(products, overlay.querySelector('.products-grid'));
    });
    
    // Sort functionality
    overlay.querySelector('.sort-btn').addEventListener('click', () => {
        showSortOptions(products, overlay.querySelector('.products-grid'));
    });
}

// Show all categories in an expanded view
function showAllCategories() {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-white z-50 overflow-y-auto';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-modal', 'true');
    overlay.setAttribute('aria-label', 'All Categories');
    
    overlay.innerHTML = `
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center shadow-sm z-20">
            <button class="back-button mr-3 text-gray-600 hover:text-primary-color transition-colors text-xl" 
                    type="button" aria-label="Back to previous view">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="text-xl font-bold flex-1">All Categories</h1>
            <button class="close-view-all text-gray-600 hover:text-primary-color transition-colors text-xl" 
                    type="button" aria-label="Close categories view">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-4">
            <div class="categories-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                ${categories.map(category => `
                    <div class="category-card bg-white rounded-xl shadow-sm p-4 cursor-pointer hover:shadow-md transition flex flex-col items-center text-center" 
                         data-category-id="${category.id}" role="button" tabindex="0" aria-label="Browse ${category.name} category">
                        <div class="w-16 h-16 ${category.color} rounded-full flex items-center justify-center mb-3">
                            <i class="${category.icon} text-xl"></i>
                        </div>
                        <h3 class="text-sm font-semibold mb-1">${category.name}</h3>
                        <p class="text-xs text-gray-500">${category.subcategories.length} subcategories</p>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Add event listeners
    overlay.querySelector('.back-button').addEventListener('click', () => {
        overlay.remove();
    });
    
    overlay.querySelector('.close-view-all').addEventListener('click', () => {
        overlay.remove();
    });
    
    // Add click handlers to category cards
    overlay.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
            const categoryId = card.dataset.categoryId;
            overlay.remove();
            navigateToCategory(categoryId);
        });
        
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const categoryId = card.dataset.categoryId;
                overlay.remove();
                navigateToCategory(categoryId);
            }
        });
    });
}

// Helper function to create product card HTML
function createProductCard(product) {
    const fullStars = Math.floor(product.rating);
    const hasHalfStar = product.rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    let starsHtml = "";
    for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="fas fa-star"></i>';
    }
    if (hasHalfStar) {
        starsHtml += '<i class="fas fa-star-half-alt"></i>';
    }
    for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="far fa-star"></i>';
    }

    return `
        <div class="product-card bg-white rounded-xl shadow-sm cursor-pointer flex flex-col overflow-hidden hover:shadow-md transition-all relative" 
             data-product-id="${product.id}" role="button" tabindex="0" aria-label="View details of ${product.name}">
            <div class="relative">
                <img src="${product.img}" alt="${product.name}" class="w-full h-40 object-contain bg-gray-100 p-4" loading="lazy" />
                ${product.discount ? `
                    <span class="absolute top-2 left-2 bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
                        ${product.discount}% OFF
                    </span>
                ` : ''}
            </div>
            <div class="p-3 flex flex-col flex-grow">
                <h4 class="text-sm mb-1 line-clamp-2 flex-grow">${product.name}</h4>
                <div class="flex items-center mb-1">
                    <div class="rating-stars text-xs mr-1">${starsHtml}</div>
                    <span class="text-xs text-gray-500">(${product.reviews})</span>
                </div>
                <div class="flex items-center mb-2">
                    <p class="product-price font-bold text-primary-color mr-2">${formatPrice(product.price)}</p>
                    ${product.originalPrice ? `
                        <p class="product-original-price text-xs text-gray-500 line-through">${formatPrice(product.originalPrice)}</p>
                    ` : ''}
                </div>
                ${product.delivery.includes("Free") ? `
                    <p class="text-xs text-success-color mb-2">
                        <i class="fas fa-truck mr-1"></i> ${product.delivery}
                    </p>
                ` : `
                    <p class="text-xs text-gray-500 mb-2">
                        <i class="fas fa-truck mr-1"></i> ${product.delivery}
                    </p>
                `}
            </div>
        </div>
    `;
}

// Get all products by category
function getAllProductsByCategory(category) {
    return [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
    ].filter(p => p.category === category);
}

// Filter modal for products
function showFilterModal(products, container) {
    // Implementation of filter modal (similar to previous filter implementation)
    // This would show price range, availability, etc.
    showToast('Filter functionality would open here', 'info');
}

// Sort options for products
function showSortOptions(products, container) {
    // Implementation of sort options
    showToast('Sort options would open here', 'info');
}

// Initialize the view all functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupViewAllFunctionality();
});

// Add these styles to your CSS for the view all overlay
const viewAllStyles = `
.fixed.inset-0.bg-white {
    animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.products-grid, .categories-grid {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}
`;

// Inject styles
const styleElement = document.createElement('style');
styleElement.textContent = viewAllStyles;
document.head.appendChild(styleElement);


// Filter Modal Functionality
function setupFilterSystem() {
    // Create filter modal HTML
    const filterModalHTML = `
        <div id="filterModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="filter-popup bg-white rounded-xl w-11/12 max-w-sm overflow-hidden animate-scaleIn">
                <header class="modal-header bg-gradient-to-r from-blue-500 to-purple-600 text-white flex justify-between items-center p-4">
                    <h3 class="text-lg font-semibold">Filter Products</h3>
                    <button aria-label="Close filter modal" class="close-filter text-white text-2xl font-bold focus:outline-none hover:text-gray-200 transition-colors" type="button">
                        ×
                    </button>
                </header>
                
                <div class="modal-body p-4 max-h-96 overflow-y-auto">
                    <!-- Price Range -->
                    <div class="filter-section mb-6">
                        <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-tag mr-2 text-blue-500"></i> Price Range
                        </h4>
                        
                        <div class="price-inputs flex justify-between items-center mb-3">
                            <div class="price-input">
                                <label class="text-xs text-gray-600 mb-1 block">Min Price</label>
                                <input type="number" id="minPrice" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="0" min="0">
                            </div>
                            <span class="text-gray-400 mx-2">-</span>
                            <div class="price-input">
                                <label class="text-xs text-gray-600 mb-1 block">Max Price</label>
                                <input type="number" id="maxPrice" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="10000" min="0">
                            </div>
                        </div>
                        
                        <div class="price-slider mb-2">
                            <input type="range" min="0" max="10000" value="0" class="w-full" id="priceRangeMin">
                            <input type="range" min="0" max="10000" value="10000" class="w-full" id="priceRangeMax">
                        </div>
                        
                        <div class="price-display text-center">
                            <span class="text-sm text-primary-color font-medium" id="priceRangeDisplay">Rs. 0 - Rs. 10,000</span>
                        </div>
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="filter-section mb-6">
                        <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-sort-amount-down mr-2 text-purple-500"></i> Sort By
                        </h4>
                        
                        <div class="sort-options space-y-2">
                            <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="radio" name="sortOption" value="featured" class="h-4 w-4 text-primary-color focus:ring-primary-color" checked>
                                <span class="ml-3 text-sm text-gray-700">Featured</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="radio" name="sortOption" value="priceLowHigh" class="h-4 w-4 text-primary-color focus:ring-primary-color">
                                <span class="ml-3 text-sm text-gray-700">Price: Low to High</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="radio" name="sortOption" value="priceHighLow" class="h-4 w-4 text-primary-color focus:ring-primary-color">
                                <span class="ml-3 text-sm text-gray-700">Price: High to Low</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="radio" name="sortOption" value="newest" class="h-4 w-4 text-primary-color focus:ring-primary-color">
                                <span class="ml-3 text-sm text-gray-700">Newest First</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="radio" name="sortOption" value="rating" class="h-4 w-4 text-primary-color focus:ring-primary-color">
                                <span class="ml-3 text-sm text-gray-700">Highest Rated</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Availability -->
                    <div class="filter-section mb-6">
                        <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-check-circle mr-2 text-green-500"></i> Availability
                        </h4>
                        
                        <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" id="inStockOnly" class="h-4 w-4 text-primary-color focus:ring-primary-color">
                            <span class="ml-3 text-sm text-gray-700">In Stock Only</span>
                        </label>
                    </div>
                </div>
                
                <footer class="modal-footer p-4 border-t border-gray-200 flex justify-between">
                    <button id="resetFilters" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 focus:outline-none flex items-center">
                        <i class="fas fa-redo mr-2"></i> Reset
                    </button>
                    <div class="flex gap-3">
                        <button id="cancelFilters" class="px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none">
                            Cancel
                        </button>
                        <button id="applyFilters" class="px-4 py-2 text-sm font-medium text-white bg-primary-color rounded-md hover:bg-red-700 focus:outline-none transition-colors">
                            Apply Filters
                        </button>
                    </div>
                </footer>
            </div>
        </div>
    `;
    
    // Add filter modal to body
    document.body.insertAdjacentHTML('beforeend', filterModalHTML);
    
    // Get filter elements
    const filterModal = document.getElementById('filterModal');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const closeFilterBtn = document.querySelector('.close-filter');
    const cancelFiltersBtn = document.getElementById('cancelFilters');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const minPriceInput = document.getElementById('minPrice');
    const maxPriceInput = document.getElementById('maxPrice');
    const priceRangeMin = document.getElementById('priceRangeMin');
    const priceRangeMax = document.getElementById('priceRangeMax');
    const priceRangeDisplay = document.getElementById('priceRangeDisplay');
    const inStockOnly = document.getElementById('inStockOnly');
    
    // Auto-dismiss timer
    let autoDismissTimer;
    
    // Initialize price range slider
    function initPriceRange() {
        // Set initial values
        minPriceInput.value = 0;
        maxPriceInput.value = 10000;
        
        // Update display
        updatePriceDisplay();
        
        // Connect range inputs to number inputs
        priceRangeMin.addEventListener('input', () => {
            minPriceInput.value = priceRangeMin.value;
            updatePriceDisplay();
        });
        
        priceRangeMax.addEventListener('input', () => {
            maxPriceInput.value = priceRangeMax.value;
            updatePriceDisplay();
        });
        
        minPriceInput.addEventListener('input', () => {
            priceRangeMin.value = minPriceInput.value;
            updatePriceDisplay();
        });
        
        maxPriceInput.addEventListener('input', () => {
            priceRangeMax.value = maxPriceInput.value;
            updatePriceDisplay();
        });
    }
    
    // Update price range display
    function updatePriceDisplay() {
        const min = parseInt(minPriceInput.value) || 0;
        const max = parseInt(maxPriceInput.value) || 10000;
        priceRangeDisplay.textContent = `Rs. ${min.toLocaleString()} - Rs. ${max.toLocaleString()}`;
    }
    
    // Show filter modal
    function showFilterModal() {
        filterModal.classList.remove('hidden');
        
        // Start auto-dismiss timer (10 seconds)
        resetAutoDismissTimer();
        
        // Add event listeners to reset timer on interaction
        filterModal.addEventListener('mousemove', resetAutoDismissTimer);
        filterModal.addEventListener('keypress', resetAutoDismissTimer);
    }
    
    // Hide filter modal
    function hideFilterModal() {
        filterModal.classList.add('hidden');
        
        // Clear auto-dismiss timer
        clearTimeout(autoDismissTimer);
        
        // Remove event listeners
        filterModal.removeEventListener('mousemove', resetAutoDismissTimer);
        filterModal.removeEventListener('keypress', resetAutoDismissTimer);
    }
    
    // Reset auto-dismiss timer
    function resetAutoDismissTimer() {
        clearTimeout(autoDismissTimer);
        autoDismissTimer = setTimeout(() => {
            hideFilterModal();
            showToast('Filters applied automatically', 'info');
            applyFilters();
        }, 10000); // 10 seconds
    }
    
    // Apply filters
    function applyFilters() {
        const minPrice = parseInt(minPriceInput.value) || 0;
        const maxPrice = parseInt(maxPriceInput.value) || 10000;
        const sortOption = document.querySelector('input[name="sortOption"]:checked').value;
        const onlyInStock = inStockOnly.checked;
        
        // Get current section
        const currentSection = document.querySelector('.content-section:not(.hidden)');
        const productGrid = currentSection.querySelector('.grid');
        
        if (!productGrid) {
            hideFilterModal();
            return;
        }
        
        // Get all products in current section
        const productCards = Array.from(productGrid.querySelectorAll('.product-card'));
        
        // Filter by price and stock
        const filteredProducts = productCards.filter(card => {
            const priceText = card.querySelector('.product-price').textContent;
            const price = parseInt(priceText.replace(/[^\d]/g, ''));
            
            // Check price range
            const inPriceRange = price >= minPrice && price <= maxPrice;
            
            // Check stock availability (if enabled)
            let inStock = true;
            if (onlyInStock) {
                const stockElement = card.querySelector('.text-success-color');
                inStock = stockElement && stockElement.textContent.includes('In Stock');
            }
            
            return inPriceRange && inStock;
        });
        
        // Sort products
        filteredProducts.sort((a, b) => {
            const priceA = parseInt(a.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
            const priceB = parseInt(b.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
            const ratingA = parseFloat(a.querySelector('.rating-stars').dataset.rating || 0);
            const ratingB = parseFloat(b.querySelector('.rating-stars').dataset.rating || 0);
            
            switch(sortOption) {
                case 'priceLowHigh':
                    return priceA - priceB;
                case 'priceHighLow':
                    return priceB - priceA;
                case 'rating':
                    return ratingB - ratingA;
                case 'newest':
                    // For demo purposes, we'll sort by a random "newness" attribute
                    return Math.random() - 0.5;
                default:
                    return 0; // Featured - no sorting
            }
        });
        
        // Re-render filtered products
        productGrid.innerHTML = '';
        filteredProducts.forEach(product => {
            productGrid.appendChild(product);
        });
        
        // Show results count
        const sectionTitle = currentSection.querySelector('h3');
        if (sectionTitle) {
            const resultsCount = document.createElement('span');
            resultsCount.className = 'text-sm font-normal text-gray-500 ml-2';
            resultsCount.textContent = `(${filteredProducts.length} results)`;
            
            // Remove existing count if any
            const existingCount = sectionTitle.querySelector('.results-count');
            if (existingCount) {
                existingCount.remove();
            }
            
            resultsCount.className = 'results-count text-sm font-normal text-gray-500 ml-2';
            sectionTitle.appendChild(resultsCount);
        }
        
        hideFilterModal();
        showToast(`Filters applied: ${filteredProducts.length} products found`, 'success');
    }
    
    // Reset filters
    function resetFilters() {
        minPriceInput.value = 0;
        maxPriceInput.value = 10000;
        priceRangeMin.value = 0;
        priceRangeMax.value = 10000;
        document.querySelector('input[name="sortOption"][value="featured"]').checked = true;
        inStockOnly.checked = false;
        updatePriceDisplay();
        
        showToast('Filters reset', 'info');
    }
    
    // Initialize event listeners
    function initFilterEvents() {
        // Add filter buttons to all sections
        document.querySelectorAll('.products-section, #foodsContent, #groceryContent, #servicesContent').forEach(section => {
            const heading = section.querySelector('h3');
            if (heading && !heading.nextElementSibling?.classList?.contains('filter-btn')) {
                const filterBtn = document.createElement('button');
                filterBtn.className = 'filter-btn text-primary-color text-sm font-medium hover:underline focus:outline-none flex items-center';
                filterBtn.innerHTML = '<i class="fas fa-filter mr-1"></i> Filter';
                filterBtn.addEventListener('click', showFilterModal);
                heading.parentNode.insertBefore(filterBtn, heading.nextSibling);
            }
        });
        
        // Existing filter buttons
        filterButtons.forEach(btn => {
            btn.addEventListener('click', showFilterModal);
        });
        
        // Modal buttons
        closeFilterBtn.addEventListener('click', hideFilterModal);
        cancelFiltersBtn.addEventListener('click', hideFilterModal);
        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);
        
        // Close modal on outside click
        filterModal.addEventListener('click', (e) => {
            if (e.target === filterModal) {
                hideFilterModal();
            }
        });
    }
    
    // Initialize everything
    initPriceRange();
    initFilterEvents();
}

// Add CSS for filter modal (dynamically inject)
const filterStyles = `
.filter-popup {
    animation: scaleIn 0.3s ease forwards;
}

.filter-popup .price-slider {
    position: relative;
    height: 5px;
    background: #ddd;
    border-radius: 5px;
    margin: 20px 0;
}

.filter-popup .price-slider input[type="range"] {
    position: absolute;
    width: 100%;
    height: 5px;
    background: none;
    pointer-events: none;
    -webkit-appearance: none;
}

.filter-popup .price-slider input[type="range"]::-webkit-slider-thumb {
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: var(--primary-color);
    pointer-events: auto;
    -webkit-appearance: none;
    cursor: grab;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.filter-popup .price-slider input[type="range"]::-webkit-slider-thumb:active {
    cursor: grabbing;
    transform: scale(1.2);
}

.filter-section {
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 1rem;
}

.filter-section:last-child {
    border-bottom: none;
}

/* Animation for auto-dismiss warning */
@keyframes pulseWarning {
    0%, 100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
}

.auto-dismiss-warning {
    animation: pulseWarning 2s infinite;
}
`;

// Inject styles
const styleSheet = document.createElement('style');
styleSheet.textContent = filterStyles;
document.head.appendChild(styleSheet);

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', setupFilterSystem);
















// Enhanced product detail function with multiple photos
function renderProductDetail(product) {
  // Add to viewed products if not already there
  if (!viewedProducts.some((p) => p.id === product.id)) {
    viewedProducts.unshift(product);
    if (viewedProducts.length > 6) viewedProducts.pop();
    updateRecentProducts();
  }

  // Generate multiple product photos (in a real app, these would come from the product data)
  const productPhotos = [
    product.img, // Main image
    "https://placehold.co/300x300/EFEFEF/999999/png?text=Product+Angle",
    "https://placehold.co/300x300/EFEFEF/999999/png?text=Close+Up+View",
    "https://placehold.co/300x300/EFEFEF/999999/png?text=Different+Color"
  ];

  // Rating stars
  const fullStars = Math.floor(product.rating);
  const hasHalfStar = product.rating % 1 >= 0.5;
  const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

  let starsHtml = "";
  for (let i = 0; i < fullStars; i++) {
    starsHtml += '<i class="fas fa-star"></i>';
  }
  if (hasHalfStar) {
    starsHtml += '<i class="fas fa-star-half-alt"></i>';
  }
  for (let i = 0; i < emptyStars; i++) {
    starsHtml += '<i class="far fa-star"></i>';
  }

  // Features list
  const featuresHtml = product.features
    .map(
      (f) => `
      <li class="flex items-start">
        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
        <span>${f}</span>
      </li>
    `
    )
    .join("");

  // Related products (same category, excluding current)
  const relatedProducts = [
    ...featuredProducts,
    ...dealsProducts,
    ...foodsProducts,
    ...groceryProducts,
    ...servicesProducts,
  ].filter((p) => p.category === product.category && p.id !== product.id);

  // Generate thumbnail HTML with active state for the first image
  const thumbnailsHtml = productPhotos.map((photo, index) => `
    <div class="thumbnail w-16 h-16 bg-gray-100 rounded border-2 ${
      index === 0 ? 'border-primary-color' : 'border-gray-200'
    } flex-shrink-0 cursor-pointer transition-all duration-200 hover:border-primary-color" 
        data-photo-index="${index}">
      <img src="${photo}" alt="${product.name} view ${index + 1}" 
           class="w-full h-full object-contain" loading="lazy" />
    </div>
  `).join('');

  // Generate dots indicator HTML
  const dotsHtml = productPhotos.map((_, index) => `
    <button class="dot w-2 h-2 rounded-full mx-1 focus:outline-none ${
      index === 0 ? 'bg-primary-color' : 'bg-gray-300'
    }" data-photo-index="${index}" aria-label="View product image ${index + 1}"></button>
  `).join('');

  productDetailContent.innerHTML = `
    <div class="product-images mb-4">
      <div class="main-image bg-gray-100 rounded-lg overflow-hidden mb-2 relative">
        <img src="${productPhotos[0]}" alt="${product.name}" 
             class="w-full h-64 object-contain transition-opacity duration-300" 
             id="mainProductImage" loading="lazy" />
        
        ${product.discount ? `
          <span class="absolute top-2 left-2 bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
            ${product.discount}% OFF
          </span>
        ` : ''}
        
        <!-- Zoom button -->
        <button class="absolute bottom-2 right-2 bg-white rounded-full p-2 shadow-md hover:bg-gray-100 transition-colors focus:outline-none" 
                id="zoomImageBtn" aria-label="Zoom image">
          <i class="fas fa-search-plus text-gray-600"></i>
        </button>
      </div>
      
      <div class="thumbnail-images flex gap-2 overflow-x-auto pb-2 justify-center">
        ${thumbnailsHtml}
      </div>
      
      <!-- Dots indicator -->
      <div class="dots-indicator flex justify-center mt-2">
        ${dotsHtml}
      </div>
    </div>

    <div class="product-info mb-6">
      <h1 class="text-xl font-bold text-dark-color mb-2">${product.name}</h1>
      <div class="flex items-center mb-3">
        <div class="rating-stars text-sm mr-2">${starsHtml}</div>
        <span class="text-sm text-gray-500 mr-3">${product.rating} (${product.reviews} reviews)</span>
        <span class="text-sm text-success-color">
          <i class="fas fa-check-circle mr-1"></i> ${
            product.inStock ? "In Stock" : "Out of Stock"
          }
        </span>
      </div>

      <div class="price-section bg-gray-50 p-3 rounded-lg mb-4">
        ${
          product.originalPrice
            ? `<div class="text-xs text-gray-500 line-through mb-1">${formatPrice(
                product.originalPrice
              )}</div>`
            : ""
        }
        <div class="flex items-center">
          <div class="text-2xl font-bold text-primary-color mr-3">${formatPrice(
            product.price
          )}</div>
          ${
            product.discount
              ? `<span class="bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
              Save ${product.discount}%
            </span>`
              : ""
          }
        </div>
        ${
          product.delivery.includes("Free")
            ? `<div class="text-sm text-success-color mt-2">
              <i class="fas fa-truck mr-1"></i> ${product.delivery}
            </div>`
            : `<div class="text-sm text-gray-600 mt-2">
              <i class="fas fa-truck mr-1"></i> ${product.delivery}
            </div>`
        }
      </div>

      <div class="seller-info flex items-center mb-4 p-3 bg-gray-50 rounded-lg">
        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
          <i class="fas fa-store text-gray-500"></i>
        </div>
        <div>
          <div class="text-sm font-medium">Sold by ${product.seller}</div>
          <div class="text-xs text-gray-500">${product.lastBought}</div>
        </div>
      </div>

      <div class="product-actions flex gap-3 mb-6">
        <button class="add-to-cart flex-1 bg-light-color text-dark-color rounded-lg py-3 text-sm font-medium hover:bg-accent-color hover:text-white transition-colors focus:outline-none">
          <i class="fas fa-cart-plus mr-2"></i> Add to Cart
        </button>
        <button class="buy-now flex-1 bg-primary-color text-white rounded-lg py-3 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none">
          Buy Now
        </button>
      </div>
    </div>

    <div class="product-details mb-6">
      <h2 class="text-lg font-bold text-dark-color mb-3">Product Details</h2>
      <p class="text-gray-700 mb-4">${product.description}</p>

      <h3 class="text-md font-semibold text-dark-color mb-2">Features</h3>
      <ul class="features-list space-y-2 mb-4">
        ${featuresHtml}
      </ul>
    </div>

    <div class="reviews-section">
      <h2 class="text-lg font-bold text-dark-color mb-3">Customer Reviews</h2>
      <div class="review bg-gray-50 p-3 rounded-lg mb-3">
        <div class="flex items-center mb-2">
          <div class="w-8 h-8 rounded-full bg-gray-300 mr-2"></div>
          <div>
            <div class="text-sm font-medium">Ramesh Shrestha</div>
            <div class="rating-stars text-xs">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star-half-alt"></i>
            </div>
          </div>
        </div>
        <p class="text-sm text-gray-700">
          Great product! Works perfectly as described. Delivery was fast too.
        </p>
        <div class="text-xs text-gray-500 mt-1">Reviewed on 12 May 2023</div>
      </div>

      <div class="review bg-gray-50 p-3 rounded-lg">
        <div class="flex items-center mb-2">
          <div class="w-8 h-8 rounded-full bg-gray-300 mr-2"></div>
          <div>
            <div class="text-sm font-medium">Sita Gurung</div>
            <div class="rating-stars text-xs">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="far fa-star"></i>
            </div>
          </div>
        </div>
        <p class="text-sm text-gray-700">
          Good quality but delivery took longer than expected.
        </p>
        <div class="text-xs text-gray-500 mt-1">Reviewed on 5 May 2023</div>
      </div>

      <button
        class="w-full mt-4 text-primary-color text-sm font-medium hover:underline focus:outline-none"
        type="button"
      >
        View All Reviews
      </button>
    </div>

    <div class="related-products mt-8">
      <h3 class="text-lg font-semibold mb-3">Related Products</h3>
      <div class="related-products-slider" tabindex="0" aria-label="Related products slider">
        ${relatedProducts
          .map(
            (p) => `
            <div class="related-product-card" role="button" tabindex="0" aria-label="View details of ${p.name}" data-product-id="${p.id}">
              <img src="${p.img}" alt="${p.name}" loading="lazy" />
              <div class="text-xs font-medium text-center">${p.name}</div>
              <div class="text-xs text-primary-color font-semibold">${formatPrice(p.price)}</div>
            </div>
          `
          )
          .join("")}
      </div>
    </div>
  `;

  // Add event listeners for image switching
  const mainImage = document.getElementById('mainProductImage');
  const thumbnails = productDetailContent.querySelectorAll('.thumbnail');
  const dots = productDetailContent.querySelectorAll('.dot');
  
  // Function to switch the main image
  function switchImage(index) {
    // Fade out current image
    mainImage.style.opacity = '0';
    
    setTimeout(() => {
      // Change image source
      mainImage.src = productPhotos[index];
      mainImage.alt = `${product.name} view ${index + 1}`;
      
      // Fade in new image
      mainImage.style.opacity = '1';
      
      // Update active states
      thumbnails.forEach((thumb, i) => {
        if (i === index) {
          thumb.classList.remove('border-gray-200');
          thumb.classList.add('border-primary-color');
        } else {
          thumb.classList.remove('border-primary-color');
          thumb.classList.add('border-gray-200');
        }
      });
      
      // Update dots
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.remove('bg-gray-300');
          dot.classList.add('bg-primary-color');
        } else {
          dot.classList.remove('bg-primary-color');
          dot.classList.add('bg-gray-300');
        }
      });
    }, 150);
  }
  
  // Add click events to thumbnails
  thumbnails.forEach((thumbnail, index) => {
    thumbnail.addEventListener('click', () => {
      switchImage(index);
    });
  });
  
  // Add click events to dots
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      switchImage(index);
    });
  });
  
  // Add keyboard navigation for dots
  dots.forEach((dot, index) => {
    dot.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        switchImage(index);
      }
    });
  });

  // Add zoom functionality
  const zoomBtn = document.getElementById('zoomImageBtn');
  zoomBtn.addEventListener('click', () => {
    // Create modal for zoomed image
    const zoomModal = document.createElement('div');
    zoomModal.className = 'fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50';
    zoomModal.innerHTML = `
      <div class="relative max-w-4xl w-full h-full flex justify-center items-center p-4">
        <button class="absolute top-4 right-4 text-white text-3xl font-bold focus:outline-none z-10 hover:text-gray-300 transition-colors" 
                aria-label="Close zoom view">
          ×
        </button>
        <img src="${mainImage.src}" alt="${mainImage.alt}" 
             class="max-w-full max-h-full object-contain" />
      </div>
    `;
    
    document.body.appendChild(zoomModal);
    
    // Close modal on button click
    zoomModal.querySelector('button').addEventListener('click', () => {
      zoomModal.remove();
    });
    
    // Close modal on outside click
    zoomModal.addEventListener('click', (e) => {
      if (e.target === zoomModal) {
        zoomModal.remove();
      }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function closeOnEscape(e) {
      if (e.key === 'Escape') {
        zoomModal.remove();
        document.removeEventListener('keydown', closeOnEscape);
      }
    });
  });

  // Add event listeners for add to cart and buy now buttons
  productDetailContent.querySelector(".add-to-cart").addEventListener("click", () => {
    addToCart(product.id);
  });

  productDetailContent.querySelector(".buy-now").addEventListener("click", () => {
    buyNow(product.id);
  });

  // Add event listeners for related products
  productDetailContent.querySelectorAll(".related-product-card").forEach((card) => {
    card.addEventListener("click", () => {
      const pid = card.dataset.productId;
      viewProductDetail(pid);
    });
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const pid = card.dataset.productId;
        viewProductDetail(pid);
      }
    });
  });
}

// Update the product data structure to include multiple images
// This should be added to each product object in your data arrays
// For example, in your featuredProducts array:
/*
const featuredProducts = [
  {
    id: "p1",
    name: "Wireless Bluetooth Headphones with Mic",
    price: 2499,
    originalPrice: 3499,
    discount: 29,
    img: "https://placehold.co/300x240/png?text=Wireless+Headphones",
    images: [
      "https://placehold.co/300x240/png?text=Wireless+Headphones",
      "https://placehold.co/300x240/png?text=Headphones+Angle",
      "https://placehold.co/300x240/png?text=Headphones+Case",
      "https://placehold.co/300x240/png?text=Headphones+Worn"
    ],
    // ... other properties
  },
  // ... other products
];
*/

// If you update your product data structure, modify the renderProductDetail function
// to use product.images instead of the hardcoded productPhotos array


// Enhanced Search Bar Functionality
document.addEventListener("DOMContentLoaded", function() {
  // Main function to enhance the search bar
  function enhanceSearchBar() {
    const searchBar = document.getElementById("searchBar");
    const searchBarExpanded = document.getElementById("searchBarExpanded");
    const searchInputExpanded = document.getElementById("searchInputExpanded");
    const searchSuggestionsExpanded = document.getElementById("searchSuggestionsExpanded");
    const closeSearchExpandedBtn = document.getElementById("closeSearchExpanded");
    
    // Replace the search bar with enhanced version
    searchBar.innerHTML = `
      <div class="flex items-center w-full">
        <i class="fas fa-search text-gray-400"></i>
        <input aria-autocomplete="list" aria-controls="searchSuggestions" aria-expanded="false" 
               aria-haspopup="listbox" autocomplete="off" 
               class="flex-grow ml-3 text-gray-700 text-sm outline-none placeholder-gray-400" 
               id="searchInput" placeholder="Search for products, brands and more..." 
               type="text"/>
        <div class="flex items-center">
          <button class="voice-search p-2 text-gray-400 hover:text-primary-color transition-colors" 
                  aria-label="Voice search" type="button">
            <i class="fas fa-microphone"></i>
          </button>
        
        </div>
      </div>
    `;
    
    // Update references after DOM change
    const voiceSearchBtn = searchBar.querySelector(".voice-search");
    const imageSearchBtn = searchBar.querySelector(".image-search");
    const searchInput = searchBar.querySelector("#searchInput");
    
    // Get user-specific recent searches from localStorage
    const getUserRecentSearches = () => {
      const userKey = window.user ? `recentSearches_${window.user.phone}` : 'recentSearches_guest';
      return JSON.parse(localStorage.getItem(userKey)) || [];
    };
    
    // Save user-specific recent searches
    const saveUserRecentSearches = (searches) => {
      const userKey = window.user ? `recentSearches_${window.user.phone}` : 'recentSearches_guest';
      localStorage.setItem(userKey, JSON.stringify(searches));
    };
    
    // Popular searches (could be fetched from API)
    const popularSearches = [
      { term: "Wireless Earbuds", count: "12k" },
      { term: "Organic Rice", count: "8.5k" },
      { term: "Yoga Mat", count: "7.2k" },
      { term: "Smartphone", count: "15k" },
      { term: "Running Shoes", count: "9.3k" },
      { term: "Kitchen Containers", count: "5.7k" }
    ];
    
    // Open expanded search
    function openSearchExpanded() {
      searchBarExpanded.classList.add("active");
      searchBarExpanded.style.display = "flex";
      document.body.style.overflow = "hidden";
      searchInputExpanded.value = "";
      searchInputExpanded.focus();
      renderSearchExpandedContent();
    }
    
    // Close expanded search
    function closeSearchExpanded() {
      searchBarExpanded.classList.remove("active");
      searchBarExpanded.style.display = "none";
      document.body.style.overflow = "";
      searchInputExpanded.value = "";
      searchSuggestionsExpanded.innerHTML = "";
    }
    
    // Add to recent searches
    function addToRecentSearches(query) {
      if (!query.trim()) return;
      
      const recentSearches = getUserRecentSearches();
      // Remove if already exists
      const filteredSearches = recentSearches.filter(item => item.toLowerCase() !== query.toLowerCase());
      // Add to beginning
      filteredSearches.unshift(query);
      // Keep only 5 items
      if (filteredSearches.length > 5) filteredSearches.pop();
      
      saveUserRecentSearches(filteredSearches);
    }
    
    // Render content for expanded search
    function renderSearchExpandedContent() {
      const recentSearches = getUserRecentSearches();
      
      searchSuggestionsExpanded.innerHTML = `
        <div class="search-sections p-4">
          <!-- Recent Searches -->
          ${recentSearches.length > 0 ? `
            <div class="search-section mb-6">
              <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-history text-gray-500 mr-2"></i> Recent Searches
                <button class="ml-auto text-xs text-primary-color hover:underline clear-recent" type="button">
                  Clear All
                </button>
              </h3>
              <div class="recent-searches flex flex-wrap gap-2">
                ${recentSearches.map(term => `
                  <div class="recent-term bg-gray-100 text-gray-700 rounded-full px-3 py-1.5 text-sm cursor-pointer hover:bg-primary-light transition-colors flex items-center" data-term="${term}">
                    <i class="fas fa-search text-xs mr-2"></i> ${term}
                    <button class="remove-term ml-2 text-gray-500 hover:text-red-500" data-term="${term}" aria-label="Remove recent search ${term}" type="button">
                      <i class="fas fa-times text-xs"></i>
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <!-- Popular Searches -->
          <div class="search-section mb-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-fire text-red-500 mr-2"></i> Popular Right Now
            </h3>
            <div class="popular-searches">
              ${popularSearches.map(item => `
                <div class="popular-term flex items-center justify-between py-2.5 px-1 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors group" data-term="${item.term}" role="option" tabindex="0">
                  <div class="flex items-center">
                    <span class="text-gray-500 mr-3 group-hover:text-primary-color transition-colors">#</span>
                    <span class="text-gray-800 group-hover:text-primary-color transition-colors">${item.term}</span>
                  </div>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${item.count} searches</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Browse Categories -->
          <div class="search-section">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-tag text-blue-500 mr-2"></i> Browse Categories
            </h3>
            <div class="categories-grid grid grid-cols-2 gap-3">
              ${window.categories.slice(0, 6).map(category => `
                <div class="category-item bg-gradient-to-r ${category.color} rounded-lg p-3 cursor-pointer hover:shadow-md transition-all flex items-center" data-category="${category.id}" role="button" tabindex="0" aria-label="Browse category ${category.name}">
                  <div class="w-8 h-8 ${category.color.split(' ')[0]} rounded-full flex items-center justify-center mr-2 text-primary-color">
                    <i class="${category.icon} text-sm"></i>
                  </div>
                  <span class="text-xs font-medium">${category.name}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners for recent searches
      searchSuggestionsExpanded.querySelectorAll(".recent-term").forEach(termEl => {
        const term = termEl.dataset.term;
        termEl.addEventListener("click", () => {
          searchInputExpanded.value = term;
          performSearch(term);
        });
        
        // Remove individual term
        const removeBtn = termEl.querySelector(".remove-term");
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const termToRemove = removeBtn.dataset.term;
          const updatedSearches = recentSearches.filter(item => item !== termToRemove);
          saveUserRecentSearches(updatedSearches);
          renderSearchExpandedContent();
        });
      });
      
      // Add event listeners for popular searches
      searchSuggestionsExpanded.querySelectorAll(".popular-term").forEach(termEl => {
        termEl.addEventListener("click", () => {
          searchInputExpanded.value = termEl.dataset.term;
          performSearch(termEl.dataset.term);
        });
        termEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            searchInputExpanded.value = termEl.dataset.term;
            performSearch(termEl.dataset.term);
          }
        });
      });
      
      // Add event listeners for categories
      searchSuggestionsExpanded.querySelectorAll(".category-item").forEach(category => {
        category.addEventListener("click", () => {
          navigateToCategory(category.dataset.category);
          closeSearchExpanded();
        });
        category.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToCategory(category.dataset.category);
            closeSearchExpanded();
          }
        });
      });
      
      // Clear recent searches
      const clearRecentBtn = searchSuggestionsExpanded.querySelector(".clear-recent");
      if (clearRecentBtn) {
        clearRecentBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          saveUserRecentSearches([]);
          renderSearchExpandedContent();
          showToast("Recent searches cleared", "info");
        });
      }
    }
    
    // Perform search and show results
    function performSearch(query) {
      if (!query.trim()) return;
      
      // Add to recent searches
      addToRecentSearches(query);
      
      // Filter products based on search query
      const results = window.allProducts.filter(product => 
        product.name.toLowerCase().includes(query.toLowerCase()) ||
        product.category.toLowerCase().includes(query.toLowerCase()) ||
        product.features.some(feature => 
          feature.toLowerCase().includes(query.toLowerCase())
        )
      );
      
      // Display search results
      if (results.length === 0) {
        searchSuggestionsExpanded.innerHTML = `
          <div class="no-results text-center py-8 px-4">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-search text-2xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-700 mb-2">No results found for "${query}"</h3>
            <p class="text-gray-500 mb-4">Try different keywords or check our suggestions</p>
            <div class="suggested-searches">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Try searching for:</h4>
              <div class="flex flex-wrap gap-2 justify-center">
                <span class="suggested-term bg-gray-100 text-gray-700 rounded-full px-3 py-1.5 text-sm cursor-pointer hover:bg-primary-light transition-colors" data-term="Electronics" role="button" tabindex="0">Electronics</span>
                <span class="suggested-term bg-gray-100 text-gray-700 rounded-full px-3 py-1.5 text-sm cursor-pointer hover:bg-primary-light transition-colors" data-term="Grocery" role="button" tabindex="0">Grocery</span>
                <span class="suggested-term bg-gray-100 text-gray-700 rounded-full px-3 py-1.5 text-sm cursor-pointer hover:bg-primary-light transition-colors" data-term="Fashion" role="button" tabindex="0">Fashion</span>
              </div>
            </div>
          </div>
        `;
        
        // Add event listeners to suggested terms
        searchSuggestionsExpanded.querySelectorAll(".suggested-term").forEach(term => {
          term.addEventListener("click", () => {
            searchInputExpanded.value = term.dataset.term;
            performSearch(term.dataset.term);
          });
          term.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              searchInputExpanded.value = term.dataset.term;
              performSearch(term.dataset.term);
            }
          });
        });
      } else {
        searchSuggestionsExpanded.innerHTML = `
          <div class="search-results-container">
            <div class="search-results-header flex justify-between items-center p-4 border-b border-gray-100">
              <h3 class="text-sm font-semibold text-gray-700">
                ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"
              </h3>
              <button class="text-xs text-primary-color hover:underline filter-results flex items-center" type="button" aria-label="Filter and sort results">
                <i class="fas fa-filter mr-1"></i> Filter & Sort
              </button>
            </div>
            <div class="search-results-grid grid grid-cols-1 gap-0">
              ${results.slice(0, 5).map(product => `
                <div class="search-result-item p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors flex items-center" data-product-id="${product.id}" role="button" tabindex="0" aria-label="View product ${product.name}">
                  <img src="${product.img}" alt="${product.name} product image showing ${product.name}" class="w-16 h-16 object-contain rounded mr-4" loading="lazy" />
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-800 truncate">${product.name}</h4>
                    <p class="text-xs text-gray-500 mb-1">${product.category}</p>
                    <div class="flex items-center justify-between">
                      <p class="text-primary-color font-bold">${formatPrice(product.price)}</p>
                      ${product.originalPrice ? `
                        <span class="text-xs text-gray-500 line-through">${formatPrice(product.originalPrice)}</span>
                      ` : ''}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${results.length > 5 ? `
              <div class="view-all-results p-4 text-center border-t border-gray-100">
                <button class="text-primary-color text-sm font-medium hover:underline view-all-btn w-full py-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors" type="button" aria-label="View all ${results.length} results">
                  View all ${results.length} results
                </button>
              </div>
            ` : ''}
          </div>
        `;
        
        // Add event listeners to search result items
        searchSuggestionsExpanded.querySelectorAll(".search-result-item").forEach(item => {
          item.addEventListener("click", () => {
            viewProductDetail(item.dataset.productId);
            closeSearchExpanded();
          });
          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              viewProductDetail(item.dataset.productId);
              closeSearchExpanded();
            }
          });
        });
        
        // View all results button
        const viewAllBtn = searchSuggestionsExpanded.querySelector(".view-all-btn");
        if (viewAllBtn) {
          viewAllBtn.addEventListener("click", () => {
            // Create search results page
            showSearchResultsPage(query, results);
            closeSearchExpanded();
          });
        }
      }
    }
    
    // Show full search results page
    function showSearchResultsPage(query, results) {
      // Create overlay for search results
      const resultsOverlay = document.createElement("div");
      resultsOverlay.className = "fixed inset-0 bg-white z-50 overflow-y-auto";
      resultsOverlay.setAttribute("role", "dialog");
      resultsOverlay.setAttribute("aria-modal", "true");
      resultsOverlay.setAttribute("aria-label", `Search results for ${query}`);
      resultsOverlay.innerHTML = `
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center shadow-sm z-20">
          <button class="back-button mr-3 text-gray-600 hover:text-primary-color transition-colors text-xl" type="button" aria-label="Back to search">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div class="flex-1 relative">
            <input type="search" value="${query}" aria-label="Search input" class="w-full border border-gray-300 rounded-lg py-2 px-4 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-color" placeholder="Search for products..." spellcheck="false" />
            <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary-color transition-colors" type="button" aria-label="Search">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <button class="close-results ml-3 text-gray-600 hover:text-primary-color transition-colors text-xl" type="button" aria-label="Close search results">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="p-4">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Search Results for "${query}"</h1>
            <span class="text-sm text-gray-500">${results.length} item${results.length !== 1 ? 's' : ''}</span>
          </div>
          
          <div class="filters-bar flex flex-wrap gap-2 mb-4">
            <button class="filter-btn bg-gray-100 text-gray-700 rounded-full px-3 py-1 text-sm hover:bg-gray-200 transition-colors flex items-center" type="button" aria-label="Filter results">
              <i class="fas fa-filter mr-1 text-xs"></i> Filters
            </button>
            <button class="sort-btn bg-gray-100 text-gray-700 rounded-full px-3 py-1 text-sm hover:bg-gray-200 transition-colors flex items-center" type="button" aria-label="Sort results">
              <i class="fas fa-sort mr-1 text-xs"></i> Sort
            </button>
          </div>
          
          <div class="results-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            ${results.map(product => `
              <div class="product-card bg-white rounded-xl shadow-sm cursor-pointer flex flex-col overflow-hidden hover:shadow-md transition-all" data-product-id="${product.id}" role="button" tabindex="0" aria-label="View product ${product.name}">
                <div class="relative">
                  <img src="${product.img}" alt="${product.name} product image showing ${product.name}" class="w-full h-40 object-contain bg-gray-100 p-4" loading="lazy" />
                  ${product.discount ? `
                    <span class="absolute top-2 left-2 bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
                      ${product.discount}% OFF
                    </span>
                  ` : ''}
                </div>
                <div class="p-3 flex flex-col flex-grow">
                  <h4 class="text-sm mb-1 line-clamp-2 flex-grow">${product.name}</h4>
                  <div class="flex items-center mb-1">
                    <div class="rating-stars text-xs mr-1 text-yellow-400">
                      ${'<i class="fas fa-star"></i>'.repeat(Math.floor(product.rating))}
                      ${product.rating % 1 >= 0.5 ? '<i class="fas fa-star-half-alt"></i>' : ''}
                      ${'<i class="far fa-star"></i>'.repeat(5 - Math.ceil(product.rating))}
                    </div>
                    <span class="text-xs text-gray-500">(${product.reviews})</span>
                  </div>
                  <div class="flex items-center mb-2">
                    <p class="product-price font-bold text-primary-color mr-2">${formatPrice(product.price)}</p>
                    ${product.originalPrice ? `
                      <p class="product-original-price text-xs text-gray-500 line-through">${formatPrice(product.originalPrice)}</p>
                    ` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(resultsOverlay);
      
      // Add event listeners
      resultsOverlay.querySelector(".back-button").addEventListener("click", () => {
        resultsOverlay.remove();
        openSearchExpanded();
        searchInputExpanded.value = query;
        searchInputExpanded.focus();
      });
      
      resultsOverlay.querySelector(".close-results").addEventListener("click", () => {
        resultsOverlay.remove();
      });
      
      const searchInput = resultsOverlay.querySelector("input[type=search]");
      const searchBtn = resultsOverlay.querySelector("button[aria-label='Search']");
      
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = searchInput.value.trim();
          if (val) {
            performSearch(val);
            resultsOverlay.remove();
            openSearchExpanded();
            searchInputExpanded.value = val;
            searchInputExpanded.focus();
          }
        } else if (e.key === "Escape") {
          e.preventDefault();
          resultsOverlay.remove();
        }
      });
      
      searchBtn.addEventListener("click", () => {
        const val = searchInput.value.trim();
        if (val) {
          performSearch(val);
          resultsOverlay.remove();
          openSearchExpanded();
          searchInputExpanded.value = val;
          searchInputExpanded.focus();
        }
      });
      
      resultsOverlay.querySelectorAll(".product-card").forEach(card => {
        card.addEventListener("click", () => {
          viewProductDetail(card.dataset.productId);
          resultsOverlay.remove();
        });
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            viewProductDetail(card.dataset.productId);
            resultsOverlay.remove();
          }
        });
      });
    }
    
    // Voice search functionality
    function initVoiceSearch() {
      voiceSearchBtn.addEventListener("click", () => {
        if (!("webkitSpeechRecognition" in window)) {
          showToast("Voice search is not supported in your browser", "error");
          return;
        }
        
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
          voiceSearchBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
          voiceSearchBtn.classList.add("text-primary-color", "listening");
          showToast("Listening... Speak now", "info");
        };
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInputExpanded.value = transcript;
          performSearch(transcript);
        };
        
        recognition.onerror = (event) => {
          voiceSearchBtn.innerHTML = '<i class="fas fa-microphone"></i>';
          voiceSearchBtn.classList.remove("text-primary-color", "listening");
          showToast("Error occurred in recognition: " + event.error, "error");
        };
        
        recognition.onend = () => {
          voiceSearchBtn.innerHTML = '<i class="fas fa-microphone"></i>';
          voiceSearchBtn.classList.remove("text-primary-color", "listening");
        };
        
        recognition.start();
      });
    }
    
    // Image search functionality
    function initImageSearch() {
      imageSearchBtn.addEventListener("click", () => {
        showToast("Image search coming soon!", "info");
      });
    }
    
    // Initialize event listeners
    function initSearchEventListeners() {
      // Open expanded search when clicking on search bar or input
      searchBar.addEventListener("click", openSearchExpanded);
      searchInput.addEventListener("click", (e) => {
        e.stopPropagation();
        openSearchExpanded();
      });
      
      // Close expanded search
      closeSearchExpandedBtn.addEventListener("click", closeSearchExpanded);
      
      // Search input event with debounce
      let searchTimeout;
      searchInputExpanded.addEventListener("input", () => {
        clearTimeout(searchTimeout);
        const query = searchInputExpanded.value.trim();
        
        if (query.length === 0) {
          renderSearchExpandedContent();
          return;
        }
        
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });
      
      // Keyboard navigation
      searchInputExpanded.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSearchExpanded();
        } else if (e.key === "Enter") {
          const query = searchInputExpanded.value.trim();
          if (query) {
            performSearch(query);
          }
        }
      });
      
      // Close when clicking outside
      document.addEventListener("click", (e) => {
        if (!searchBarExpanded.contains(e.target) && !searchBar.contains(e.target)) {
          closeSearchExpanded();
        }
      });
    }
    
    // Initialize everything
    initSearchEventListeners();
    initVoiceSearch();
    initImageSearch();
  }

  // Helper functions
  function formatPrice(price) {
    return `$${price.toFixed(2)}`;
  }
  
  function showToast(message, type = "info") {
    const colors = {
      info: "bg-blue-500",
      error: "bg-red-500",
      success: "bg-green-500",
    };
    const toast = document.createElement("div");
    toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-md text-white shadow-lg ${colors[type]} z-[9999] animate-fadeInOut`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // Add fadeInOut animation styles
  const toastStyles = `
    @keyframes fadeInOut {
      0% {opacity: 0; transform: translateY(20px);}
      10%, 90% {opacity: 1; transform: translateY(0);}
      100% {opacity: 0; transform: translateY(20px);}
    }
    .animate-fadeInOut {
      animation: fadeInOut 3s ease forwards;
    }
  `;
  const toastStyleEl = document.createElement("style");
  toastStyleEl.textContent = toastStyles;
  document.head.appendChild(toastStyleEl);

  // Navigation to category (dummy)
  function navigateToCategory(categoryId) {
    showToast(`Navigating to category: ${categoryId}`, "info");
  }

  // View product detail (dummy)
  function viewProductDetail(productId) {
    const product = allProducts.find((p) => p.id === productId);
    if (!product) {
      showToast("Product not found", "error");
      return;
    }
    alert(`Viewing product detail:\n\n${product.name}\nCategory: ${product.category}\nPrice: ${formatPrice(product.price)}`);
  }

  // Initialize the enhanced search bar
  enhanceSearchBar();
});


















    
// Notification System
class NotificationSystem {
    constructor() {
        this.notifications = [];
        this.unreadCount = 0;
        this.isNotificationModalOpen = false;
        this.lastToastTime = 0;
        this.toastCooldown = 3000; // 3 seconds between toasts
        this.init();
    }

    init() {
        // Create notification container if it doesn't exist
        if (!document.getElementById('notificationModal')) {
            this.createNotificationModal();
        }
        
        // Load notifications from localStorage if available
        this.loadNotifications();
        
        // Setup event listeners
        this.setupEventListeners();
        
        // Don't create initial notifications for first-time users
        const isFirstTimeUser = !localStorage.getItem('nepalMartFirstTime');
        if (isFirstTimeUser) {
            localStorage.setItem('nepalMartFirstTime', 'false');
        } else if (this.notifications.length === 0) {
            // Create initial notifications only for returning users
            this.createInitialNotifications();
        }
    }

    createNotificationModal() {
        const modalHTML = `
        <div id="notificationModal" class="fixed top-16 right-4 w-80 bg-white rounded-xl shadow-2xl z-50 hidden animate-scaleIn flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-semibold text-gray-800">Notifications</h3>
                <button id="closeNotificationModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto" id="notificationList" style="max-height: 60vh;">
                <!-- Notifications will be inserted here -->
            </div>
            <div class="p-3 border-t border-gray-200 text-center bg-gray-50">
                <button id="viewAllNotifications" class="text-primary-color text-sm font-medium hover:underline">
                    View All Notifications
                </button>
            </div>
        </div>
        <div id="notificationOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden"></div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    setupEventListeners() {
        // Notification button click
        document.getElementById('notificationBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleNotificationModal();
        });

        // Close modal button
        document.getElementById('closeNotificationModal').addEventListener('click', () => {
            this.hideNotificationModal();
        });

        // View all notifications
        document.getElementById('viewAllNotifications').addEventListener('click', () => {
            this.hideNotificationModal();
            // In a real app, this would navigate to a notifications page
            this.showToast("Opening all notifications", "info");
        });

        // Close modal when clicking outside
        document.getElementById('notificationOverlay').addEventListener('click', () => {
            this.hideNotificationModal();
        });

        // Prevent body scrolling when modal is open
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const modal = document.getElementById('notificationModal');
                    if (modal.classList.contains('hidden')) {
                        document.body.style.overflow = 'auto';
                    } else {
                        document.body.style.overflow = 'hidden';
                    }
                }
            });
        });

        observer.observe(document.getElementById('notificationModal'), {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    createInitialNotifications() {
        // Only create initial notifications if none exist
        if (this.notifications.length === 0) {
            // Login success notification
            this.addNotification({
                id: 'n1',
                type: 'login',
                title: 'Login Successful',
                message: 'Welcome back to Nepal Mart!',
                timestamp: new Date(Date.now() - 1000 * 60 * 2), // 2 minutes ago
                read: false,
                action: 'profile'
            });

            // Order success notification
            this.addNotification({
                id: 'n2',
                type: 'order',
                title: 'Order Confirmed',
                message: 'Your order #ORD12345 has been placed successfully.',
                timestamp: new Date(Date.now() - 1000 * 60 * 30), // 30 minutes ago
                read: false,
                action: 'orders',
                orderId: 'ORD12345'
            });

            // Signup success notification
            this.addNotification({
                id: 'n3',
                type: 'signup',
                title: 'Welcome to Nepal Mart!',
                message: 'Thank you for joining our community. Enjoy shopping!',
                timestamp: new Date(Date.now() - 1000 * 60 * 60 * 3), // 3 hours ago
                read: false
            });

            // General notification
            this.addNotification({
                id: 'n4',
                type: 'info',
                title: 'Special Offer',
                message: 'Get 15% off on your first order. Use code: WELCOME15',
                timestamp: new Date(Date.now() - 1000 * 60 * 60 * 5), // 5 hours ago
                read: false
            });
        }
    }

    addNotification(notification) {
        // Check if user is logged in and get user phone
        const userPhone = user ? user.phone : null;
        
        // Store notification with user phone if available
        notification.userPhone = userPhone;
        notification.id = notification.id || 'n' + Date.now();
        notification.timestamp = notification.timestamp || new Date();
        notification.read = notification.read || false;
        
        this.notifications.unshift(notification); // Add to beginning of array
        if (!notification.read) this.unreadCount++;
        
        this.updateNotificationBadge();
        this.saveNotifications();
        
        return notification;
    }

    showNotificationToast(notification) {
        const now = Date.now();
        if (now - this.lastToastTime < this.toastCooldown) {
            // Skip toast if cooldown period hasn't passed
            return;
        }
        
        this.lastToastTime = now;
        
        let icon = 'fas fa-bell';
        let type = 'info';
        
        switch(notification.type) {
            case 'login':
                icon = 'fas fa-check-circle';
                type = 'success';
                break;
            case 'order':
                icon = 'fas fa-shopping-bag';
                type = 'success';
                break;
            case 'signup':
                icon = 'fas fa-party-horn';
                type = 'success';
                break;
        }
        
        // Don't show welcome toast messages
        if (notification.type === 'login' || notification.type === 'signup') {
            return;
        }
        
        this.showToast(notification.message, type, {icon});
    }

    markAsRead(notificationId) {
        const notification = this.notifications.find(n => n.id === notificationId);
        if (notification && !notification.read) {
            notification.read = true;
            this.unreadCount--;
            this.updateNotificationBadge();
            this.saveNotifications();
            return true;
        }
        return false;
    }

    markAllAsRead() {
        this.notifications.forEach(notification => {
            if (!notification.read) {
                notification.read = true;
            }
        });
        this.unreadCount = 0;
        this.updateNotificationBadge();
        this.saveNotifications();
    }

    updateNotificationBadge() {
        const badge = document.getElementById('notificationBadge');
        if (this.unreadCount > 0) {
            badge.textContent = this.unreadCount > 9 ? '9+' : this.unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    renderNotifications() {
        const container = document.getElementById('notificationList');
        container.innerHTML = '';
        
        // Filter notifications for current user if logged in
        let userNotifications = this.notifications;
        if (user) {
            userNotifications = this.notifications.filter(n => 
                !n.userPhone || n.userPhone === user.phone
            );
        }
        
        // Show only the 4 most recent notifications in the modal
        const notificationsToShow = userNotifications.slice(0, 4);
        
        if (notificationsToShow.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                    <p>No notifications yet</p>
                </div>
            `;
            return;
        }
        
        notificationsToShow.forEach(notification => {
            const notificationEl = this.createNotificationElement(notification);
            container.appendChild(notificationEl);
        });
    }

    createNotificationElement(notification) {
        const div = document.createElement('div');
        div.className = `notification-item p-3 border-b border-gray-100 ${notification.read ? '' : 'bg-blue-50'}`;
        div.dataset.id = notification.id;
        
        const timeAgo = this.getTimeAgo(notification.timestamp);
        let icon = 'fas fa-bell';
        let iconColor = 'text-blue-500';
        
        switch(notification.type) {
            case 'login':
                icon = 'fas fa-user-check';
                iconColor = 'text-green-500';
                break;
            case 'order':
                icon = 'fas fa-shopping-bag';
                iconColor = 'text-purple-500';
                break;
            case 'signup':
                icon = 'fas fa-party-horn';
                iconColor = 'text-yellow-500';
                break;
            case 'info':
                icon = 'fas fa-info-circle';
                iconColor = 'text-blue-500';
                break;
        }
        
        let actionButton = '';
        if ((notification.type === 'login' || notification.type === 'signup') && user) {
            actionButton = `
                <button class="upload-profile-btn mt-2 bg-primary-color text-white text-xs py-1 px-3 rounded-full hover:bg-red-700 transition-colors">
                    <i class="fas fa-camera mr-1"></i> Upload Profile
                </button>
            `;
        }
        
        div.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0 mr-3">
                    <div class="w-10 h-10 rounded-full ${iconColor} bg-opacity-20 flex items-center justify-center">
                        <i class="${icon}"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${notification.title}</p>
                    <p class="text-sm text-gray-500">${notification.message}</p>
                    <div class="flex items-center mt-1">
                        <span class="text-xs text-gray-400">${timeAgo}</span>
                        ${!notification.read ? '<span class="ml-2 w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                    </div>
                    ${actionButton}
                </div>
            </div>
        `;
        
        // Add click handler for upload profile button
        const uploadBtn = div.querySelector('.upload-profile-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.handleUploadProfile();
            });
        }
        
        // Make notification non-clickable (as requested)
        div.style.cursor = 'default';
        
        return div;
    }

    handleUploadProfile() {
        this.hideNotificationModal();
        
        // Create a file input element
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                this.uploadProfilePicture(file);
            }
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
    }

    uploadProfilePicture(file) {
        if (!user) {
            this.showToast('Please login to upload a profile picture', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageDataUrl = e.target.result;
            
            // Store profile picture in localStorage with user phone as key
            localStorage.setItem(`profile_${user.phone}`, imageDataUrl);
            
            // Update profile icon
            this.updateProfileIcon(imageDataUrl);
            
            this.showToast('Profile picture uploaded successfully!', 'success');
        };
        
        reader.readAsDataURL(file);
    }

    updateProfileIcon(imageDataUrl) {
        const profileInitial = document.getElementById('profileInitial');
        const profileIcon = profileInitial.parentElement;
        
        // Replace initial with image
        profileInitial.classList.add('hidden');
        
        // Check if img already exists
        let profileImg = profileIcon.querySelector('img');
        if (!profileImg) {
            profileImg = document.createElement('img');
            profileImg.className = 'w-8 h-8 rounded-full object-cover';
            profileIcon.appendChild(profileImg);
        }
        
        profileImg.src = imageDataUrl;
        
        // Also update in profile section if open
        this.updateProfileSection(imageDataUrl);
    }

    updateProfileSection(imageDataUrl) {
        const profileContent = document.getElementById('profileContent');
        if (!profileContent) return;
        
        let profilePic = profileContent.querySelector('.profile-pic');
        if (profilePic) {
            // Replace initial with image
            const initial = profilePic.querySelector('span');
            if (initial) initial.classList.add('hidden');
            
            let profileImg = profilePic.querySelector('img');
            if (!profileImg) {
                profileImg = document.createElement('img');
                profileImg.className = 'w-16 h-16 rounded-full object-cover';
                profilePic.appendChild(profileImg);
            }
            
            profileImg.src = imageDataUrl;
        }
        
        // Enhance profile section with edit capability
        this.enhanceProfileSection();
    }
    
    enhanceProfileSection() {
        const profileContent = document.getElementById('profileContent');
        if (!profileContent) return;
        
        // Check if we already enhanced the profile section
        if (profileContent.querySelector('.profile-pic-edit')) return;
        
        const profileHeader = profileContent.querySelector('.profile-header');
        if (profileHeader) {
            const profilePic = profileHeader.querySelector('.profile-pic');
            if (profilePic) {
                // Add edit icon overlay
                const editOverlay = document.createElement('div');
                editOverlay.className = 'profile-pic-edit absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer';
                editOverlay.innerHTML = '<i class="fas fa-camera text-white"></i>';
                
                profilePic.style.position = 'relative';
                profilePic.appendChild(editOverlay);
                
                // Add click handler for editing profile picture
                editOverlay.addEventListener('click', () => {
                    this.handleUploadProfile();
                });
            }
        }
    }

    getTimeAgo(timestamp) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - timestamp) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Just now';
        }
        
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
            return `${diffInMinutes} min ago`;
        }
        
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
            return `${diffInHours} hr ago`;
        }
        
        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays < 7) {
            return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
        }
        
        // Return formatted date for older notifications
        return timestamp.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: timestamp.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
    }

    toggleNotificationModal() {
        if (this.isNotificationModalOpen) {
            this.hideNotificationModal();
        } else {
            this.showNotificationModal();
        }
    }

    showNotificationModal() {
        const modal = document.getElementById('notificationModal');
        const overlay = document.getElementById('notificationOverlay');
        this.renderNotifications();
        modal.classList.remove('hidden');
        overlay.classList.remove('hidden');
        this.isNotificationModalOpen = true;
        
        // Mark all as read when opening the modal
        this.markAllAsRead();
    }

    hideNotificationModal() {
        const modal = document.getElementById('notificationModal');
        const overlay = document.getElementById('notificationOverlay');
        modal.classList.add('hidden');
        overlay.classList.add('hidden');
        this.isNotificationModalOpen = false;
    }

    saveNotifications() {
        localStorage.setItem('nepalMartNotifications', JSON.stringify({
            notifications: this.notifications,
            unreadCount: this.unreadCount
        }));
    }

    loadNotifications() {
        const saved = localStorage.getItem('nepalMartNotifications');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.notifications = data.notifications.map(n => ({
                    ...n,
                    timestamp: new Date(n.timestamp)
                }));
                this.unreadCount = data.unreadCount;
                this.updateNotificationBadge();
            } catch (e) {
                console.error('Error loading notifications:', e);
            }
        }
    }

    showToast(message, type = "success") {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');

        let bgColor = "bg-green-500";
        let icon = "fas fa-check-circle";

        if (type === "error") {
            bgColor = "bg-red-500";
            icon = "fas fa-times-circle";
        } else if (type === "warning") {
            bgColor = "bg-yellow-500";
            icon = "fas fa-exclamation-circle";
        } else if (type === "info") {
            bgColor = "bg-blue-500";
            icon = "fas fa-info-circle";
        }

        toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-md shadow-lg flex items-center justify-between`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="${icon} mr-2"></i>
                <span>${message}</span>
            </div>
            <button class="close-toast ml-4 text-white hover:text-red-200 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        `;

        toastContainer.appendChild(toast);

        // Auto remove toast after 5 seconds
        setTimeout(() => {
            toast.classList.add("hide");
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 5000);

        // Close button
        toast.querySelector(".close-toast").addEventListener("click", () => {
            toast.classList.add("hide");
            setTimeout(() => {
                toast.remove();
            }, 300);
        });
    }
}

// Initialize notification system when DOM is loaded
let notificationSystem;

document.addEventListener('DOMContentLoaded', () => {
    notificationSystem = new NotificationSystem();
    
    // Load profile picture if exists
    if (user) {
        const savedProfilePic = localStorage.getItem(`profile_${user.phone}`);
        if (savedProfilePic) {
            notificationSystem.updateProfileIcon(savedProfilePic);
        }
    }
});

// Modify the existing login handler to add notification
document.getElementById('loginSubmit').addEventListener('click', () => {
    const phone = document.getElementById('loginPhone').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!phone || !password) {
        showToast("Please enter phone number and password", "error");
        return;
    }

    // Simulate login success
    toggleLoading(document.getElementById('loginSubmit'), true);

    setTimeout(() => {
        isLoggedIn = true;
        user = {
            name: "John Doe",
            phone: phone,
            email: "johndoe@example.com",
            address: currentLocation || "Kathmandu, Nepal",
            joinedOn: "15 Jan 2023",
        };

        profileInitial.textContent = user.name.charAt(0);
        loginModal.classList.add('hidden');
        updateUIAfterLogin();
        
        // Add login success notification
        notificationSystem.addNotification({
            type: 'login',
            title: 'Login Successful',
            message: `Welcome back, ${user.name}!`,
            timestamp: new Date(),
            read: false,
            action: 'profile'
        });
        
        // Load profile picture if exists
        const savedProfilePic = localStorage.getItem(`profile_${user.phone}`);
        if (savedProfilePic) {
            notificationSystem.updateProfileIcon(savedProfilePic);
        }
        
        toggleLoading(document.getElementById('loginSubmit'), false);
    }, 1500);
});

// Modify the existing signup handler to add notification
document.getElementById('signupSubmit').addEventListener('click', () => {
    const name = document.getElementById('signupName').value.trim();
    const phone = document.getElementById('signupPhone').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();

    // Validation checks...

    // Simulate signup success
    toggleLoading(document.getElementById('signupSubmit'), true);

    setTimeout(() => {
        isLoggedIn = true;
        user = {
            name: name,
            phone: phone,
            email: email || null,
            address: currentLocation || null,
            joinedOn: new Date().toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }),
        };

        profileInitial.textContent = user.name.charAt(0);
        signupModal.classList.add('hidden');
        updateUIAfterLogin();
        
        // Add signup success notification
        notificationSystem.addNotification({
            type: 'signup',
            title: 'Welcome to Nepal Mart!',
            message: `Thank you for joining, ${user.name}! Enjoy your shopping experience.`,
            timestamp: new Date(),
            read: false
        });
        
        toggleLoading(document.getElementById('signupSubmit'), false);
    }, 1500);
});

// Function to simulate order success
function simulateOrderSuccess() {
    if (!user) {
        showToast("Please login to place an order", "error");
        return null;
    }
    
    const orderId = 'ORD' + Math.floor(10000 + Math.random() * 90000);
    
    notificationSystem.addNotification({
        type: 'order',
        title: 'Order Confirmed',
        message: `Your order #${orderId} has been placed successfully.`,
        timestamp: new Date(),
        read: false,
        action: 'orders',
        orderId: orderId
    });
    
    return orderId;
}

// Override the navigateToSection function to enhance profile section when opened
const originalNavigateToSection = navigateToSection;
navigateToSection = function(sectionId) {
    originalNavigateToSection.call(this, sectionId);
    
    if (sectionId === 'profile') {
        // Small delay to allow DOM update
        setTimeout(() => {
            notificationSystem.enhanceProfileSection();
            
            // Load profile picture if exists
            if (user) {
                const savedProfilePic = localStorage.getItem(`profile_${user.phone}`);
                if (savedProfilePic) {
                    notificationSystem.updateProfileSection(savedProfilePic);
                }
            }
        }, 100);
    }
};

// Example: Trigger an order success notification
// This would be called from your checkout process
function exampleOrderCheckout() {
    const orderId = simulateOrderSuccess();
    if (orderId) {
        showToast(`Order #${orderId} placed successfully!`, 'success');
    }
}

 // Extended product data
    const featuredProducts = [
      {
        id: "p1",
        name: "Wireless Bluetooth Headphones with Mic",
        price: 2499,
        originalPrice: 3499,
        discount: 29,
        img: "https://placehold.co/300x240/png?text=Wireless+Headphones",
        category: "electronics",
        rating: 4.5,
        reviews: 128,
        description: "High-quality wireless headphones with built-in microphone for crystal clear calls. 30 hours battery life with quick charge.",
        features: ["Bluetooth 5.0", "Noise Cancellation", "30hr Battery", "Foldable"],
        seller: "Tech Gadgets Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "2 days ago"
      },
      {
        id: "p2",
        name: "Smart Watch with Fitness Tracker",
        price: 3999,
        originalPrice: 5999,
        discount: 33,
        img: "https://placehold.co/300x240/png?text=Smart+Watch",
        category: "electronics",
        rating: 4.2,
        reviews: 86,
        description: "Track your fitness activities with this smart watch that monitors heart rate, steps, calories and sleep patterns.",
        features: ["Heart Rate Monitor", "Water Resistant", "7-day Battery", "Notifications"],
        seller: "Smart Devices Co.",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "5 hours ago"
      },
      {
        id: "p3",
        name: "Portable Bluetooth Speaker",
        price: 1799,
        originalPrice: 2499,
        discount: 28,
        img: "https://placehold.co/300x240/png?text=Bluetooth+Speaker",
        category: "electronics",
        rating: 4.7,
        reviews: 215,
        description: "Compact yet powerful Bluetooth speaker with 10W output and 12 hours playtime. Perfect for outdoor activities.",
        features: ["10W Sound", "12hr Battery", "IPX5 Waterproof", "Built-in Mic"],
        seller: "Audio Nepal",
        inStock: true,
        delivery: "Rs. 50 delivery",
        lastBought: "1 day ago"
      },
      {
        id: "p4",
        name: "Anti Blue Light Glasses",
        price: 899,
        originalPrice: 1499,
        discount: 40,
        img: "https://placehold.co/300x240/png?text=Blue+Light+Glasses",
        category: "health",
        rating: 4.3,
        reviews: 42,
        description: "Protect your eyes from harmful blue light emitted by screens with these stylish glasses.",
        features: ["UV Protection", "Lightweight Frame", "Unisex Design"],
        seller: "Eye Care Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "3 days ago"
      },
      {
        id: "p5",
        name: "Wireless Mouse with USB Receiver",
        price: 699,
        originalPrice: 999,
        discount: 30,
        img: "https://placehold.co/300x240/png?text=Wireless+Mouse",
        category: "electronics",
        rating: 4.0,
        reviews: 37,
        description: "Ergonomic wireless mouse with 2.4GHz connectivity and silent clicks. Works up to 10 meters.",
        features: ["2.4GHz Wireless", "12 Months Battery", "Silent Click", "Plug & Play"],
        seller: "Computer Accessories",
        inStock: true,
        delivery: "Rs. 50 delivery",
        lastBought: "1 week ago"
      },
      {
        id: "p6",
        name: "Multi-port USB Charging Hub",
        price: 1299,
        originalPrice: 1999,
        discount: 35,
        img: "https://placehold.co/300x240/png?text=USB+Hub",
        category: "electronics",
        rating: 4.6,
        reviews: 94,
        description: "Charge up to 6 devices simultaneously with this high-speed USB charging hub.",
        features: ["6 USB Ports", "Smart Charging", "Overload Protection", "Compact Design"],
        seller: "Power Solutions",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "2 days ago"
      },
      {
        id: "p7",
        name: "Men's Running Shoes",
        price: 3499,
        originalPrice: 4999,
        discount: 30,
        img: "https://placehold.co/300x240/png?text=Running+Shoes",
        category: "fashion",
        rating: 4.8,
        reviews: 156,
        description: "Lightweight running shoes with cushioned soles for maximum comfort during workouts.",
        features: ["Breathable Mesh", "Shock Absorption", "Non-slip Sole", "Multiple Colors"],
        seller: "Sports Gear Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "4 hours ago"
      },
      {
        id: "p8",
        name: "Stainless Steel Water Bottle",
        price: 899,
        originalPrice: 1299,
        discount: 31,
        img: "https://placehold.co/300x240/png?text=Water+Bottle",
        category: "home",
        rating: 4.4,
        reviews: 78,
        description: "Keep your drinks hot or cold for hours with this premium stainless steel water bottle.",
        features: ["750ml Capacity", "Leak-proof", "BPA Free", "24hr Temperature"],
        seller: "Home Essentials",
        inStock: true,
        delivery: "Rs. 50 delivery",
        lastBought: "1 day ago"
      }
    ];

    const dealsProducts = [
      {
        id: "d1",
        name: "Men's Casual T-Shirt (Pack of 3)",
        price: 1199,
        originalPrice: 1999,
        discount: 40,
        img: "https://placehold.co/300x240/png?text=T-Shirt+Pack",
        category: "fashion",
        rating: 4.1,
        reviews: 63,
        description: "Comfortable cotton t-shirts in assorted colors. Perfect for everyday wear.",
        features: ["100% Cotton", "Machine Wash", "Regular Fit", "3 Colors"],
        seller: "Fashion Hub",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "6 hours ago"
      },
      {
        id: "d2",
        name: "Women's Running Shoes",
        price: 2499,
        originalPrice: 3999,
        discount: 38,
        img: "https://placehold.co/300x240/png?text=Women+Shoes",
        category: "fashion",
        rating: 4.7,
        reviews: 142,
        description: "Lightweight women's running shoes with extra cushioning for all-day comfort.",
        features: ["Breathable Upper", "Flexible Sole", "Shock Absorption", "Multiple Sizes"],
        seller: "Active Wear",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "3 hours ago"
      },
      {
        id: "d3",
        name: "Kitchen Storage Containers Set",
        price: 1599,
        originalPrice: 2499,
        discount: 36,
        img: "https://placehold.co/300x240/png?text=Kitchen+Containers",
        category: "home",
        rating: 4.5,
        reviews: 87,
        description: "Airtight food storage containers set to keep your kitchen organized and food fresh.",
        features: ["5 Piece Set", "Airtight Lids", "BPA Free", "Stackable"],
        seller: "Home Solutions",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "1 day ago"
      },
      {
        id: "d4",
        name: "Electric Kettle 1.5L",
        price: 1899,
        originalPrice: 2799,
        discount: 32,
        img: "https://placehold.co/300x240/png?text=Electric+Kettle",
        category: "home",
        rating: 4.3,
        reviews: 54,
        description: "Fast boiling electric kettle with automatic shut-off and boil-dry protection.",
        features: ["1500W Power", "Auto Shut-off", "1.5L Capacity", "360° Base"],
        seller: "Kitchen Appliances",
        inStock: true,
        delivery: "Rs. 100 delivery",
        lastBought: "2 days ago"
      },
      {
        id: "d5",
        name: "Wireless Earphones with Case",
        price: 2999,
        originalPrice: 4999,
        discount: 40,
        img: "https://placehold.co/300x240/png?text=Wireless+Earphones",
        category: "electronics",
        rating: 4.6,
        reviews: 231,
        description: "True wireless stereo earphones with charging case and touch controls.",
        features: ["Bluetooth 5.0", "24hr Battery", "IPX5 Waterproof", "Touch Control"],
        seller: "Audio Tech",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "8 hours ago"
      },
      {
        id: "d6",
        name: "Backpack with USB Charging Port",
        price: 1799,
        originalPrice: 2999,
        discount: 40,
        img: "https://placehold.co/300x240/png?text=USB+Backpack",
        category: "fashion",
        rating: 4.4,
        reviews: 92,
        description: "Stylish backpack with built-in USB charging port and anti-theft design.",
        features: ["USB Charging Port", "Multiple Pockets", "Water Resistant", "Laptop Compartment"],
        seller: "Urban Gear",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "1 day ago"
      },
      {
        id: "d7",
        name: "Yoga Mat with Carry Strap",
        price: 1299,
        originalPrice: 1999,
        discount: 35,
        img: "https://placehold.co/300x240/png?text=Yoga+Mat",
        category: "sports",
        rating: 4.2,
        reviews: 47,
        description: "Premium non-slip yoga mat with carrying strap for easy transport.",
        features: ["Non-slip Surface", "6mm Thick", "Eco-friendly", "Carry Strap"],
        seller: "Fitness Nepal",
        inStock: true,
        delivery: "Rs. 100 delivery",
        lastBought: "3 days ago"
      },
      {
        id: "d8",
        name: "Organic Green Tea (100g)",
        price: 399,
        originalPrice: 599,
        discount: 33,
        img: "https://placehold.co/300x240/png?text=Green+Tea",
        category: "food",
        rating: 4.8,
        reviews: 186,
        description: "Premium organic green tea packed with antioxidants for a healthy lifestyle.",
        features: ["100% Organic", "Antioxidant Rich", "100g Pack", "30 Servings"],
        seller: "Organic Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "5 hours ago"
      }
    ];

    const foodsProducts = [
      {
        id: "f1",
        name: "Organic Basmati Rice (5kg)",
        price: 1299,
        originalPrice: 1599,
        discount: 19,
        img: "https://placehold.co/300x240/png?text=Basmati+Rice",
        category: "grocery",
        rating: 4.7,
        reviews: 215,
        description: "Premium quality organic basmati rice with long grains and aromatic flavor.",
        features: ["5kg Pack", "100% Organic", "Aromatic", "Long Grain"],
        seller: "Organic Farms",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "2 hours ago"
      },
      {
        id: "f2",
        name: "Fresh Apples (1kg)",
        price: 299,
        originalPrice: 399,
        discount: 25,
        img: "https://placehold.co/300x240/png?text=Apples",
        category: "fruits",
        rating: 4.5,
        reviews: 143,
        description: "Fresh and juicy apples packed with nutrients and fiber.",
        features: ["1kg Pack", "Fresh", "Juicy", "Nutritious"],
        seller: "Fresh Fruits Nepal",
        inStock: true,
        delivery: "Rs. 50 delivery",
        lastBought: "4 hours ago"
      },
      {
        id: "f3",
        name: "Momo Masala Spice Mix",
        price: 149,
        originalPrice: 199,
        discount: 25,
        img: "https://placehold.co/300x240/png?text=Momo+Masala",
        category: "spices",
        rating: 4.9,
        reviews: 328,
        description: "Authentic momo masala spice mix for perfect momo flavor every time.",
        features: ["50g Pack", "Authentic Taste", "No Preservatives", "Vegetarian"],
        seller: "Nepali Masala",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "1 hour ago"
      },
      {
        id: "f4",
        name: "Fresh Chicken (1kg)",
        price: 599,
        originalPrice: 699,
        discount: 14,
        img: "https://placehold.co/300x240/png?text=Chicken",
        category: "meat",
        rating: 4.6,
        reviews: 187,
        description: "Fresh farm chicken processed in hygienic conditions.",
        features: ["1kg Pack", "Fresh", "Hygienic", "Farm Raised"],
        seller: "Meat Mart",
        inStock: true,
        delivery: "Rs. 100 delivery",
        lastBought: "3 hours ago"
      }
    ];

    const groceryProducts = [
      {
        id: "g1",
        name: "Toilet Paper (12 Rolls)",
        price: 699,
        originalPrice: 899,
        discount: 22,
        img: "https://placehold.co/300x240/png?text=Toilet+Paper",
        category: "home",
        rating: 4.3,
        reviews: 76,
        description: "Soft and strong toilet paper rolls for everyday use.",
        features: ["12 Rolls", "2-Ply", "Soft", "Biodegradable"],
        seller: "Home Essentials",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "1 day ago"
      },
      {
        id: "g2",
        name: "Liquid Detergent (2L)",
        price: 499,
        originalPrice: 599,
        discount: 17,
        img: "https://placehold.co/300x240/png?text=Detergent",
        category: "home",
        rating: 4.4,
        reviews: 92,
        description: "Powerful liquid detergent for all your laundry needs.",
        features: ["2L Bottle", "Stain Removal", "Fresh Scent", "For All Fabrics"],
        seller: "Clean Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "2 days ago"
      },
      {
        id: "g3",
        name: "Cooking Oil (1L)",
        price: 249,
        originalPrice: 299,
        discount: 17,
        img: "https://placehold.co/300x240/png?text=Cooking+Oil",
        category: "grocery",
        rating: 4.2,
        reviews: 64,
        description: "Pure and healthy cooking oil for everyday use.",
        features: ["1L Bottle", "Cholesterol Free", "High Smoke Point", "Vitamins A&D"],
        seller: "Kitchen Essentials",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "5 hours ago"
      },
      {
        id: "g4",
        name: "Honey (500g)",
        price: 399,
        originalPrice: 499,
        discount: 20,
        img: "https://placehold.co/300x240/png?text=Honey",
        category: "grocery",
        rating: 4.8,
        reviews: 156,
        description: "Pure natural honey with no added sugar or preservatives.",
        features: ["500g Jar", "100% Natural", "No Additives", "Rich in Antioxidants"],
        seller: "Organic Nepal",
        inStock: true,
        delivery: "Free delivery",
        lastBought: "3 hours ago"
      }
    ];

    const servicesProducts = [
      {
        id: "s1",
        name: "Home Cleaning Service",
        price: 1999,
        originalPrice: 2499,
        discount: 20,
        img: "https://placehold.co/300x240/png?text=Cleaning+Service",
        category: "home",
        rating: 4.7,
        reviews: 215,
        description: "Professional home cleaning service for your entire house.",
        features: ["3 Hours", "All Rooms", "Eco-friendly", "Trained Staff"],
        seller: "Clean Home Nepal",
        inStock: true,
        delivery: "Service",
        lastBought: "1 day ago"
      },
      {
        id: "s2",
        name: "Plumbing Service",
        price: 999,
        originalPrice: 1499,
        discount: 33,
        img: "https://placehold.co/300x240/png?text=Plumbing",
        category: "home",
        rating: 4.5,
        reviews: 187,
        description: "Expert plumbing service for leaks, clogs and installations.",
        features: ["1 Hour", "All Plumbing", "24/7 Available", "Certified Plumbers"],
        seller: "Fix It Nepal",
        inStock: true,
        delivery: "Service",
        lastBought: "2 days ago"
      },
      {
        id: "s3",
        name: "Electrician Service",
        price: 1299,
        originalPrice: 1599,
        discount: 19,
        img: "https://placehold.co/300x240/png?text=Electrician",
        category: "home",
        rating: 4.6,
        reviews: 143,
        description: "Professional electrician service for all your electrical needs.",
        features: ["2 Hours", "Wiring & Fixtures", "Safety Checks", "Certified Electrician"],
        seller: "Power Solutions",
        inStock: true,
        delivery: "Service",
        lastBought: "5 hours ago"
      },
      {
        id: "s4",
        name: "AC Servicing",
        price: 1499,
        originalPrice: 1999,
        discount: 25,
        img: "https://placehold.co/300x240/png?text=AC+Service",
        category: "home",
        rating: 4.8,
        reviews: 176,
        description: "Complete AC servicing including cleaning, gas refill and maintenance.",
        features: ["All AC Types", "Gas Refill", "Deep Cleaning", "6 Months Warranty"],
        seller: "Cool Nepal",
        inStock: true,
        delivery: "Service",
        lastBought: "1 day ago"
      }
    ];

    // All categories data
    const categories = [
      {
        id: "electronics",
        name: "Electronics",
        icon: "fas fa-laptop",
        color: "bg-blue-100 text-blue-600",
        subcategories: ["Mobiles", "Laptops", "Headphones", "Speakers", "Smart Watches"]
      },
      {
        id: "fashion",
        name: "Fashion",
        icon: "fas fa-tshirt",
        color: "bg-pink-100 text-pink-600",
        subcategories: ["Men's Clothing", "Women's Clothing", "Footwear", "Accessories", "Watches"]
      },
      {
        id: "home",
        name: "Home & Kitchen",
        icon: "fas fa-home",
        color: "bg-green-100 text-green-600",
        subcategories: ["Furniture", "Kitchenware", "Home Decor", "Bedding", "Storage"]
      },
      {
        id: "beauty",
        name: "Beauty & Personal Care",
        icon: "fas fa-spa",
        color: "bg-purple-100 text-purple-600",
        subcategories: ["Skincare", "Haircare", "Makeup", "Fragrances", "Grooming"]
      },
      {
        id: "sports",
        name: "Sports & Fitness",
        icon: "fas fa-running",
        color: "bg-orange-100 text-orange-600",
        subcategories: ["Fitness Equipment", "Yoga", "Cycling", "Team Sports", "Outdoor"]
      },
      {
        id: "toys",
        name: "Toys & Games",
        icon: "fas fa-gamepad",
        color: "bg-yellow-100 text-yellow-600",
        subcategories: ["Action Figures", "Board Games", "Puzzles", "Outdoor Toys", "Educational"]
      },
      {
        id: "books",
        name: "Books & Stationery",
        icon: "fas fa-book",
        color: "bg-red-100 text-red-600",
        subcategories: ["Fiction", "Non-Fiction", "Academic", "Office Supplies", "Art Supplies"]
      },
      {
        id: "automotive",
        name: "Automotive",
        icon: "fas fa-car",
        color: "bg-indigo-100 text-indigo-600",
        subcategories: ["Car Accessories", "Bike Accessories", "Tools", "Car Care", "Interior"]
      },
      {
        id: "grocery",
        name: "Grocery & Staples",
        icon: "fas fa-shopping-basket",
        color: "bg-teal-100 text-teal-600",
        subcategories: ["Rice & Pulses", "Edible Oils", "Spices", "Dry Fruits", "Snacks"]
      },
      {
        id: "food",
        name: "Food & Beverages",
        icon: "fas fa-utensils",
        color: "bg-amber-100 text-amber-600",
        subcategories: ["Fresh Fruits", "Fresh Vegetables", "Dairy", "Beverages", "Frozen Foods"]
      },
      {
        id: "health",
        name: "Health & Wellness",
        icon: "fas fa-heartbeat",
        color: "bg-rose-100 text-rose-600",
        subcategories: ["Vitamins", "Supplements", "Medical Supplies", "Ayurveda", "Personal Care"]
      },
      {
        id: "services",
        name: "Services",
        icon: "fas fa-concierge-bell",
        color: "bg-cyan-100 text-cyan-600",
        subcategories: ["Home Services", "Repairs", "Beauty Services", "Tutoring", "Event Planning"]
      }
    ];

   // Extended product data and all arrays are same as original code (omitted here for brevity)
    // We'll reuse the same data arrays: featuredProducts, dealsProducts, foodsProducts, groceryProducts, servicesProducts, categories

    // For brevity, I will reuse the same data arrays from the original code here.
    // Please copy the arrays from the original code above and paste here.

    // For this answer, I will only include the new/modified JS code for requested features.

    // User state and DOM elements (reuse from original code)
    let isLoggedIn = false;
    let user = null;
    let cart = [];
    let orders = [];
    let viewedProducts = [];
    let currentLocation = null;

    // DOM Elements
    const featuredProductsGrid = document.getElementById("featuredProductsGrid");
    const dealsProductsGrid = document.getElementById("dealsProductsGrid");
    const recentProductsGrid = document.getElementById("recentProductsGrid");
    const foodsProductsGrid = document.getElementById("foodsProductsGrid");
    const groceryProductsGrid = document.getElementById("groceryProductsGrid");
    const servicesProductsGrid = document.getElementById("servicesProductsGrid");
    const cartContent = document.getElementById("cartContent");
    const ordersContent = document.getElementById("ordersContent");
    const profileContent = document.getElementById("profileContent");
    const productDetailContent = document.getElementById("productDetailContent");
    const categoriesContent = document.querySelector("#categoriesContent .grid");
    const categoriesSlider = document.getElementById("categoriesSlider");
    const scrollLeftBtn = document.getElementById("scrollLeft");
    const scrollRightBtn = document.getElementById("scrollRight");

    // Profile dropdown elements
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const profileBtn = document.getElementById("profileBtn");
    const myOrdersBtn = document.getElementById("myOrdersBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const profileIcon = document.getElementById("profileIcon");
    const profileInitial = document.getElementById("profileInitial");
    const profileChevron = document.getElementById("profileChevron");
    const notificationBtn = document.getElementById("notificationBtn");
    const notificationBadge = document.getElementById("notificationBadge");
    const cartBadge = document.getElementById("cartBadge");

    // Modals
    const loginModal = document.getElementById("loginModal");
    const signupModal = document.getElementById("signupModal");
    const locationModal = document.getElementById("locationModal");
    const productDetailModal = document.getElementById("productDetailModal");
    const orderTrackingModal = document.getElementById("orderTrackingModal");
    const paymentModal = document.getElementById("paymentModal");

    // Location elements
    const locationBtn = document.getElementById("locationBtn");
    const locationText = document.getElementById("locationText");
    const locationInput = document.getElementById("locationInput");
    const detectLocationBtn = document.getElementById("detectLocationBtn");
    const useCurrentLocationBtn = document.getElementById("useCurrentLocation");
    const locationSuggestions = document.getElementById("locationSuggestions");

    // Search elements
    const searchInput = document.getElementById("searchInput");
    const searchSuggestions = document.getElementById("searchSuggestions");
    const searchBarExpanded = document.getElementById("searchBarExpanded");
    const searchInputExpanded = document.getElementById("searchInputExpanded");
    const searchSuggestionsExpanded = document.getElementById("searchSuggestionsExpanded");
    const closeSearchExpandedBtn = document.getElementById("closeSearchExpanded");

    // Navigation
    const navItems = document.querySelectorAll(".nav-item");
    const quickCategories = document.querySelectorAll(".quick-category");
    const contentSections = document.querySelectorAll(".content-section");
    const viewAllButtons = document.querySelectorAll(".view-all-btn");
    const contentWrapper = document.getElementById("contentWrapper");

    // History stack for navigation
    let sectionHistory = ["home"];
    let currentSection = "home";

    // All products combined for search and lookup
    let allProducts = [];

    // Utility functions (reuse from original code)
    function formatPrice(n) {
      return "Rs. " + n.toLocaleString("en-IN");
    }

    function showToast(message, type = "success") {
      const toastContainer = document.getElementById("toastContainer");
      const toast = document.createElement("div");

      let bgColor = "bg-green-500";
      let icon = "fas fa-check-circle";

      if (type === "error") {
        bgColor = "bg-red-500";
        icon = "fas fa-times-circle";
      } else if (type === "warning") {
        bgColor = "bg-yellow-500";
        icon = "fas fa-exclamation-circle";
      } else if (type === "info") {
        bgColor = "bg-blue-500";
        icon = "fas fa-info-circle";
      }

      toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-md shadow-lg flex items-center justify-between`;
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="${icon} mr-2"></i>
          <span>${message}</span>
        </div>
        <button class="close-toast ml-4" aria-label="Close notification">
          <i class="fas fa-times"></i>
        </button>
      `;

      toastContainer.appendChild(toast);

      // Auto remove toast after 5 seconds
      setTimeout(() => {
        toast.classList.add("hide");
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 5000);

      // Close button
      toast.querySelector(".close-toast").addEventListener("click", () => {
        toast.classList.add("hide");
        setTimeout(() => {
          toast.remove();
        }, 300);
      });
    }

    // Render products grid with enhanced UI (reuse from original code)
    function renderProductsGrid(container, products) {
      container.innerHTML = "";

      if (products.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">No products available.</p>
          </div>
        `;
        return;
      }

      products.forEach((p) => {
        const card = document.createElement("article");
        card.setAttribute("role", "group");
        card.setAttribute("tabindex", "0");
        card.className =
          "product-card bg-white rounded-xl shadow-sm cursor-pointer flex flex-col overflow-hidden hover:shadow-md transition-all relative";

        // Badge for discount
        const discountBadge = p.discount
          ? `
          <span class="absolute top-2 left-2 bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
            ${p.discount}% OFF
          </span>
        `
          : "";

        // Rating stars
        const fullStars = Math.floor(p.rating);
        const hasHalfStar = p.rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

        let starsHtml = "";
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="fas fa-star"></i>';
        }
        if (hasHalfStar) {
          starsHtml += '<i class="fas fa-star-half-alt"></i>';
        }
        for (let i = 0; i < emptyStars; i++) {
          starsHtml += '<i class="far fa-star"></i>';
        }

        card.innerHTML = `
          <div class="relative">
            <img src="${p.img}" alt="${p.name}" class="product-image w-full h-40 object-contain bg-gray-100 p-4" loading="lazy" />
            ${discountBadge}
          </div>
          <div class="product-details p-3 flex flex-col flex-grow">
            <h4 class="product-name text-sm mb-1 line-clamp-2 flex-grow">${p.name}</h4>
            <div class="flex items-center mb-1">
              <div class="rating-stars text-xs mr-1">${starsHtml}</div>
              <span class="text-xs text-gray-500">(${p.reviews})</span>
            </div>
            <div class="flex items-center mb-2">
              <p class="product-price font-bold text-primary-color mr-2">${formatPrice(
                p.price
              )}</p>
              ${
                p.originalPrice
                  ? `<p class="product-original-price text-xs text-gray-500 line-through">${formatPrice(
                      p.originalPrice
                    )}</p>`
                  : ""
              }
            </div>
            ${
              p.delivery.includes("Free")
                ? `<p class="text-xs text-success-color mb-2">
                <i class="fas fa-truck mr-1"></i> ${p.delivery}
              </p>`
                : `<p class="text-xs text-gray-500 mb-2">
                <i class="fas fa-truck mr-1"></i> ${p.delivery}
              </p>`
            }
            <div class="product-actions flex justify-between gap-2">
              <button aria-label="Add ${p.name} to cart" 
                      class="add-to-cart flex-1 bg-light-color text-dark-color rounded-md text-xs py-2 hover:bg-accent-color hover:text-white transition-colors focus:outline-none">
                <i class="fas fa-cart-plus mr-1"></i> Add
              </button>
              <button aria-label="Buy ${p.name} now" 
                      class="buy-now flex-1 bg-primary-color text-white rounded-md text-xs py-2 hover:bg-red-700 transition-colors focus:outline-none">
                Buy Now
              </button>
            </div>
          </div>
        `;

        // Attach product id for reference
        card.dataset.productId = p.id;

        // Add click handler to view product details
        card.addEventListener("click", (e) => {
          if (
            !e.target.closest(".add-to-cart") &&
            !e.target.closest(".buy-now")
          ) {
            viewProductDetail(p.id);
          }
        });

        container.appendChild(card);
      });
    }

    // Render categories slider items (clickable)
    function renderCategoriesSlider() {
      categoriesSlider.innerHTML = "";
      categories.forEach((category) => {
        const div = document.createElement("div");
        div.setAttribute("role", "button");
        div.setAttribute("tabindex", "0");
        div.setAttribute("aria-label", `${category.name} category`);
        div.className =
          "category-item flex flex-col items-center justify-center min-w-[90px] h-[110px] bg-white rounded-xl shadow-sm cursor-pointer p-3 flex-shrink-0 hover:shadow-md transition-all";
        div.innerHTML = `
          <div class="w-14 h-14 ${category.color} rounded-full flex items-center justify-center mb-2">
            <i class="${category.icon} text-xl"></i>
          </div>
          <span class="text-xs font-medium text-center">${category.name}</span>
        `;
        div.addEventListener("click", () => {
          navigateToCategory(category.id);
        });
        div.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToCategory(category.id);
          }
        });
        categoriesSlider.appendChild(div);
      });
    }

    // Navigate to category section (show products of that category)
    function navigateToCategory(categoryId) {
      // Find category
      const category = categories.find((c) => c.id === categoryId);
      if (!category) return;

      // Show categories section with filtered products
      navigateToSection("categories");

      // Clear categoriesContent grid and show subcategories and products
      categoriesContent.innerHTML = `
        <h3 class="text-xl font-bold text-dark-color mb-4">${category.name}</h3>
        <div class="mb-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="categorySubcategories"></div>
        <h4 class="text-lg font-semibold text-dark-color mb-3">Products</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="categoryProductsGrid"></div>
      `;

      const subcategoriesContainer = document.getElementById("categorySubcategories");
      const productsContainer = document.getElementById("categoryProductsGrid");

      // Render subcategories clickable
      category.subcategories.forEach((subcat) => {
        const subcatDiv = document.createElement("div");
        subcatDiv.className =
          "bg-white rounded-xl shadow-sm p-4 flex items-center justify-center cursor-pointer hover:shadow-md transition text-center text-sm font-medium";
        subcatDiv.textContent = subcat;
        subcatDiv.setAttribute("tabindex", "0");
        subcatDiv.setAttribute("role", "button");
        subcatDiv.setAttribute("aria-label", `Filter by ${subcat}`);
        subcatDiv.addEventListener("click", () => {
          filterCategoryProducts(categoryId, subcat);
        });
        subcatDiv.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            filterCategoryProducts(categoryId, subcat);
          }
        });
        subcategoriesContainer.appendChild(subcatDiv);
      });

      // Initially show all products of this category
      filterCategoryProducts(categoryId, null);
    }

    // Filter category products by subcategory or show all
    function filterCategoryProducts(categoryId, subcategory) {
      const productsContainer = document.getElementById("categoryProductsGrid");
      let filteredProducts = [];

      // Combine all products
      const allProds = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ];

      filteredProducts = allProds.filter((p) => {
        if (p.category === categoryId) {
          if (!subcategory) return true;
          // Check if subcategory matches any feature or name (simple heuristic)
          return (
            p.features.some((f) =>
              f.toLowerCase().includes(subcategory.toLowerCase())
            ) ||
            p.name.toLowerCase().includes(subcategory.toLowerCase())
          );
        }
        return false;
      });

      if (filteredProducts.length === 0) {
        productsContainer.innerHTML = `
          <div class="col-span-full text-center py-8">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">No products found in this subcategory.</p>
          </div>
        `;
      } else {
        renderProductsGrid(productsContainer, filteredProducts);
      }
    }

    // Navigate to section with sliding animation
    function navigateToSection(sectionId) {
      if (sectionId === "orders" && !isLoggedIn) {
        showToast("Please login to view your orders", "warning");
        return;
      }

      if ((sectionId === "cart" || sectionId === "profile") && !isLoggedIn) {
        showToast("Please login to access this section", "warning");
        return;
      }

      if (sectionId === currentSection) return;

      // Animate sliding left or right
      const currentEl = document.getElementById(currentSection);
      const nextEl = document.getElementById(sectionId);

      if (!nextEl) return;

      // Prepare next element
      nextEl.classList.remove("hidden");
      nextEl.classList.add("block");
      nextEl.style.position = "absolute";
      nextEl.style.top = "0";
      nextEl.style.left = sectionHistory.includes(sectionId)
        ? "-100%"
        : "100%";
      nextEl.style.width = "100%";

      // Animate sliding
      let direction = "left";
      if (sectionHistory.includes(sectionId)) {
        direction = "right";
      }

      // Animate current out
      currentEl.style.position = "absolute";
      currentEl.style.top = "0";
      currentEl.style.left = "0";
      currentEl.style.width = "100%";

      // Animate
      requestAnimationFrame(() => {
        currentEl.style.transition = "left 0.4s ease";
        nextEl.style.transition = "left 0.4s ease";

        if (direction === "left") {
          currentEl.style.left = "-100%";
          nextEl.style.left = "0";
          sectionHistory.push(sectionId);
        } else {
          currentEl.style.left = "100%";
          nextEl.style.left = "0";
          sectionHistory = sectionHistory.filter((s) => s !== currentSection);
        }
      });

      // After animation cleanup
      setTimeout(() => {
        currentEl.classList.add("hidden");
        currentEl.classList.remove("block");
        currentEl.style.position = "";
        currentEl.style.left = "";
        currentEl.style.top = "";
        currentEl.style.width = "";
        currentEl.style.transition = "";

        nextEl.style.position = "";
        nextEl.style.left = "";
        nextEl.style.top = "";
        nextEl.style.width = "";
        nextEl.style.transition = "";

        currentSection = sectionId;

        // Update nav active states
        navItems.forEach((item) => {
          item.classList.remove("text-primary-color");
          item.classList.add("text-gray-600");
          if (item.dataset.section === sectionId) {
            item.classList.add("text-primary-color");
            item.classList.remove("text-gray-600");
            item.setAttribute("aria-current", "page");
          } else {
            item.removeAttribute("aria-current");
          }
        });

        quickCategories.forEach((category) => {
          category.classList.remove("text-primary-color");
          category.classList.add("text-gray-600");
          if (category.dataset.section === sectionId) {
            category.classList.add("text-primary-color");
            category.classList.remove("text-gray-600");
            category.setAttribute("aria-current", "page");
          } else {
            category.removeAttribute("aria-current");
          }
        });

        window.scrollTo(0, 0);
      }, 400);
    }

    // View product detail with related products slider
    function renderProductDetail(product) {
      // Add to viewed products if not already there
      if (!viewedProducts.some((p) => p.id === product.id)) {
        viewedProducts.unshift(product);
        if (viewedProducts.length > 6) viewedProducts.pop();
        updateRecentProducts();
      }

      // Rating stars
      const fullStars = Math.floor(product.rating);
      const hasHalfStar = product.rating % 1 >= 0.5;
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

      let starsHtml = "";
      for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="fas fa-star"></i>';
      }
      if (hasHalfStar) {
        starsHtml += '<i class="fas fa-star-half-alt"></i>';
      }
      for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="far fa-star"></i>';
      }

      // Features list
      const featuresHtml = product.features
        .map(
          (f) => `
        <li class="flex items-start">
          <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
          <span>${f}</span>
        </li>
      `
        )
        .join("");

      // Related products (same category, excluding current)
      const relatedProducts = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ].filter((p) => p.category === product.category && p.id !== product.id);

      productDetailContent.innerHTML = `
        <div class="product-images mb-4">
          <div class="main-image bg-gray-100 rounded-lg overflow-hidden mb-2">
            <img src="${product.img}" alt="${product.name}" class="w-full h-64 object-contain" loading="lazy" />
          </div>
          <div class="thumbnail-images flex gap-2 overflow-x-auto pb-2">
            <div class="thumbnail w-16 h-16 bg-gray-100 rounded border-2 border-primary-color flex-shrink-0">
              <img src="${product.img}" alt="${product.name}" class="w-full h-full object-contain" loading="lazy" />
            </div>
            <div class="thumbnail w-16 h-16 bg-gray-100 rounded border border-gray-200 flex-shrink-0">
              <img src="https://placehold.co/100x100/png?text=Product+Angle" alt="${product.name} alternate view" class="w-full h-full object-contain" loading="lazy" />
            </div>
            <div class="thumbnail w-16 h-16 bg-gray-100 rounded border border-gray-200 flex-shrink-0">
              <img src="https://placehold.co/100x100/png?text=Product+Close" alt="${product.name} close up" class="w-full h-full object-contain" loading="lazy" />
            </div>
          </div>
        </div>

        <div class="product-info mb-6">
          <h1 class="text-xl font-bold text-dark-color mb-2">${product.name}</h1>
          <div class="flex items-center mb-3">
            <div class="rating-stars text-sm mr-2">${starsHtml}</div>
            <span class="text-sm text-gray-500 mr-3">${product.rating} (${product.reviews} reviews)</span>
            <span class="text-sm text-success-color">
              <i class="fas fa-check-circle mr-1"></i> ${
                product.inStock ? "In Stock" : "Out of Stock"
              }
            </span>
          </div>

          <div class="price-section bg-gray-50 p-3 rounded-lg mb-4">
            ${
              product.originalPrice
                ? `<div class="text-xs text-gray-500 line-through mb-1">${formatPrice(
                    product.originalPrice
                  )}</div>`
                : ""
            }
            <div class="flex items-center">
              <div class="text-2xl font-bold text-primary-color mr-3">${formatPrice(
                product.price
              )}</div>
              ${
                product.discount
                  ? `<span class="bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
                Save ${product.discount}%
              </span>`
                  : ""
              }
            </div>
            ${
              product.delivery.includes("Free")
                ? `<div class="text-sm text-success-color mt-2">
                <i class="fas fa-truck mr-1"></i> ${product.delivery}
              </div>`
                : `<div class="text-sm text-gray-600 mt-2">
                <i class="fas fa-truck mr-1"></i> ${product.delivery}
              </div>`
            }
          </div>

          <div class="seller-info flex items-center mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
              <i class="fas fa-store text-gray-500"></i>
            </div>
            <div>
              <div class="text-sm font-medium">Sold by ${product.seller}</div>
              <div class="text-xs text-gray-500">${product.lastBought}</div>
            </div>
          </div>

          <div class="product-actions flex gap-3 mb-6">
            <button class="add-to-cart flex-1 bg-light-color text-dark-color rounded-lg py-3 text-sm font-medium hover:bg-accent-color hover:text-white transition-colors focus:outline-none">
              <i class="fas fa-cart-plus mr-2"></i> Add to Cart
            </button>
            <button class="buy-now flex-1 bg-primary-color text-white rounded-lg py-3 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none">
              Buy Now
            </button>
          </div>
        </div>

        <div class="product-details mb-6">
          <h2 class="text-lg font-bold text-dark-color mb-3">Product Details</h2>
          <p class="text-gray-700 mb-4">${product.description}</p>

          <h3 class="text-md font-semibold text-dark-color mb-2">Features</h3>
          <ul class="features-list space-y-2 mb-4">
            ${featuresHtml}
          </ul>
        </div>

        <div class="reviews-section">
          <h2 class="text-lg font-bold text-dark-color mb-3">Customer Reviews</h2>
          <div class="review bg-gray-50 p-3 rounded-lg mb-3">
            <div class="flex items-center mb-2">
              <div class="w-8 h-8 rounded-full bg-gray-300 mr-2"></div>
              <div>
                <div class="text-sm font-medium">Ramesh Shrestha</div>
                <div class="rating-stars text-xs">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star-half-alt"></i>
                </div>
              </div>
            </div>
            <p class="text-sm text-gray-700">
              Great product! Works perfectly as described. Delivery was fast too.
            </p>
            <div class="text-xs text-gray-500 mt-1">Reviewed on 12 May 2023</div>
          </div>

          <div class="review bg-gray-50 p-3 rounded-lg">
            <div class="flex items-center mb-2">
              <div class="w-8 h-8 rounded-full bg-gray-300 mr-2"></div>
              <div>
                <div class="text-sm font-medium">Sita Gurung</div>
                <div class="rating-stars text-xs">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
              </div>
            </div>
            <p class="text-sm text-gray-700">
              Good quality but delivery took longer than expected.
            </p>
            <div class="text-xs text-gray-500 mt-1">Reviewed on 5 May 2023</div>
          </div>

          <button
            class="w-full mt-4 text-primary-color text-sm font-medium hover:underline focus:outline-none"
            type="button"
          >
            View All Reviews
          </button>
        </div>

        <div class="related-products mt-8">
          <h3 class="text-lg font-semibold mb-3">Related Products</h3>
          <div class="related-products-slider" tabindex="0" aria-label="Related products slider">
            ${relatedProducts
              .map(
                (p) => `
              <div class="related-product-card" role="button" tabindex="0" aria-label="View details of ${p.name}" data-product-id="${p.id}">
                <img src="${p.img}" alt="${p.name}" loading="lazy" />
                <div class="text-xs font-medium text-center">${p.name}</div>
                <div class="text-xs text-primary-color font-semibold">${formatPrice(p.price)}</div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;

      // Add event listeners for add to cart and buy now buttons
      productDetailContent.querySelector(".add-to-cart").addEventListener("click", () => {
        addToCart(product.id);
      });

      productDetailContent.querySelector(".buy-now").addEventListener("click", () => {
        buyNow(product.id);
      });

      // Add event listeners for related products
      productDetailContent.querySelectorAll(".related-product-card").forEach((card) => {
        card.addEventListener("click", () => {
          const pid = card.dataset.productId;
          viewProductDetail(pid);
        });
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            const pid = card.dataset.productId;
            viewProductDetail(pid);
          }
        });
      });
    }

    // View product detail
    function viewProductDetail(productId) {
      const product = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ].find((p) => p.id === productId);

      if (product) {
        renderProductDetail(product);
        navigateToSection("productDetail");
        productDetailModal.classList.remove("hidden");
        productDetailModal.focus();
      }
    }

    // Update recent products display
    function updateRecentProducts() {
      if (viewedProducts.length === 0) {
        recentProductsGrid.innerHTML = `
          <div class="col-span-full text-center py-8">
            <i class="fas fa-history text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">Your recently viewed products will appear here.</p>
          </div>
        `;
        return;
      }

      renderProductsGrid(recentProductsGrid, viewedProducts);
    }

    // Update cart badge
    function updateCartBadge() {
      const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);

      if (totalItems > 0) {
        cartBadge.textContent = totalItems;
        cartBadge.classList.remove("hidden");
      } else {
        cartBadge.classList.add("hidden");
      }
    }

    // Add to cart function
    function addToCart(productId) {
      if (!isLoggedIn) {
        showToast("Please login to add items to your cart", "warning");
        loginModal.classList.remove("hidden");
        loginModal.focus();
        return;
      }

      const product = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ].find((p) => p.id === productId);

      if (!product) return;

      const existing = cart.find((c) => c.productId === productId);

      if (existing) {
        existing.quantity++;
      } else {
        cart.push({ productId, quantity: 1 });
      }

      updateCartDisplay();
      updateCartBadge();
      showToast(`${product.name} added to cart`, "success");
    }

    // Buy now function
    function buyNow(productId) {
      if (!isLoggedIn) {
        showToast("Please login to buy items", "warning");
        loginModal.classList.remove("hidden");
        loginModal.focus();
        return;
      }

      const product = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ].find((p) => p.id === productId);

      if (!product) return;

      // Clear cart and add only this product
      cart = [{ productId, quantity: 1 }];
      updateCartDisplay();
      updateCartBadge();

      if (currentLocation) {
        paymentModal.classList.remove("hidden");
        paymentModal.focus();
      } else {
        showToast("Please select your delivery location first", "warning");
        locationModal.classList.remove("hidden");
        locationModal.focus();
      }
    }

    // Update cart display (reuse from original code with minor fixes)
    function updateCartDisplay() {
      if (!isLoggedIn) {
        cartContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-lg font-medium text-gray-700 mb-2">Your cart is empty</h3>
            <p class="text-gray-500 mb-4">Login to view items in your cart</p>
            <button class="bg-primary-color text-white rounded-md px-6 py-2 font-medium hover:bg-red-700 transition-colors" id="loginFromCart" type="button">
              Login
            </button>
          </div>
        `;

        document.getElementById("loginFromCart").addEventListener("click", () => {
          loginModal.classList.remove("hidden");
          loginModal.focus();
        });

        return;
      }

      if (cart.length === 0) {
        cartContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-lg font-medium text-gray-700 mb-2">Your cart is empty</h3>
            <p class="text-gray-500 mb-4">Add some products to get started</p>
            <button class="bg-primary-color text-white rounded-md px-6 py-2 font-medium hover:bg-red-700 transition-colors" data-section="home" type="button">
              Continue Shopping
            </button>
          </div>
        `;

        cartContent.querySelector("button").addEventListener("click", () => {
          navigateToSection("home");
        });

        return;
      }

      // Render cart items
      cartContent.innerHTML = "";

      cart.forEach((item) => {
        const product = [
          ...featuredProducts,
          ...dealsProducts,
          ...foodsProducts,
          ...groceryProducts,
          ...servicesProducts,
        ].find((p) => p.id === item.productId);

        if (!product) return;

        const div = document.createElement("div");
        div.className = "cart-item flex bg-white rounded-xl shadow-sm p-3 mb-3";
        div.setAttribute("role", "group");
        div.setAttribute("tabindex", "0");
        div.innerHTML = `
          <img src="${product.img}" alt="${product.name}" class="cart-item-img w-20 h-20 object-contain rounded-md border border-gray-200 mr-3" loading="lazy" />
          <div class="cart-item-details flex flex-col flex-grow justify-between">
            <div>
              <h4 class="cart-item-name text-sm mb-1 line-clamp-2">${product.name}</h4>
              <p class="cart-item-price font-bold text-primary-color mb-2">${formatPrice(product.price)}</p>
            </div>
            <div class="cart-item-actions flex justify-between items-center">
              <div aria-label="Quantity controls" class="quantity-control flex items-center space-x-2">
                <button aria-label="Decrease quantity" class="quantity-btn minus w-6 h-6 border border-gray-300 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 focus:outline-none" type="button">-</button>
                <span aria-atomic="true" aria-live="polite" class="quantity text-sm select-none">${item.quantity}</span>
                <button aria-label="Increase quantity" class="quantity-btn plus w-6 h-6 border border-gray-300 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 focus:outline-none" type="button">+</button>
              </div>
              <button aria-label="Remove ${product.name} from cart" class="remove-item text-red-600 hover:text-red-800 focus:outline-none" type="button">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;

        div.querySelector(".quantity-btn.plus").addEventListener("click", () => {
          item.quantity++;
          updateCartDisplay();
          updateCartBadge();
          showToast(`${product.name} quantity updated`, "success");
        });

        div.querySelector(".quantity-btn.minus").addEventListener("click", () => {
          if (item.quantity > 1) {
            item.quantity--;
            updateCartDisplay();
            updateCartBadge();
            showToast(`${product.name} quantity updated`, "success");
          } else {
            if (confirm(`Remove ${product.name} from cart?`)) {
              cart = cart.filter((c) => c.productId !== item.productId);
              updateCartDisplay();
              updateCartBadge();
              showToast(`${product.name} removed from cart`, "info");
            }
          }
        });

        div.querySelector(".remove-item").addEventListener("click", () => {
          if (confirm(`Remove ${product.name} from cart?`)) {
            cart = cart.filter((c) => c.productId !== item.productId);
            updateCartDisplay();
            updateCartBadge();
            showToast(`${product.name} removed from cart`, "info");
          }
        });

        cartContent.appendChild(div);
      });

      // Cart summary
      const subtotal = cart.reduce((acc, item) => {
        const p = [
          ...featuredProducts,
          ...dealsProducts,
          ...foodsProducts,
          ...groceryProducts,
          ...servicesProducts,
        ].find((prod) => prod.id === item.productId);
        return acc + (p ? p.price * item.quantity : 0);
      }, 0);

      const deliveryCharge = subtotal > 999 ? 0 : 100;
      const tax = Math.round(subtotal * 0.13); // 13% VAT
      const total = subtotal + deliveryCharge + tax;

      const summary = document.createElement("section");
      summary.className = "cart-summary bg-white rounded-xl shadow-sm p-4 mt-4";
      summary.innerHTML = `
        <h3 class="font-semibold text-dark-color mb-3">Order Summary</h3>
        <div class="summary-row flex justify-between mb-2 text-sm">
          <span class="text-gray-600">Subtotal</span>
          <span>${formatPrice(subtotal)}</span>
        </div>
        <div class="summary-row flex justify-between mb-2 text-sm">
          <span class="text-gray-600">Delivery Charge</span>
          <span>${
            deliveryCharge === 0
              ? '<span class="text-success-color">Free</span>'
              : formatPrice(deliveryCharge)
          }</span>
        </div>
        <div class="summary-row flex justify-between mb-2 text-sm">
          <span class="text-gray-600">Tax (13%)</span>
          <span>${formatPrice(tax)}</span>
        </div>
        <div class="summary-row summary-total flex justify-between border-t border-gray-200 pt-2 font-bold text-lg mt-3">
          <span>Total</span>
          <span>${formatPrice(total)}</span>
        </div>
        <button aria-label="Proceed to checkout" class="checkout-btn w-full mt-4 bg-primary-color text-white rounded-md py-3 text-lg font-semibold hover:bg-red-700 transition-colors focus:outline-none" type="button" id="proceedCheckoutBtn">
          Proceed to Checkout
        </button>
      `;

      cartContent.appendChild(summary);

      summary.querySelector("#proceedCheckoutBtn").addEventListener("click", () => {
        if (currentLocation) {
          paymentModal.classList.remove("hidden");
          paymentModal.focus();
        } else {
          showToast("Please select your delivery location first", "warning");
          locationModal.classList.remove("hidden");
          locationModal.focus();
        }
      });
    }







    

    // Initialize the app
    function init() {
      // Combine all products for search
      allProducts = [
        ...featuredProducts,
        ...dealsProducts,
        ...foodsProducts,
        ...groceryProducts,
        ...servicesProducts,
      ];

      // Render initial products and categories
      renderProductsGrid(featuredProductsGrid, featuredProducts);
      renderProductsGrid(dealsProductsGrid, dealsProducts);
      renderProductsGrid(foodsProductsGrid, foodsProducts);
      renderProductsGrid(groceryProductsGrid, groceryProducts);
      renderProductsGrid(servicesProductsGrid, servicesProducts);
      updateRecentProducts();
      renderCategoriesSlider();

      // Initialize UI state
      updateCartDisplay();
      updateOrdersDisplay();
      updateProfileDisplay();
      updateUIAfterLogout();
      updateCartBadge();

      // Set up event listeners
      setupEventListeners();

      // Initialize Google Maps if available
      if (typeof google !== "undefined") {
        initAutocomplete();
      }
    }

    // Setup event listeners (reuse and extend original code)
    function setupEventListeners() {
      // Profile dropdown toggle
      profileIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("hidden");
        profileChevron.classList.toggle("transform");
        profileChevron.classList.toggle("rotate-180");
        profileIcon.setAttribute(
          "aria-expanded",
          dropdownMenu.classList.contains("hidden") ? "false" : "true"
        );
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        profileChevron.classList.remove("transform");
        profileChevron.classList.remove("rotate-180");
        profileIcon.setAttribute("aria-expanded", "false");
      });

      // Login/signup/profile/logout button handlers
      loginBtn.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        loginModal.classList.remove("hidden");
        loginModal.classList.add("show");
        loginModal.focus();
      });

      signupBtn.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        signupModal.classList.remove("hidden");
        signupModal.classList.add("show");
        signupModal.focus();
      });

      profileBtn.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        navigateToSection("profile");
      });

      myOrdersBtn.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        navigateToSection("orders");
      });

      logoutBtn.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        isLoggedIn = false;
        user = null;
        cart = [];
        updateUIAfterLogout();
        showToast("You have been logged out", "info");
        navigateToSection("home");
      });

      // Show signup/login modal toggles inside modals
      document.getElementById("showSignup").addEventListener("click", (e) => {
        e.preventDefault();
        loginModal.classList.add("hidden");
        loginModal.classList.remove("show");
        signupModal.classList.remove("hidden");
        signupModal.classList.add("show");
        signupModal.focus();
      });

      document.getElementById("showLogin").addEventListener("click", (e) => {
        e.preventDefault();
        signupModal.classList.add("hidden");
        signupModal.classList.remove("show");
        loginModal.classList.remove("hidden");
        loginModal.classList.add("show");
        loginModal.focus();
      });

      // Close modals on close button click
      document.querySelectorAll(".close-modal").forEach((btn) => {
        btn.addEventListener("click", () => {
          const modal = btn.closest(".modal");
          modal.classList.add("hidden");
          modal.classList.remove("show");
        });




      });

      // Close modals on outside click
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.add("hidden");
            modal.classList.remove("show");
          }
        });
      });


      // Terms & Conditions Popup
document.querySelectorAll('.terms-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('termsPopup').classList.remove('hidden');
  });
});

document.querySelectorAll('.close-terms').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('termsPopup').classList.add('hidden');
  });
});

// Privacy Policy Popup
document.querySelectorAll('.privacy-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('privacyPopup').classList.remove('hidden');
  });
});

document.querySelectorAll('.close-privacy').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('privacyPopup').classList.add('hidden');
  });
});

// Social Login Functionality
document.querySelectorAll('.social-login-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const provider = this.getAttribute('data-provider');
    const spinner = document.createElement('div');
    spinner.className = 'inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent';
    this.innerHTML = '';
    this.appendChild(spinner);
    
    // Simulate API call
    setTimeout(() => {
      alert(`Redirecting to ${provider} login...`);
      // In real implementation, you would use:
      // if(provider === 'google') { /* Google OAuth API */ }
      // if(provider === 'facebook') { /* Facebook Login API */ }
      // if(provider === 'whatsapp') { /* WhatsApp API */ }
    }, 1000);
  });
});

// Close modals when clicking outside
document.querySelectorAll('[id$="Popup"]').forEach(popup => {
  popup.addEventListener('click', (e) => {
    if(e.target === popup) {
      popup.classList.add('hidden');
    }
  });
});

      // Login form submit
      document.getElementById("loginSubmit").addEventListener("click", () => {
        const phone = document.getElementById("loginPhone").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        if (!phone || !password) {
          showToast("Please enter phone number and password", "error");
          return;
        }

        if (phone.length !== 10 || !/^\d+$/.test(phone)) {
          showToast("Please enter a valid 10-digit phone number", "error");
          return;
        }

        if (password.length < 6) {
          showToast("Password must be at least 6 characters", "error");
          return;
        }

        // Simulate login success
        toggleLoading(document.getElementById("loginSubmit"), true);

        setTimeout(() => {
          isLoggedIn = true;
          user = {
            name: "John Doe",
            phone: phone,
            email: "johndoe@example.com",
            address: currentLocation || "Kathmandu, Nepal",
            joinedOn: "15 Jan 2023",
          };

          profileInitial.textContent = user.name.charAt(0);
          loginModal.classList.add("hidden");
          loginModal.classList.remove("show");
          updateUIAfterLogin();
          showToast("Login successful!", "success");
          navigateToSection("home");
          toggleLoading(document.getElementById("loginSubmit"), false);
        }, 1500);
      });

      // Signup form submit
      document.getElementById("signupSubmit").addEventListener("click", () => {
        const name = document.getElementById("signupName").value.trim();
        const phone = document.getElementById("signupPhone").value.trim();
        const email = document.getElementById("signupEmail").value.trim();
        const password = document.getElementById("signupPassword").value.trim();
        const confirmPassword = document
          .getElementById("signupConfirmPassword")
          .value.trim();

        if (!name || !phone || !password || !confirmPassword) {
          showToast("Please fill in all required fields", "error");
          return;
        }

        if (phone.length !== 10 || !/^\d+$/.test(phone)) {
          showToast("Please enter a valid 10-digit phone number", "error");
          return;
        }

        if (password.length < 6) {
          showToast("Password must be at least 6 characters", "error");
          return;
        }

        if (password !== confirmPassword) {
          showToast("Passwords do not match", "error");
          return;
        }

        if (email && !/^\S+@\S+\.\S+$/.test(email)) {
          showToast("Please enter a valid email address", "error");
          return;
        }

        if (!document.getElementById("termsAgreement").checked) {
          showToast("Please agree to the terms and conditions", "error");
          return;
        }

        // Simulate signup success
        toggleLoading(document.getElementById("signupSubmit"), true);

        setTimeout(() => {
          isLoggedIn = true;
          user = {
            name: name,
            phone: phone,
            email: email || null,
            address: currentLocation || null,
            joinedOn: new Date().toLocaleDateString("en-GB", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            }),
          };

          profileInitial.textContent = user.name.charAt(0);
          signupModal.classList.add("hidden");
          signupModal.classList.remove("show");
          updateUIAfterLogin();
          showToast("Account created successfully!", "success");
          navigateToSection("home");
          toggleLoading(document.getElementById("signupSubmit"), false);
        }, 1500);
      });

      // Add to cart and buy now handlers (delegated)
      document.body.addEventListener("click", (e) => {
        if (e.target.closest(".add-to-cart")) {
          const card = e.target.closest(".product-card");
          if (!card) return;
          const productId = card.dataset.productId;
          addToCart(productId);
        }

        if (e.target.closest(".buy-now")) {
          const card = e.target.closest(".product-card");
          if (!card) return;
          const productId = card.dataset.productId;
          buyNow(productId);
        }
      });

      // Location modal open
      locationBtn.addEventListener("click", () => {
        locationModal.classList.remove("hidden");
        locationModal.focus();
        locationInput.focus();
      });

      // Location suggestions click
      locationSuggestions.querySelectorAll(".location-item").forEach((item) => {
        item.addEventListener("click", () => {
          currentLocation = item.querySelector("div > div").textContent;
          locationText.textContent = currentLocation;
          locationModal.classList.add("hidden");

          if (user) {
            user.address = currentLocation;
          }

          showToast(`Location set to ${currentLocation}`, "success");
        });

        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            item.click();
          }
        });
      });

      // Use current location button
      useCurrentLocationBtn.addEventListener("click", () => {
        if (currentLocation) {
          locationText.textContent = currentLocation;
          locationModal.classList.add("hidden");
          showToast(`Location set to ${currentLocation}`, "success");
        } else {
          detectLocation();
        }
      });

      // View all buttons
      viewAllButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const section = button.dataset.section;
          if (section === "categories") {
            navigateToSection("categories");
          } else {
            showToast(`View all ${section} products`, "info");
          }
        });
      });

     

      // Navigation items
      navItems.forEach((item) => {
        item.addEventListener("click", () => {
          navigateToSection(item.dataset.section);
        });

        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToSection(item.dataset.section);
          }
        });
      });

      // Quick categories
      quickCategories.forEach((item) => {
        item.addEventListener("click", () => {
          navigateToSection(item.dataset.section);
        });

        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToSection(item.dataset.section);
          }
        });
      });

      // Categories slider scroll buttons
      scrollLeftBtn.addEventListener("click", () => {
        categoriesSlider.scrollBy({ left: -200, behavior: "smooth" });
        setTimeout(updateScrollButtons, 300);
      });

      scrollRightBtn.addEventListener("click", () => {
        categoriesSlider.scrollBy({ left: 200, behavior: "smooth" });
        setTimeout(updateScrollButtons, 300);
      });

      function updateScrollButtons() {
        if (categoriesSlider.scrollLeft <= 0) {
          scrollLeftBtn.classList.add("hidden");
        } else {
          scrollLeftBtn.classList.remove("hidden");
        }

        if (
          categoriesSlider.scrollLeft >=
          categoriesSlider.scrollWidth - categoriesSlider.clientWidth - 1
        ) {
          scrollRightBtn.classList.add("hidden");
        } else {
          scrollRightBtn.classList.remove("hidden");
        }
      }

      categoriesSlider.addEventListener("scroll", updateScrollButtons);
      updateScrollButtons();

      // Search bar click to open expanded search
      const searchBar = document.getElementById("searchBar");
      searchBar.addEventListener("click", () => {
        openSearchExpanded();
      });
      searchBar.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openSearchExpanded();
        }
      });

      // Search expanded close button
      closeSearchExpandedBtn.addEventListener("click", () => {
        closeSearchExpanded();
      });

      // Search expanded input event
      searchInputExpanded.addEventListener("input", () => {
        const val = searchInputExpanded.value.trim().toLowerCase();

        if (!val) {
          searchSuggestionsExpanded.innerHTML = "";
          return;
        }

        const matches = allProducts.filter(
          (p) =>
            p.name.toLowerCase().includes(val) ||
            p.category.toLowerCase().includes(val)
        );

        if (matches.length === 0) {
          searchSuggestionsExpanded.innerHTML = `
            <div class="text-gray-500 cursor-default select-none p-4">
              No results found for "${val}"
            </div>
          `;
        } else {
          searchSuggestionsExpanded.innerHTML = matches
            .slice(0, 10)
            .map(
              (p) => `
              <div role="option" tabindex="0" data-product-id="${p.id}" class="search-result-card">
                <img src="${p.img}" alt="${p.name}" />
                <div class="text-sm font-medium">${p.name}</div>
                <div class="text-xs text-gray-500">${p.category}</div>
              </div>
            `
            )
            .join("");
        }
      });

      // Click on expanded search suggestion
      searchSuggestionsExpanded.addEventListener("click", (e) => {
        if (e.target.closest("div[data-product-id]")) {
          const productId = e.target.closest("div[data-product-id]").dataset.productId;
          const product = allProducts.find((p) => p.id === productId);

          if (product) {
            viewProductDetail(product.id);
            closeSearchExpanded();
          }
        }
        
      });

      // Keyboard navigation in expanded search suggestions
      let selectedSuggestionIndex = -1;
      searchInputExpanded.addEventListener("keydown", (e) => {
        const options = [...searchSuggestionsExpanded.querySelectorAll("div[role='option']")];
        if (options.length === 0) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedSuggestionIndex = (selectedSuggestionIndex + 1) % options.length;
          updateSuggestionHighlightExpanded(options);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedSuggestionIndex = (selectedSuggestionIndex - 1 + options.length) % options.length;
          updateSuggestionHighlightExpanded(options);
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (selectedSuggestionIndex >= 0 && options[selectedSuggestionIndex]) {
            options[selectedSuggestionIndex].click();
          }
        } else if (e.key === "Escape") {
          closeSearchExpanded();
        }
      });

      function updateSuggestionHighlightExpanded(options) {
        options.forEach((opt, i) => {
          if (i === selectedSuggestionIndex) {
            opt.classList.add("active");
            opt.scrollIntoView({ block: "nearest" });
          } else {
            opt.classList.remove("active");
          }
        });
      }

      // Close expanded search on outside click
      document.addEventListener("click", (e) => {
        if (
          !searchBarExpanded.contains(e.target) &&
          !searchBar.contains(e.target)
        ) {
          closeSearchExpanded();
        }
      });

      // Navigation items keyboard accessibility
      navItems.forEach((item) => {
        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToSection(item.dataset.section);
          }
        });
      });

      // Quick categories keyboard accessibility
      quickCategories.forEach((item) => {
        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            navigateToSection(item.dataset.section);
          }
        });
      });

      // Back button behavior
      window.addEventListener("popstate", () => {
        if (sectionHistory.length > 1) {
          sectionHistory.pop();
          const prevSection = sectionHistory[sectionHistory.length - 1];
          navigateToSection(prevSection);
        } else {
          if (confirm("Do you want to exit Nepal Mart?")) {
            window.close();
          } else {
            history.pushState(null, null, window.location.href);
          }
        }
      });
    }

    // Open search expanded popup
    function openSearchExpanded() {
      searchBarExpanded.classList.add("active");
      searchInputExpanded.value = "";
      searchSuggestionsExpanded.innerHTML = "";
      searchInputExpanded.focus();
    }

    // Close search expanded popup
    function closeSearchExpanded() {
      searchBarExpanded.classList.remove("active");
      searchInputExpanded.value = "";
      searchSuggestionsExpanded.innerHTML = "";
      searchInputExpanded.blur();
    }

    // Update UI after login
    function updateUIAfterLogin() {
      loginBtn.classList.add("hidden");
      signupBtn.classList.add("hidden");
      profileBtn.classList.remove("hidden");
      myOrdersBtn.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");

      updateCartDisplay();
      updateOrdersDisplay();
      updateProfileDisplay();
      updateCartBadge();

      // Show notifications badge
      notificationBadge.classList.remove("hidden");
    }

    // Update UI after logout
    function updateUIAfterLogout() {
      loginBtn.classList.remove("hidden");
      signupBtn.classList.remove("hidden");
      profileBtn.classList.add("hidden");
      myOrdersBtn.classList.add("hidden");
      logoutBtn.classList.add("hidden");

      cartContent.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
          <p class="text-gray-500">Please login to add products to your cart.</p>
        </div>
      `;

      ordersContent.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
          <p class="text-gray-500">Please login and place orders to see your order history.</p>
        </div>
      `;

      profileContent.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-user text-4xl text-gray-300 mb-3"></i>
          <p class="text-gray-500">Please login to view your profile.</p>
        </div>
      `;

      // Hide notifications badge
      notificationBadge.classList.add("hidden");
    }

    // Update orders display (reuse from original code)
    function updateOrdersDisplay() {
      if (!isLoggedIn) {
        ordersContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-lg font-medium text-gray-700 mb-2">No orders yet</h3>
            <p class="text-gray-500 mb-4">Login to view your order history</p>
            <button class="bg-primary-color text-white rounded-md px-6 py-2 font-medium hover:bg-red-700 transition-colors" id="loginFromOrders" type="button">
              Login
            </button>
          </div>
        `;

        document.getElementById("loginFromOrders").addEventListener("click", () => {
          loginModal.classList.remove("hidden");
          loginModal.focus();
        });

        return;
      }

      if (orders.length === 0) {
        ordersContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-lg font-medium text-gray-700 mb-2">No orders yet</h3>
            <p class="text-gray-500 mb-4">Start shopping to see your orders here</p>
            <button class="bg-primary-color text-white rounded-md px-6 py-2 font-medium hover:bg-red-700 transition-colors" data-section="home" type="button">
              Start Shopping
            </button>
          </div>
        `;

        ordersContent.querySelector("button").addEventListener("click", () => {
          navigateToSection("home");
        });

        return;
      }

      ordersContent.innerHTML = "";

      orders.forEach((order) => {
        const orderCard = document.createElement("article");
        orderCard.className = "order-card bg-white rounded-xl shadow-sm p-4 mb-4";
        orderCard.setAttribute("role", "region");
        orderCard.setAttribute("tabindex", "0");

        // Status badge color
        let statusColor = "bg-yellow-100 text-yellow-800";
        if (order.status === "Delivered") {
          statusColor = "bg-green-100 text-green-800";
        } else if (order.status === "Cancelled") {
          statusColor = "bg-red-100 text-red-800";
        } else if (order.status === "Shipped") {
          statusColor = "bg-blue-100 text-blue-800";
        }

        orderCard.innerHTML = `
          <header class="order-header flex justify-between border-b border-gray-200 pb-2 mb-3">
            <div>
              <h4 class="font-semibold" id="order${order.id}Label">Order #${order.id}</h4>
              <p class="text-xs text-gray-500">Placed on ${order.date}</p>
            </div>
            <span class="order-status ${statusColor} rounded-full px-3 py-1 text-xs font-semibold">
              ${order.status}
            </span>
          </header>
          <div aria-label="Products in order #${order.id}" class="order-products flex gap-3 overflow-x-auto pb-3 mb-3">
            ${order.products
              .map(
                (p) => `
                  <div class="flex-shrink-0 w-20">
                    <img src="${p.img}" alt="${p.name}" class="order-product-img w-full h-20 object-contain rounded-md border border-gray-200" loading="lazy" />
                    <p class="text-xs text-gray-700 truncate mt-1">${p.name}</p>
                  </div>
                `
              )
              .join("")}
          </div>
          <footer class="order-footer flex justify-between items-center border-t border-gray-200 pt-2">
            <div>
              <span class="order-total font-bold">Total: ${formatPrice(order.total)}</span>
              ${
                order.deliveryDate
                  ? `<p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-truck mr-1"></i> Expected by ${order.deliveryDate}
                </p>`
                  : ""
              }
            </div>
            <div class="order-actions flex gap-2">
              <button aria-label="Track order #${order.id}" class="order-btn track bg-light-color text-dark-color border border-light-color rounded-md text-xs py-1 px-3 hover:bg-accent-color hover:text-white transition-colors focus:outline-none" type="button">
                Track
              </button>
              ${
                order.status === "Pending"
                  ? `<button aria-label="Cancel order #${order.id}" class="order-btn cancel bg-white text-primary-color border border-primary-color rounded-md text-xs py-1 px-3 hover:bg-primary-color hover:text-white transition-colors focus:outline-none" type="button">
                  Cancel
                </button>`
                  : ""
              }
            </div>
          </footer>
        `;

        ordersContent.appendChild(orderCard);

        // Add event listeners for order actions
        orderCard.querySelector(".order-btn.track").addEventListener("click", () => {
          trackOrder(order.id);
        });

        if (order.status === "Pending") {
          orderCard.querySelector(".order-btn.cancel").addEventListener("click", () => {
            if (confirm("Are you sure you want to cancel this order?")) {
              order.status = "Cancelled";
              updateOrdersDisplay();
              showToast(`Order #${order.id} has been cancelled`, "info");
            }
          });
        }
      });
    }

    // Track order (reuse from original code)
    function trackOrder(orderId) {
      const order = orders.find((o) => o.id === orderId);
      if (!order) return;

      const trackingSteps = [
        { status: "Order Placed", date: order.date, completed: true },
        {
          status: "Processing",
          date: new Date(new Date(order.date).getTime() + 3600000).toLocaleDateString("en-GB"),
          completed: order.status !== "Pending",
        },
        {
          status: "Shipped",
          date: new Date(new Date(order.date).getTime() + 86400000).toLocaleDateString("en-GB"),
          completed: ["Shipped", "Delivered"].includes(order.status),
        },
        { status: "Delivered", date: order.deliveryDate, completed: order.status === "Delivered" },
      ];

      const trackingHtml = trackingSteps
        .map(
          (step, i) => `
        <div class="flex items-start mb-4">
          <div class="flex-shrink-0 mr-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center ${
              step.completed ? "bg-green-500 text-white" : "bg-gray-200 text-gray-600"
            }">
              <i class="fas fa-${step.completed ? "check" : "clock"}"></i>
            </div>
            ${
              i !== trackingSteps.length - 1
                ? `<div class="h-10 w-0.5 mx-auto ${
                    step.completed ? "bg-green-500" : "bg-gray-200"
                  }"></div>`
                : ""
            }
          </div>
          <div class="pt-1">
            <h4 class="text-sm font-medium ${
              step.completed ? "text-gray-900" : "text-gray-500"
            }">${step.status}</h4>
            <p class="text-xs text-gray-500">${step.date}</p>
          </div>
        </div>
      `
        )
        .join("");

      document.getElementById("orderTrackingModalContent").innerHTML = `
        <div class="mb-4">
          <h4 class="font-medium text-gray-700 mb-1">Order #${order.id}</h4>
          <p class="text-sm text-gray-500">Placed on ${order.date}</p>
        </div>

        <div class="tracking-steps mb-6">
          ${trackingHtml}
        </div>

        <div class="delivery-address bg-gray-50 p-3 rounded-lg mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Delivery Address</h4>
          <p class="text-sm text-gray-600">${user.address || "No address specified"}</p>
        </div>

        <div class="flex justify-between items-center">
          <span class="font-bold">Total: ${formatPrice(order.total)}</span>
          <button class="text-primary-color text-sm font-medium hover:underline focus:outline-none" type="button">
            <i class="fas fa-question-circle mr-1"></i> Need Help?
          </button>
        </div>
      `;

      orderTrackingModal.classList.remove("hidden");
      orderTrackingModal.focus();
    }

    // Update profile display (reuse from original code)
    function updateProfileDisplay() {
      if (!isLoggedIn) {
        profileContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-user-circle text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-lg font-medium text-gray-700 mb-2">Profile</h3>
            <p class="text-gray-500 mb-4">Login to view your profile</p>
            <button class="bg-primary-color text-white rounded-md px-6 py-2 font-medium hover:bg-red-700 transition-colors" id="loginFromProfile" type="button">
              Login
            </button>
          </div>
        `;

        document.getElementById("loginFromProfile").addEventListener("click", () => {
          loginModal.classList.remove("hidden");
          loginModal.focus();
        });

        return;
      }

      profileContent.innerHTML = `
        <header aria-label="User profile header" class="profile-header flex items-center bg-white rounded-xl shadow-sm p-4 mb-4" tabindex="0">
          <div aria-hidden="true" class="profile-pic w-16 h-16 rounded-full bg-primary-light text-primary-color flex items-center justify-center text-3xl font-bold mr-4 select-none">
            ${user.name.charAt(0)}
          </div>
          <div class="profile-info">
            <h2 class="text-xl font-semibold">${user.name}</h2>
            <p class="text-gray-600">${user.phone}</p>
          </div>
        </header>

        <section aria-label="User profile details" class="profile-details bg-white rounded-xl shadow-sm p-4 mb-4">
          <h3 class="text-lg font-semibold text-dark-color mb-3">Personal Information</h3>
          <div class="detail-row flex justify-between border-b border-gray-200 py-3">
            <span class="detail-label font-medium text-gray-600">Email</span>
            <span class="detail-value text-gray-800">${user.email || "N/A"}</span>
          </div>
          <div class="detail-row flex justify-between border-b border-gray-200 py-3">
            <span class="detail-label font-medium text-gray-600">Phone</span>
            <span class="detail-value text-gray-800">${user.phone}</span>
          </div>
          <div class="detail-row flex justify-between border-b border-gray-200 py-3">
            <span class="detail-label font-medium text-gray-600">Address</span>
            <span class="detail-value text-gray-800">${user.address || "N/A"}</span>
          </div>
          <div class="detail-row flex justify-between border-b border-gray-200 py-3">
            <span class="detail-label font-medium text-gray-600">Member Since</span>
            <span class="detail-value text-gray-800">${user.joinedOn}</span>
          </div>
          <div class="detail-row flex justify-between py-3">
            <span class="detail-label font-medium text-gray-600">Total Orders</span>
            <span class="detail-value text-gray-800">${orders.length}</span>
          </div>
        </section>

        <section class="profile-actions bg-white rounded-xl shadow-sm p-4">
          <button class="w-full text-left py-3 border-b border-gray-200 flex items-center justify-between text-gray-700 hover:text-primary-color transition-colors" type="button">
            <span>My Wishlist</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </button>
          <button class="w-full text-left py-3 border-b border-gray-200 flex items-center justify-between text-gray-700 hover:text-primary-color transition-colors" type="button">
            <span>Saved Addresses</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </button>
          <button class="w-full text-left py-3 border-b border-gray-200 flex items-center justify-between text-gray-700 hover:text-primary-color transition-colors" type="button">
            <span>Payment Methods</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </button>
          <button class="w-full text-left py-3 flex items-center justify-between text-gray-700 hover:text-primary-color transition-colors" type="button">
            <span>Help & Support</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </button>
        </section>
      `;
    }

    // Toggle loading spinner on buttons
    function toggleLoading(button, show, text = "") {
      const spinner = button.querySelector(".spinner");
      const textElement = button.querySelector("span");

      if (show) {
        spinner.classList.remove("hidden");
        if (textElement) textElement.textContent = text || "Processing...";
        button.disabled = true;
      } else {
        spinner.classList.add("hidden");
        if (textElement) textElement.textContent = text || button.dataset.originalText;
        button.disabled = false;
      }
    }

    // Detect user's location (reuse from original code)
    function detectLocation() {
      if (!navigator.geolocation) {
        showToast("Geolocation is not supported by your browser", "error");
        return;
      }

      detectLocationBtn.disabled = true;
      detectLocationBtn.innerHTML = `
        <div class="spinner mr-2"></div>
        <span>Detecting...</span>
      `;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latlng = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          const geocoder = new google.maps.Geocoder();

          geocoder.geocode({ location: latlng }, (results, status) => {
            detectLocationBtn.disabled = false;
            detectLocationBtn.innerHTML = `
              <i class="fas fa-location-arrow"></i>
              <span>Detect My Location</span>
            `;

            if (status === "OK" && results[0]) {
              currentLocation = results[0].formatted_address;
              locationText.textContent = currentLocation;
              locationModal.classList.add("hidden");

              if (user) {
                user.address = currentLocation;
              }

              showToast(`Location set to ${currentLocation}`, "success");
            } else {
              showToast("Unable to detect location", "error");
            }
          });
        },
        (error) => {
          detectLocationBtn.disabled = false;
          detectLocationBtn.innerHTML = `
            <i class="fas fa-location-arrow"></i>
            <span>Detect My Location</span>
          `;

          if (error.code === error.PERMISSION_DENIED) {
            showToast(
              "Location permission denied. Please enable it in your browser settings.",
              "error"
            );
          } else {
            showToast("Unable to get your location", "error");
          }
        }
      );
    }

    // Initialize Google Maps autocomplete
    function initAutocomplete() {
      const autocomplete = new google.maps.places.Autocomplete(locationInput, {
        types: ["geocode"],
        componentRestrictions: { country: "np" },
      });

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          return;
        }

        currentLocation = place.formatted_address;
        locationText.textContent = currentLocation;
        locationModal.classList.add("hidden");

        if (user) {
          user.address = currentLocation;
        }

        showToast(`Location set to ${currentLocation}`, "success");
      });
    }

    // Initialize the app when DOM is loaded
    document.addEventListener("DOMContentLoaded", init);
















// Enhanced Categories Section with Product Filtering
function enhanceCategoriesSection() {
  const categoriesContainer = document.querySelector('#categoriesContent .grid');
  categoriesContainer.innerHTML = '';

  categories.forEach(category => {
    const categoryCard = document.createElement('div');
    categoryCard.className = 'category-card bg-white rounded-xl shadow-sm p-4 cursor-pointer hover:shadow-md transition';
    categoryCard.innerHTML = `
      <div class="flex items-center mb-3" data-category-id="${category.id}">
        <div class="w-12 h-12 ${category.color} rounded-full flex items-center justify-center mr-3">
          <i class="${category.icon} text-xl"></i>
        </div>
        <h3 class="text-lg font-semibold">${category.name}</h3>
      </div>
      <div class="subcategories flex flex-wrap gap-2">
        ${category.subcategories.map(sub => `
          <span class="subcategory bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full hover:bg-primary-light" 
                data-subcategory="${sub.toLowerCase()}">
            ${sub}
          </span>
        `).join('')}
      </div>
      <div class="category-products mt-4 grid grid-cols-2 gap-3 hidden" id="products-${category.id}">
        <!-- Products will be loaded here when category is clicked -->
      </div>
    `;

    // Click handler for main category
    categoryCard.querySelector('[data-category-id]').addEventListener('click', (e) => {
      const categoryId = e.currentTarget.dataset.categoryId;
      const productsContainer = categoryCard.querySelector(`#products-${categoryId}`);
      
      // Toggle visibility
      const isHidden = productsContainer.classList.contains('hidden');
      document.querySelectorAll('.category-products').forEach(el => el.classList.add('hidden'));
      
      if (isHidden) {
        productsContainer.classList.remove('hidden');
        loadCategoryProducts(categoryId, productsContainer);
      }
    });

    // Click handler for subcategories
    categoryCard.querySelectorAll('.subcategory').forEach(sub => {
      sub.addEventListener('click', (e) => {
        e.stopPropagation();
        const subcategory = e.currentTarget.dataset.subcategory;
        const categoryId = category.id;
        const productsContainer = categoryCard.querySelector(`#products-${categoryId}`);
        
        productsContainer.classList.remove('hidden');
        filterProductsBySubcategory(categoryId, subcategory, productsContainer);
      });
    });

    categoriesContainer.appendChild(categoryCard);
  });
}

function loadCategoryProducts(categoryId, container) {
  const products = allProducts.filter(p => p.category === categoryId).slice(0, 4);
  
  if (products.length === 0) {
    container.innerHTML = `
      <div class="col-span-2 text-center py-4 text-gray-500">
        No products found in this category
      </div>
    `;
    return;
  }

  container.innerHTML = products.map(product => `
    <div class="product-item bg-gray-50 rounded-lg p-2" data-product-id="${product.id}">
      <img src="${product.img}" alt="${product.name}" class="w-full h-24 object-contain mb-2">
      <h4 class="text-sm font-medium line-clamp-1">${product.name}</h4>
      <p class="text-primary-color text-sm font-bold">${formatPrice(product.price)}</p>
    </div>
  `).join('');

  // Add click handlers to products
  container.querySelectorAll('.product-item').forEach(item => {
    item.addEventListener('click', () => {
      viewProductDetail(item.dataset.productId);
    });
  });
}

function filterProductsBySubcategory(categoryId, subcategory, container) {
  const products = allProducts.filter(p => 
    p.category === categoryId && 
    (p.name.toLowerCase().includes(subcategory) || 
     p.features.some(f => f.toLowerCase().includes(subcategory)))
  ).slice(0, 4);

  container.innerHTML = products.length ? products.map(product => `
    <div class="product-item bg-gray-50 rounded-lg p-2" data-product-id="${product.id}">
      <img src="${product.img}" alt="${product.name}" class="w-full h-24 object-contain mb-2">
      <h4 class="text-sm font-medium line-clamp-1">${product.name}</h4>
      <p class="text-primary-color text-sm font-bold">${formatPrice(product.price)}</p>
    </div>
  `).join('') : `
    <div class="col-span-2 text-center py-4 text-gray-500">
      No products found in this subcategory
    </div>
  `;

  container.querySelectorAll('.product-item').forEach(item => {
    item.addEventListener('click', () => {
      viewProductDetail(item.dataset.productId);
    });
  });
}


  // Related products (same category, excluding current)
  const relatedProducts = allProducts.filter(p => 
    p.category === product.category && p.id !== product.id
  ).slice(0, 6);

  productDetailContent.innerHTML = `
    <div class="product-images mb-4">
      <div class="main-image bg-gray-100 rounded-lg overflow-hidden mb-2">
        <img src="${product.img}" alt="${product.name}" class="w-full h-64 object-contain" loading="lazy">
      </div>
    </div>

    <div class="product-info mb-6">
      <h1 class="text-xl font-bold text-dark-color mb-2">${product.name}</h1>
      <div class="flex items-center mb-3">
        <div class="rating-stars text-sm mr-2">${starsHtml}</div>
        <span class="text-sm text-gray-500 mr-3">${product.rating} (${product.reviews} reviews)</span>
        <span class="text-sm text-success-color">
          <i class="fas fa-check-circle mr-1"></i> ${product.inStock ? 'In Stock' : 'Out of Stock'}
        </span>
      </div>

      <div class="price-section bg-gray-50 p-3 rounded-lg mb-4">
        ${product.originalPrice ? `
          <div class="text-xs text-gray-500 line-through mb-1">${formatPrice(product.originalPrice)}</div>
        ` : ''}
        <div class="flex items-center">
          <div class="text-2xl font-bold text-primary-color mr-3">${formatPrice(product.price)}</div>
          ${product.discount ? `
            <span class="bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
              Save ${product.discount}%
            </span>
          ` : ''}
        </div>
        ${product.delivery.includes('Free') ? `
          <div class="text-sm text-success-color mt-2">
            <i class="fas fa-truck mr-1"></i> ${product.delivery}
          </div>
        ` : `
          <div class="text-sm text-gray-600 mt-2">
            <i class="fas fa-truck mr-1"></i> ${product.delivery}
          </div>
        `}
      </div>

      <div class="product-actions flex gap-3 mb-6">
        <button class="add-to-cart flex-1 bg-light-color text-dark-color rounded-lg py-3 text-sm font-medium hover:bg-accent-color hover:text-white transition-colors focus:outline-none">
          <i class="fas fa-cart-plus mr-2"></i> Add to Cart
        </button>
        <button class="buy-now flex-1 bg-primary-color text-white rounded-lg py-3 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none">
          Buy Now
        </button>
      </div>
    </div>

    <div class="product-details mb-6">
      <h2 class="text-lg font-bold text-dark-color mb-3">Product Details</h2>
      <p class="text-gray-700 mb-4">${product.description}</p>

      <h3 class="text-md font-semibold text-dark-color mb-2">Features</h3>
      <ul class="features-list space-y-2 mb-4">
        ${product.features.map(f => `
          <li class="flex items-start">
            <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
            <span>${f}</span>
          </li>
        `).join('')}
      </ul>
    </div>

    <div class="reviews-section">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold text-dark-color">Customer Reviews</h2>
        <button class="view-all-reviews text-primary-color text-sm font-medium hover:underline focus:outline-none">
          View All Reviews
        </button>
      </div>
      
      <div class="review-list space-y-4">
        ${reviews.slice(0, 2).map(review => `
          <div class="review bg-gray-50 p-3 rounded-lg">
            <div class="flex items-center mb-2">
              <div class="w-10 h-10 rounded-full bg-gray-300 mr-3 overflow-hidden">
                <img src="${review.photo}" alt="${review.name}" class="w-full h-full object-cover">
              </div>
              <div>
                <div class="text-sm font-medium">${review.name}</div>
                <div class="rating-stars text-xs">
                  ${'<i class="fas fa-star"></i>'.repeat(Math.floor(review.rating))}
                  ${review.rating % 1 >= 0.5 ? '<i class="fas fa-star-half-alt"></i>' : ''}
                  ${'<i class="far fa-star"></i>'.repeat(5 - Math.ceil(review.rating))}
                </div>
              </div>
            </div>
            <p class="text-sm text-gray-700">${review.text}</p>
            <div class="text-xs text-gray-500 mt-1">Reviewed on ${review.date}</div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="related-products mt-8">
      <h3 class="text-lg font-semibold mb-3">Related Products</h3>
      <div class="related-products-slider flex overflow-x-auto gap-4 pb-4 scroll-smooth" tabindex="0">
        ${relatedProducts.map(p => `
          <div class="related-product flex-shrink-0 w-40" data-product-id="${p.id}">
            <div class="product-card bg-white rounded-xl shadow-sm p-3">
              <img src="${p.img}" alt="${p.name}" class="w-full h-32 object-contain mb-2">
              <h4 class="text-sm line-clamp-2">${p.name}</h4>
              <p class="text-primary-color font-bold text-sm">${formatPrice(p.price)}</p>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  // Add event listeners
  productDetailContent.querySelector('.add-to-cart').addEventListener('click', () => {
    addToCart(product.id);
  });

  productDetailContent.querySelector('.buy-now').addEventListener('click', () => {
    buyNow(product.id);
  });

  productDetailContent.querySelector('.view-all-reviews').addEventListener('click', () => {
    showAllReviews(product, reviews);
  });

  productDetailContent.querySelectorAll('.related-product').forEach(item => {
    item.addEventListener('click', () => {
      viewProductDetail(item.dataset.productId);
    });
  });

function showAllReviews(product, reviews) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl w-11/12 max-w-md max-h-[80vh] overflow-y-auto animate-scaleIn">
      <div class="sticky top-0 bg-white p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold">All Reviews for ${product.name}</h3>
        <button class="close-modal text-red-600 hover:text-red-800 text-2xl font-bold focus:outline-none">
          ×
        </button>
      </div>
      <div class="p-4">
        <div class="review-list space-y-4">
          ${reviews.map(review => `
            <div class="review bg-gray-50 p-3 rounded-lg">
              <div class="flex items-center mb-2">
                <div class="w-12 h-12 rounded-full bg-gray-300 mr-3 overflow-hidden">
                  <img src="${review.photo}" alt="${review.name}" class="w-full h-full object-cover">
                </div>
                <div>
                  <div class="font-medium">${review.name}</div>
                  <div class="rating-stars text-sm">
                    ${'<i class="fas fa-star"></i>'.repeat(Math.floor(review.rating))}
                    ${review.rating % 1 >= 0.5 ? '<i class="fas fa-star-half-alt"></i>' : ''}
                    ${'<i class="far fa-star"></i>'.repeat(5 - Math.ceil(review.rating))}
                  </div>
                </div>
              </div>
              <p class="text-gray-700">${review.text}</p>
              <div class="text-xs text-gray-500 mt-1">Reviewed on ${review.date}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector('.close-modal').addEventListener('click', () => {
    modal.remove();
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// Enhanced Notification System
function showToast(message, type = "success", options = {}) {
  const toastContainer = document.getElementById('toastContainer');
  const toast = document.createElement('div');

  let bgColor = "bg-green-500";
  let icon = "fas fa-check-circle";

  if (type === "error") {
    bgColor = "bg-red-500";
    icon = "fas fa-times-circle";
  } else if (type === "warning") {
    bgColor = "bg-yellow-500";
    icon = "fas fa-exclamation-circle";
  } else if (type === "info") {
    bgColor = "bg-blue-500";
    icon = "fas fa-info-circle";
  }

  toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-md shadow-lg flex items-center justify-between`;
  toast.innerHTML = `
    <div class="flex items-center">
      <i class="${icon} mr-2"></i>
      <span>${message}</span>
    </div>
    <button class="close-toast ml-4 text-white hover:text-red-200 focus:outline-none">
      <i class="fas fa-times"></i>
    </button>
  `;

  if (options.orderId) {
    toast.dataset.orderId = options.orderId;
    toast.classList.add('cursor-pointer');
    toast.addEventListener('click', () => {
      viewOrderDetails(options.orderId);
    });
  }

  toastContainer.appendChild(toast);

  setTimeout(() => {
    toast.classList.add("hide");
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 5000);

  toast.querySelector(".close-toast").addEventListener("click", () => {
    toast.classList.add("hide");
    setTimeout(() => {
      toast.remove();
    }, 300);
  });
}

// Order Details View
function viewOrderDetails(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl w-11/12 max-w-md max-h-[80vh] overflow-y-auto animate-scaleIn">
      <div class="sticky top-0 bg-white p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold">Order #${order.id}</h3>
        <button class="close-modal text-red-600 hover:text-red-800 text-2xl font-bold focus:outline-none">
          ×
        </button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <h4 class="font-medium text-gray-700 mb-1">Order Summary</h4>
          <p class="text-sm text-gray-500">Placed on ${order.date}</p>
          <p class="text-sm ${order.status === 'Delivered' ? 'text-green-500' : order.status === 'Cancelled' ? 'text-red-500' : 'text-blue-500'}">
            Status: ${order.status}
          </p>
        </div>

        <div class="mb-4">
          <h4 class="font-medium text-gray-700 mb-2">Products</h4>
          <div class="space-y-3">
            ${order.products.map(p => `
              <div class="flex items-start">
                <img src="${p.img}" alt="${p.name}" class="w-16 h-16 object-contain mr-3 border border-gray-200 rounded">
                <div>
                  <h5 class="text-sm font-medium">${p.name}</h5>
                  <p class="text-sm text-gray-600">${formatPrice(p.price)} × ${p.quantity}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="mb-4">
          <h4 class="font-medium text-gray-700 mb-2">Delivery Address</h4>
          <p class="text-sm text-gray-600">${user.address || 'No address specified'}</p>
        </div>

        <div class="border-t border-gray-200 pt-3">
          <div class="flex justify-between mb-1">
            <span class="text-gray-600">Subtotal:</span>
            <span>${formatPrice(order.subtotal)}</span>
          </div>
          <div class="flex justify-between mb-1">
            <span class="text-gray-600">Delivery:</span>
            <span>${order.deliveryCharge === 0 ? 'Free' : formatPrice(order.deliveryCharge)}</span>
          </div>
          <div class="flex justify-between mb-1">
            <span class="text-gray-600">Tax (13%):</span>
            <span>${formatPrice(order.tax)}</span>
          </div>
          <div class="flex justify-between font-bold text-lg mt-2">
            <span>Total:</span>
            <span>${formatPrice(order.total)}</span>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="font-medium text-gray-700 mb-2">Related Products</h4>
          <div class="flex overflow-x-auto gap-3 pb-2">
            ${allProducts.filter(p => 
              p.category === order.products[0].category && 
              !order.products.some(op => op.id === p.id)
            ).slice(0, 5).map(p => `
              <div class="flex-shrink-0 w-24" data-product-id="${p.id}">
                <div class="product-card bg-gray-50 rounded-lg p-2">
                  <img src="${p.img}" alt="${p.name}" class="w-full h-16 object-contain mb-1">
                  <p class="text-xs line-clamp-2">${p.name}</p>
                  <p class="text-primary-color text-xs font-bold">${formatPrice(p.price)}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector('.close-modal').addEventListener('click', () => {
    modal.remove();
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });

  // Add click handlers to related products
  modal.querySelectorAll('[data-product-id]').forEach(item => {
    item.addEventListener('click', (e) => {
      e.stopPropagation();
      modal.remove();
      viewProductDetail(item.dataset.productId);
    });
  });
}

// Initialize all enhancements
function initEnhancements() {
  enhanceCategoriesSection();
  setupProductCarousels();
  enhancePaymentModal();
  setupFilterSystem();
  
  // Show login success notification if just logged in
  if (window.location.search.includes('login=success')) {
    showToast('Login successful!', 'success');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}














// Update your existing init() function
function init() {
  // Combine all products for search
  allProducts = [
    ...featuredProducts,
    ...dealsProducts,
    ...foodsProducts,
    ...groceryProducts,
    ...servicesProducts,
  ];

  // Render initial products and categories
  renderProductsGrid(featuredProductsGrid, featuredProducts);
  renderProductsGrid(dealsProductsGrid, dealsProducts);
  renderProductsGrid(foodsProductsGrid, foodsProducts);
  renderProductsGrid(groceryProductsGrid, groceryProducts);
  renderProductsGrid(servicesProductsGrid, servicesProducts);
  updateRecentProducts();
  renderCategoriesSlider();

  // Initialize UI state
  updateCartDisplay();
  updateOrdersDisplay();
  updateProfileDisplay();
  updateUIAfterLogout();
  updateCartBadge();

  // Set up event listeners
  setupEventListeners();

  // Initialize Google Maps if available
  if (typeof google !== "undefined") {
    initAutocomplete();
  }

  // Initialize all enhancements
  initEnhancements();
}

// Enhanced product review functionality with animations and empty state
function renderProductDetail(product) {
  // Add to viewed products if not already there
  if (!viewedProducts.some((p) => p.id === product.id)) {
    viewedProducts.unshift(product);
    if (viewedProducts.length > 6) viewedProducts.pop();
    updateRecentProducts();
  }

  // Generate stars HTML
  const generateStars = (rating) => {
    let starsHtml = '';
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    
    for (let i = 0; i < 5; i++) {
      if (i < fullStars) {
        starsHtml += '<i class="fas fa-star text-yellow-400"></i>';
      } else if (i === fullStars && hasHalfStar) {
        starsHtml += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
      } else {
        starsHtml += '<i class="far fa-star text-yellow-400"></i>';
      }
    }
    return starsHtml;
  };

  // Load reviews from localStorage or use empty array
  let reviews = JSON.parse(localStorage.getItem(`product_${product.id}_reviews`)) || [];

  // Calculate average rating (use product rating if no reviews)
  const averageRating = reviews.length > 0 
  ? (reviews.reduce((acc, review) => acc + review.rating, 0) / reviews.length) 
  : product.rating;

const ratingCount = reviews.length;


  // Generate review HTML
  const generateReviewHTML = (review) => {
    const photosHTML = review.photos.length > 0 ? `
      <div class="review-photos flex gap-2 mt-3 overflow-x-auto pb-2">
        ${review.photos.map(photo => `
          <img src="${photo}" alt="Review photo" class="w-20 h-20 object-cover rounded-md cursor-pointer hover:opacity-80 transition" loading="lazy" />
        `).join('')}
      </div>
    ` : '';

    return `
      <div class="review bg-white rounded-xl shadow-sm p-4 mb-4 animate-fadeIn" data-review-id="${review.id}">
        <div class="flex items-start mb-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold mr-3">
            ${review.userInitial}
          </div>
          <div class="flex-1">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-sm font-medium">${review.userName}</h4>
                <div class="flex items-center mt-1">
                  <div class="rating-stars text-xs mr-2">
                    ${generateStars(review.rating)}
                  </div>
                  <span class="text-xs text-gray-500">${review.date}</span>
                </div>
              </div>
              <button class="like-btn text-gray-400 hover:text-red-500 focus:outline-none transition-colors ${review.isLiked ? 'text-red-500' : ''}" 
                      aria-label="${review.isLiked ? 'Unlike' : 'Like'} this review">
                <i class="fas fa-heart mr-1"></i>
                <span class="text-xs">${review.likes}</span>
              </button>
            </div>
          </div>
        </div>
        
        <div class="review-text text-sm text-gray-700 mb-2">
          ${review.text}
        </div>
        
        ${photosHTML}
        
        <div class="review-reply bg-gray-50 rounded-lg p-3 mt-3">
          <div class="flex items-start">
            <div class="w-8 h-8 rounded-full bg-primary-color text-white flex items-center justify-center text-xs font-bold mr-2">
              NM
            </div>
            <div>
              <div class="text-xs font-medium text-primary-color mb-1">Nepal Mart</div>
              <p class="text-xs text-gray-700">${review.reply.text}</p>
              <div class="text-xs text-gray-500 mt-1">${review.reply.date}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  };

  // Generate reviews summary HTML with animated counters
  const reviewsSummaryHTML = `
    <div class="reviews-summary bg-white rounded-xl shadow-sm p-4 mb-4">
      <h3 class="text-lg font-bold text-dark-color mb-3">Customer Reviews</h3>
      
      <div class="flex flex-col md:flex-row items-start md:items-center mb-4">
        <div class="flex items-center mb-3 md:mb-0 md:mr-6">
          <div class="text-4xl font-bold text-primary-color mr-3 animate-count" data-target="${averageRating.toFixed(1)}">0.0</div>
          <div>
            <div class="rating-stars text-lg mb-1">
              ${generateStars(averageRating)}
            </div>
            <div class="text-sm text-gray-600"><span class="animate-count" data-target="${ratingCount}">0</span> reviews</div>
          </div>
        </div>
        
        <div class="w-full md:w-auto flex-1">
          ${[5, 4, 3, 2, 1].map(star => {
            const count = reviews.filter(r => Math.floor(r.rating) === star).length;
            const percentage = reviews.length > 0 ? (count / reviews.length) * 100 : 0;
            return `
              <div class="flex items-center mb-2">
                <div class="text-sm font-medium w-8">${star} star</div>
                <div class="flex-1 mx-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-yellow-400 transition-all duration-1000" style="width: ${percentage}%"></div>
                </div>
                <div class="text-xs text-gray-600 w-8 text-right animate-count" data-target="${count}">0</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <button id="writeReviewBtn" class="w-full bg-primary-color text-white rounded-lg py-2 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none flex items-center justify-center">
        <i class="fas fa-pen mr-2"></i> ${reviews.length > 0 ? 'Write a Review' : 'Be the First to Review'}
      </button>
    </div>
  `;

  // Generate reviews list HTML - show empty state if no reviews
  let reviewsListHTML = '';
  
  if (reviews.length === 0) {
    reviewsListHTML = `
      <div class="empty-reviews bg-white rounded-xl shadow-sm p-8 text-center mb-4 animate-pulse">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-comment-alt text-gray-400 text-2xl"></i>
        </div>
        <h4 class="text-lg font-medium text-gray-700 mb-2">No Reviews Yet</h4>
        <p class="text-sm text-gray-500 mb-4">Be the first to share your thoughts about this product!</p>
        <button id="writeFirstReviewBtn" class="bg-primary-color text-white rounded-lg py-2 px-6 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none">
          Write First Review
        </button>
      </div>
    `;
  } else {
    // Show only 3 initially if there are more
    const visibleReviews = reviews.slice(0, 3);
    const hiddenReviews = reviews.slice(3);
    
    reviewsListHTML = visibleReviews.map(review => generateReviewHTML(review)).join('');
    
    if (hiddenReviews.length > 0) {
      reviewsListHTML += `
        <div id="hiddenReviews" class="hidden">
          ${hiddenReviews.map(review => generateReviewHTML(review)).join('')}
        </div>
        <button id="showMoreReviewsBtn" class="w-full mt-2 text-primary-color text-sm font-medium hover:underline focus:outline-none flex items-center justify-center">
          <i class="fas fa-chevron-down mr-1"></i> Show ${hiddenReviews.length} more reviews
        </button>
      `;
    }
  }

  // Related products (same category, excluding current)
  const relatedProducts = [
    ...featuredProducts,
    ...dealsProducts,
    ...foodsProducts,
    ...groceryProducts,
    ...servicesProducts,
  ].filter((p) => p.category === product.category && p.id !== product.id);

  productDetailContent.innerHTML = `
    <div class="product-images mb-4">
      <div class="main-image bg-gray-100 rounded-lg overflow-hidden mb-2">
        <img src="${product.img}" alt="${product.name}" class="w-full h-64 object-contain" loading="lazy" />
      </div>
      <div class="thumbnail-images flex gap-2 overflow-x-auto pb-2">
        <div class="thumbnail w-16 h-16 bg-gray-100 rounded border-2 border-primary-color flex-shrink-0">
          <img src="${product.img}" alt="${product.name}" class="w-full h-full object-contain" loading="lazy" />
        </div>
        <div class="thumbnail w-16 h-16 bg-gray-100 rounded border border-gray-200 flex-shrink-0">
          <img src="https://placehold.co/100x100/png?text=Product+Angle" alt="${product.name} alternate view" class="w-full h-full object-contain" loading="lazy" />
        </div>
        <div class="thumbnail w-16 h-16 bg-gray-100 rounded border border-gray-200 flex-shrink-0">
          <img src="https://placehold.co/100x100/png?text=Product+Close" alt="${product.name} close up" class="w-full h-full object-contain" loading="lazy" />
        </div>
      </div>
    </div>

    <div class="product-info mb-6">
      <h1 class="text-xl font-bold text-dark-color mb-2">${product.name}</h1>
      <div class="flex items-center mb-3">
        <div class="rating-stars text-sm mr-2">
          ${generateStars(product.rating)}
        </div>
        <span class="text-sm text-gray-500 mr-3">${product.rating} (${product.reviews} reviews)</span>
        <span class="text-sm text-success-color">
          <i class="fas fa-check-circle mr-1"></i> ${product.inStock ? "In Stock" : "Out of Stock"}
        </span>
      </div>

      <div class="price-section bg-gray-50 p-3 rounded-lg mb-4">
        ${product.originalPrice ? `
          <div class="text-xs text-gray-500 line-through mb-1">${formatPrice(product.originalPrice)}</div>
        ` : ''}
        <div class="flex items-center">
          <div class="text-2xl font-bold text-primary-color mr-3">${formatPrice(product.price)}</div>
          ${product.discount ? `
            <span class="bg-primary-color text-white text-xs font-bold px-2 py-1 rounded">
              Save ${product.discount}%
            </span>
          ` : ''}
        </div>
        ${product.delivery.includes("Free") ? `
          <div class="text-sm text-success-color mt-2">
            <i class="fas fa-truck mr-1"></i> ${product.delivery}
          </div>
        ` : `
          <div class="text-sm text-gray-600 mt-2">
            <i class="fas fa-truck mr-1"></i> ${product.delivery}
          </div>
        `}
      </div>

      <div class="seller-info flex items-center mb-4 p-3 bg-gray-50 rounded-lg">
        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
          <i class="fas fa-store text-gray-500"></i>
        </div>
        <div>
          <div class="text-sm font-medium">Sold by ${product.seller}</div>
          <div class="text-xs text-gray-500">${product.lastBought}</div>
        </div>
      </div>

      <div class="product-actions flex gap-3 mb-6">
        <button class="add-to-cart flex-1 bg-light-color text-dark-color rounded-lg py-3 text-sm font-medium hover:bg-accent-color hover:text-white transition-colors focus:outline-none">
          <i class="fas fa-cart-plus mr-2"></i> Add to Cart
        </button>
        <button class="buy-now flex-1 bg-primary-color text-white rounded-lg py-3 text-sm font-medium hover:bg-red-700 transition-colors focus:outline-none">
          Buy Now
        </button>
      </div>
    </div>

    <div class="product-details mb-6">
      <h2 class="text-lg font-bold text-dark-color mb-3">Product Details</h2>
      <p class="text-gray-700 mb-4">${product.description}</p>

      <h3 class="text-md font-semibold text-dark-color mb-2">Features</h3>
      <ul class="features-list space-y-2 mb-4">
        ${product.features.map(feature => `
          <li class="flex items-start">
            <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
            <span>${feature}</span>
          </li>
        `).join('')}
      </ul>
    </div>

    ${reviewsSummaryHTML}
    ${reviewsListHTML}

    <div class="related-products mt-8">
      <h3 class="text-lg font-semibold mb-3">Related Products</h3>
      <div class="related-products-slider" tabindex="0" aria-label="Related products slider">
        ${relatedProducts.map(p => `
          <div class="related-product-card" role="button" tabindex="0" aria-label="View details of ${p.name}" data-product-id="${p.id}">
            <img src="${p.img}" alt="${p.name}" loading="lazy" />
            <div class="text-xs font-medium text-center">${p.name}</div>
            <div class="text-xs text-primary-color font-semibold">${formatPrice(p.price)}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  // Animate the counters
  const animateCounters = () => {
    const counters = productDetailContent.querySelectorAll('.animate-count');
    const speed = 200;
    
    counters.forEach(counter => {
      const target = +counter.getAttribute('data-target');
      const count = +counter.innerText;
      const increment = target / speed;
      
      if (count < target) {
        counter.innerText = Math.ceil(count + increment);
        setTimeout(animateCounters, 1);
      } else {
        counter.innerText = target;
      }
    });
  };
  
  setTimeout(animateCounters, 500);

  // Add event listeners for add to cart and buy now buttons
  productDetailContent.querySelector(".add-to-cart").addEventListener("click", () => {
    addToCart(product.id);
  });

  productDetailContent.querySelector(".buy-now").addEventListener("click", () => {
    buyNow(product.id);
  });

  // Add event listeners for related products
  productDetailContent.querySelectorAll(".related-product-card").forEach((card) => {
    card.addEventListener("click", () => {
      const pid = card.dataset.productId;
      viewProductDetail(pid);
    });
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const pid = card.dataset.productId;
        viewProductDetail(pid);
      }
    });
  });

  // Add event listeners for review functionality
  const writeReviewBtn = productDetailContent.querySelector("#writeReviewBtn");
  if (writeReviewBtn) {
    writeReviewBtn.addEventListener("click", () => {
      if (!isLoggedIn) {
        showToast("Please login to write a review", "warning");
        loginModal.classList.remove("hidden");
        loginModal.focus();
        return;
      }
      showReviewModal(product);
    });
  }

  // Add listener for "Write First Review" button
  const writeFirstReviewBtn = productDetailContent.querySelector("#writeFirstReviewBtn");
  if (writeFirstReviewBtn) {
    writeFirstReviewBtn.addEventListener("click", () => {
      if (!isLoggedIn) {
        showToast("Please login to write a review", "warning");
        loginModal.classList.remove("hidden");
        loginModal.focus();
        return;
      }
      showReviewModal(product);
    });
  }

  const showMoreReviewsBtn = productDetailContent.querySelector("#showMoreReviewsBtn");
  if (showMoreReviewsBtn) {
    showMoreReviewsBtn.addEventListener("click", () => {
      const hiddenReviewsDiv = productDetailContent.querySelector("#hiddenReviews");
      hiddenReviewsDiv.classList.remove("hidden");
      showMoreReviewsBtn.classList.add("hidden");
      
      // Animate the appearance of new reviews
      const newReviews = hiddenReviewsDiv.querySelectorAll('.review');
      newReviews.forEach((review, index) => {
        setTimeout(() => {
          review.classList.add('animate-fadeIn');
        }, index * 100);
      });
    });
  }

  // Add event listeners for like buttons
  productDetailContent.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      if (!isLoggedIn) {
        showToast("Please login to like reviews", "warning");
        loginModal.classList.remove("hidden");
        loginModal.focus();
        return;
      }
      
      const reviewDiv = e.target.closest(".review");
      const reviewId = reviewDiv.dataset.reviewId;
      
      // Get reviews from localStorage
      let productReviews = JSON.parse(localStorage.getItem(`product_${product.id}_reviews`)) || [];
      const review = productReviews.find(r => r.id === reviewId);
      
      if (review) {
        review.isLiked = !review.isLiked;
        review.likes += review.isLiked ? 1 : -1;
        
        // Save back to localStorage
        localStorage.setItem(`product_${product.id}_reviews`, JSON.stringify(productReviews));
        
        // Update the button appearance
        if (review.isLiked) {
          btn.classList.add("text-red-500");
          btn.classList.remove("text-gray-400");
          btn.setAttribute("aria-label", "Unlike this review");
          
          // Add heart animation
          const heartIcon = btn.querySelector("i");
          heartIcon.classList.add("animate-pulse");
          setTimeout(() => {
            heartIcon.classList.remove("animate-pulse");
          }, 300);
        } else {
          btn.classList.remove("text-red-500");
          btn.classList.add("text-gray-400");
          btn.setAttribute("aria-label", "Like this review");
        }
        
        // Update the like count
        btn.querySelector("span").textContent = review.likes;
        
        showToast(review.isLiked ? "Review liked!" : "Review unliked", "success");
      }
    });
  });

  // Add event listeners for review photo clicks
  productDetailContent.querySelectorAll(".review-photos img").forEach(img => {
    img.addEventListener("click", (e) => {
      const photoUrl = e.target.src;
      showPhotoModal(photoUrl);
    });
  });
}

// Show review modal with enhanced UI
function showReviewModal(product) {
  const reviewModal = document.createElement("div");
  reviewModal.className = "modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50";
  reviewModal.innerHTML = `
    <div class="modal-content bg-white rounded-xl w-11/12 max-w-md overflow-hidden animate-scaleIn" role="document" tabindex="0">
      <header class="modal-header bg-primary-color text-white flex justify-between items-center p-4">
        <h3 class="text-lg font-semibold">Write a Review</h3>
        <button aria-label="Close review modal" class="close-modal text-white text-2xl font-bold focus:outline-none" type="button">
          ×
        </button>
      </header>
      <div class="modal-body p-4">
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Rate this product</h4>
          <div class="rating-stars flex text-2xl gap-1">
            <button class="star-btn" data-rating="1" aria-label="Rate 1 star"><i class="far fa-star"></i></button>
            <button class="star-btn" data-rating="2" aria-label="Rate 2 stars"><i class="far fa-star"></i></button>
            <button class="star-btn" data-rating="3" aria-label="Rate 3 stars"><i class="far fa-star"></i></button>
            <button class="star-btn" data-rating="4" aria-label="Rate 4 stars"><i class="far fa-star"></i></button>
            <button class="star-btn" data-rating="5" aria-label="Rate 5 stars"><i class="far fa-star"></i></button>
          </div>
          <input type="hidden" id="reviewRating" value="0">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="reviewText">Your Review</label>
          <textarea id="reviewText" class="w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-primary-color" rows="4" placeholder="Share your experience with this product..."></textarea>
          <div class="text-xs text-gray-500 mt-1">Minimum 20 characters</div>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Upload Photos (Optional)</label>
          <div class="flex items-center">
            <label for="reviewPhotos" class="cursor-pointer bg-gray-100 hover:bg-gray-200 rounded-lg p-3 text-center transition-colors w-24 h-24 flex flex-col items-center justify-center">
              <i class="fas fa-camera text-xl text-gray-600 mb-1"></i>
              <div class="text-xs text-gray-600">Add Photos</div>
              <input type="file" id="reviewPhotos" class="hidden" accept="image/*" multiple>
            </label>
            <div id="photoPreviews" class="flex ml-2 overflow-x-auto gap-2"></div>
          </div>
          <div class="text-xs text-gray-500 mt-1">Maximum 4 photos (2MB each)</div>
        </div>
        
        <button id="submitReviewBtn" class="w-full bg-primary-color text-white rounded-md py-3 text-lg font-semibold hover:bg-red-700 transition-colors focus:outline-none">
          Submit Review
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(reviewModal);
  reviewModal.focus();

  // Close modal
  reviewModal.querySelector(".close-modal").addEventListener("click", () => {
    reviewModal.remove();
  });

  // Close on outside click
  reviewModal.addEventListener("click", (e) => {
    if (e.target === reviewModal) {
      reviewModal.remove();
    }
  });

  // Star rating functionality
  let selectedRating = 0;
  const starButtons = reviewModal.querySelectorAll(".star-btn");
  
  starButtons.forEach(button => {
    button.addEventListener("click", () => {
      const rating = parseInt(button.dataset.rating);
      selectedRating = rating;
      reviewModal.querySelector("#reviewRating").value = rating;
      
      // Update stars display
      starButtons.forEach((star, index) => {
        const icon = star.querySelector("i");
        if (index < rating) {
          icon.classList.remove("far");
          icon.classList.add("fas");
          // Add animation to filled stars
          icon.classList.add("animate-bounce");
          setTimeout(() => {
            icon.classList.remove("animate-bounce");
          }, 300);
        } else {
          icon.classList.remove("fas");
          icon.classList.add("far");
        }
      });
    });
  });

  // Photo upload preview
  const photoInput = reviewModal.querySelector("#reviewPhotos");
  const photoPreviews = reviewModal.querySelector("#photoPreviews");
  
  photoInput.addEventListener("change", (e) => {
    photoPreviews.innerHTML = "";
    
    if (e.target.files.length > 4) {
      showToast("You can upload up to 4 photos", "warning");
      return;
    }
    
    Array.from(e.target.files).forEach(file => {
      if (!file.type.match("image.*")) {
        showToast("Only image files are allowed", "error");
        return;
      }
      
      if (file.size > 2 * 1024 * 1024) {
        showToast("Image must be less than 2MB", "error");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const previewDiv = document.createElement("div");
        previewDiv.className = "relative flex-shrink-0 animate-fadeIn";
        previewDiv.innerHTML = `
          <img src="${event.target.result}" class="w-24 h-24 object-cover rounded-md" loading="lazy" />
          <button class="remove-photo absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
            ×
          </button>
        `;
        photoPreviews.appendChild(previewDiv);
        
        // Add remove button functionality
        previewDiv.querySelector(".remove-photo").addEventListener("click", () => {
          previewDiv.classList.add("animate-fadeOut");
          setTimeout(() => {
            previewDiv.remove();
          }, 300);
        });
      };
      reader.readAsDataURL(file);
    });
  });

  // Submit review with enhanced feedback
  reviewModal.querySelector("#submitReviewBtn").addEventListener("click", () => {
    const reviewText = reviewModal.querySelector("#reviewText").value.trim();
    
    if (selectedRating === 0) {
      showToast("Please select a rating", "error");
      
      // Shake stars to draw attention
      starButtons.forEach(star => {
        star.classList.add("animate-shake");
        setTimeout(() => {
          star.classList.remove("animate-shake");
        }, 500);
      });
      return;
    }
    
    if (!reviewText) {
      showToast("Please write your review", "error");
      reviewModal.querySelector("#reviewText").focus();
      return;
    }
    
    if (reviewText.length < 20) {
      showToast("Review should be at least 20 characters", "error");
      reviewModal.querySelector("#reviewText").focus();
      return;
    }
    
    // Simulate review submission
    const submitBtn = reviewModal.querySelector("#submitReviewBtn");
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <div class="spinner mr-2"></div>
      <span>Submitting...</span>
    `;
    
    // Create new review object
    const newReview = {
      id: "r" + (Math.floor(Math.random() * 10000) + 7),
      userId: "current-user",
      userName: user.name,
      userInitial: user.name.charAt(0),
      userImg: null,
      rating: selectedRating,
      text: reviewText,
      photos: Array.from(photoPreviews.querySelectorAll("img")).map(img => img.src),
      date: new Date().toLocaleDateString("en-GB", {
        day: "numeric",
        month: "short",
        year: "numeric"
      }),
      likes: 0,
      isLiked: false,
      reply: {
        text: `Thank you for your feedback ${user.name.split(" ")[0]}!`,
        date: new Date().toLocaleDateString("en-GB", {
          day: "numeric",
          month: "short",
          year: "numeric"
        })
      }
    };

    // Simulate API delay
    setTimeout(() => {
      // Save to localStorage (in a real app, this would be an API call)
      let productReviews = JSON.parse(localStorage.getItem(`product_${product.id}_reviews`)) || [];
      productReviews.unshift(newReview);
      localStorage.setItem(`product_${product.id}_reviews`, JSON.stringify(productReviews));
      
      // Show success animation
      const successAnimation = document.createElement("div");
      successAnimation.className = "fixed inset-0 flex items-center justify-center z-50 pointer-events-none";
      successAnimation.innerHTML = `
        <div class="success-content text-center animate-scaleIn">
          <div class="w-24 h-24 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
            <i class="fas fa-check text-4xl"></i>
          </div>
          <h4 class="text-2xl font-bold text-green-500 mb-2">Thank You!</h4>
          <p class="text-gray-700">Your review has been submitted</p>
        </div>
      `;
      document.body.appendChild(successAnimation);
      
      // Remove elements after animation
      setTimeout(() => {
        successAnimation.remove();
        reviewModal.remove();
        
        // Refresh the product detail with animation
        productDetailContent.classList.add("animate-fadeOut");
        setTimeout(() => {
          productDetailContent.classList.remove("animate-fadeOut");
          renderProductDetail(product);
          
          // Scroll to reviews section
          const reviewsSection = document.querySelector(".reviews-summary");
          if (reviewsSection) {
            reviewsSection.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }, 300);
      }, 2000);
    }, 1500);
  });
}

// Show photo modal
function showPhotoModal(photoUrl) {
  const photoModal = document.createElement("div");
  photoModal.className = "modal fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50";
  photoModal.innerHTML = `
    <div class="relative w-full h-full flex justify-center items-center">
      <button aria-label="Close photo modal" class="absolute top-4 right-4 text-white text-3xl font-bold focus:outline-none z-10 hover:opacity-80 transition-opacity" type="button">
        ×
      </button>
      <img src="${photoUrl}" class="max-w-full max-h-full object-contain animate-scaleIn" loading="lazy" />
    </div>
  `;

  document.body.appendChild(photoModal);
  photoModal.focus();

  // Close modal
  photoModal.querySelector("button").addEventListener("click", () => {
    photoModal.remove();
  });

  // Close on click anywhere
  photoModal.addEventListener("click", () => {
    photoModal.remove();
  });
}

// Add these CSS animations to your stylesheet:
/*
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes scaleIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-5px); }
  40%, 80% { transform: translateX(5px); }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out forwards;
}

.animate-fadeOut {
  animation: fadeOut 0.3s ease-out forwards;
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out forwards;
}

.animate-pulse {
  animation: pulse 2s infinite;
}

.animate-bounce {
  animation: bounce 0.5s;
}

.animate-shake {
  animation: shake 0.5s;
}

.spinner {
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top: 2px solid white;
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
  display: inline-block;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
*/ 



</script>
 </body>
</html>

